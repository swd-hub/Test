<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ°—è±¡çµŒé</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
/* è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
canvas {
  margin: 30px 0;
  max-width: 100%;
  height: auto;
}

#csvFileInput {
  display: none;
}

.file-label {
  display: inline-block;
  padding: 10px 20px;
  background-color: #eee;
  border: 1px solid #ccc;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  margin-top: 10px;
}

/* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
@media print {
  body {
    font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", sans-serif;
    font-size: 12pt;
    color: #000;
    background: #fff;
    margin: 20mm;
  }

  h1 {
    font-size: 18pt;
    margin-bottom: 10mm;
    text-align: center;
  }

  canvas {
    page-break-inside: avoid;
    margin-bottom: 20mm;
    max-width: 100%;
    height: auto;
  }

  #csvFileInput,
  .file-label,
  button {
    display: none !important;
  }

  footer::after {
    content: "ãƒšãƒ¼ã‚¸: " counter(page);
    position: fixed;
    bottom: 10mm;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 10pt;
    color: #666;
  }
}
  </style>
</head>
<body>
  <h1 id="mainTitle">æ°—è±¡çµŒé åœ°å</h1>

  <!-- ãƒ©ãƒ™ãƒ«ã‚’ãƒœã‚¿ãƒ³é¢¨ã«ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’èµ·å‹• -->
  <input type="file" id="csvFileInput" accept=".csv">

  <div id="csvDates"></div>

  <canvas id="annualTempChart" width="1000" height="400"></canvas>
  <canvas id="annualPrecChart" width="1000" height="400"></canvas>
  <canvas id="annualSunChart" width="1000" height="400"></canvas>

<script>
let csvData = [];

window.addEventListener('DOMContentLoaded', loadCSVWithFallback);

document.getElementById('csvFileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  // ãƒ•ã‚¡ã‚¤ãƒ«åã®å†’é ­ï¼ˆæ‹¡å¼µå­é™¤ãï¼‰ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
  const fileName = file.name.replace(/\.[^/.]+$/, ''); // æ‹¡å¼µå­é™¤å»
  const locationName = fileName.split(/æ—¥åˆ¥å€¤|_/)[0]; // ã€Œå‡ºé›²æ—¥åˆ¥å€¤.csvã€â†’ã€Œå‡ºé›²ã€
  document.getElementById('mainTitle').textContent = `æ°—è±¡çµŒé ${locationName}`;

  reader.onload = function(event) {
    const content = shiftJISToUTF8(event.target.result);
    csvData = parseCSV(content);
    handleAnnualGraphUpdate();
  };
  reader.readAsArrayBuffer(file);
});


function triggerFileInput() {
  document.getElementById('csvFileInput').click();
}

document.getElementById('csvFileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(event) {
    const content = shiftJISToUTF8(event.target.result);
    csvData = parseCSV(content);
    handleAnnualGraphUpdate();
  };
  reader.readAsArrayBuffer(file);
});

async function loadCSVWithFallback() {
  try {
    const filePath = 'å‡ºé›²æ—¥åˆ¥å€¤.csv'; // èª­ã¿è¾¼ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«å
    const response = await fetch(filePath);
    const arrayBuffer = await response.arrayBuffer();
    const utf8Content = shiftJISToUTF8(arrayBuffer);
    csvData = parseCSV(utf8Content);

    // ğŸ”½ åœ°åæŠ½å‡ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®å†’é ­2æ–‡å­—ï¼‰
    const locationName = filePath.replace(/\.[^/.]+$/, '').substring(0, 2);
    document.getElementById('mainTitle').textContent = `æ°—è±¡çµŒé ${locationName}`;

    handleAnnualGraphUpdate();
  } catch (error) {
    alert("CSVã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    document.getElementById('csvFileInput').style.display = 'inline';
  }
}



function shiftJISToUTF8(arrayBuffer) {
  const decoder = new TextDecoder('shift-jis');
  const uint8Array = new Uint8Array(arrayBuffer);
  return decoder.decode(uint8Array);
}

function parseCSV(content) {
  const lines = content.trim().split('\n').filter(line => line.trim() !== "");
  let lines1 = lines[2].split(',');
  let lines2 = lines[3].split(',');
  let lines3 = lines[4].split(',');
  let combinedHead = [];
  for (let i = 0; i < lines1.length; i++) {
    combinedHead.push(lines1[i].replace(/\r/g, '') + lines2[i].replace(/\r/g, '') + lines3[i].replace(/\r/g, ''));
  }

  const targetHeaders = ["å¹´", "æœˆ", "æ—¥", "å¹³å‡æ°—æ¸©(â„ƒ)", "é™æ°´é‡ã®åˆè¨ˆ(mm)", "æ—¥ç…§æ™‚é–“(æ™‚é–“)",
    "æœ€é«˜æ°—æ¸©(â„ƒ)", "æœ€ä½æ°—æ¸©(â„ƒ)"];
  let indicesToSelect = targetHeaders.map(header => combinedHead.findIndex(h => h.includes(header)));

  const dataLines = lines.slice(6).map(line => {
    const cols = line.split(',');
    const selectedCols = indicesToSelect.map(index => index >= 0 ? cols[index] || '0' : '0');
    return selectedCols.join(',');
  });

  dataLines.unshift(targetHeaders.join(','));
  return dataLines.slice(1).map(line => {
    const cols = line.split(",");
    return {
      date: new Date(Date.UTC(cols[0], cols[1] - 1, cols[2])),
      temperature: parseFloat(cols[3]) || 0,
      precipitation: parseFloat(cols[4]) || 0,
      sunshine: parseFloat(cols[5]) || 0,
      maxTemperature: parseFloat(cols[6]) || 0,
      minTemperature: parseFloat(cols[7]) || 0
    };
  });
}

function handleAnnualGraphUpdate() {
  const annualMap = {};
  csvData.forEach(d => {
    const year = d.date.getFullYear();
    if (!annualMap[year]) {
      annualMap[year] = {
        temperatureSum: 0, temperatureCount: 0,
        maxTempSum: 0, maxTempCount: 0,
        minTempSum: 0, minTempCount: 0,
        precipitationSum: 0,
        sunshineSum: 0,
        maxTemp: d.maxTemperature, // åˆæœŸå€¤ã¨ã—ã¦ãã®æ—¥ã®å€¤ã‚’è¨˜éŒ²
        minTemp: d.minTemperature  // åˆæœŸå€¤ã¨ã—ã¦ãã®æ—¥ã®å€¤ã‚’è¨˜éŒ²
      };
    } else {
      if (!isNaN(d.maxTemperature)) {
        annualMap[year].maxTempSum += d.maxTemperature;
        annualMap[year].maxTempCount++;
        annualMap[year].maxTemp = Math.max(annualMap[year].maxTemp, d.maxTemperature); // æœ€å¤§å€¤æ›´æ–°
      }
      if (!isNaN(d.minTemperature)) {
        annualMap[year].minTempSum += d.minTemperature;
        annualMap[year].minTempCount++;
        annualMap[year].minTemp = Math.min(annualMap[year].minTemp, d.minTemperature); // æœ€å°å€¤æ›´æ–°
      }
    }

    if (!isNaN(d.temperature)) {
      annualMap[year].temperatureSum += d.temperature;
      annualMap[year].temperatureCount++;
    }
    if (!isNaN(d.precipitation)) {
      annualMap[year].precipitationSum += d.precipitation;
    }
    if (!isNaN(d.sunshine)) {
      annualMap[year].sunshineSum += d.sunshine;
    }
  });

  const labels = Object.keys(annualMap).sort();
  const avgTemps = labels.map(y => annualMap[y].temperatureSum / annualMap[y].temperatureCount);
  const maxTemps = labels.map(y => annualMap[y].maxTemp); // å¹´é–“ã®æœ€é«˜æ°—æ¸©ï¼ˆ1æ—¥å€¤ï¼‰
  const minTemps = labels.map(y => annualMap[y].minTemp); // å¹´é–“ã®æœ€ä½æ°—æ¸©ï¼ˆ1æ—¥å€¤ï¼‰
  const precSums = labels.map(y => annualMap[y].precipitationSum);
  const sunSums = labels.map(y => annualMap[y].sunshineSum);

  drawAnnualCharts(labels, avgTemps, maxTemps, minTemps, precSums, sunSums);
}


function drawAnnualCharts(labels, avgTemps, maxTemps, minTemps, precSums, sunSums) {
  const createChart = (ctx, datasets, yLabel) => {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { font: { size: 20 } } }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'å¹´',
              font: { size: 20 }
            },
            ticks: {
              font: { size: 18 } // æ¨ªè»¸ã®ãƒ¡ãƒ¢ãƒªæ•°å€¤ã‚’å¤§ãã
            }
          },
          y: {
            title: {
              display: true,
              text: yLabel,
              font: { size: 20 }
            },
            ticks: {
              font: { size: 18 } // ç¸¦è»¸ã®ãƒ¡ãƒ¢ãƒªæ•°å€¤ã‚’å¤§ãã
            }
          }
        }
      }
    });
  };

  // å¹³å‡ãƒ»æœ€é«˜ãƒ»æœ€ä½æ°—æ¸©ã‚’ã¾ã¨ã‚ã¦æç”»
  createChart(document.getElementById('annualTempChart').getContext('2d'), [
    {
      label: 'å¹³å‡æ°—æ¸©(â„ƒ)',
      data: avgTemps,
      borderColor: 'orange',
      borderWidth: 3,
      fill: false
    },
    {
      label: 'æœ€é«˜æ°—æ¸©(â„ƒ)',
      data: maxTemps,
      borderColor: 'red',
      borderWidth: 3,
      fill: false
    },
    {
      label: 'æœ€ä½æ°—æ¸©(â„ƒ)',
      data: minTemps,
      borderColor: 'blue',
      borderWidth: 3,
      fill: false
    }
  ], 'â„ƒ');

  // é™æ°´é‡ã‚°ãƒ©ãƒ•
  createChart(document.getElementById('annualPrecChart').getContext('2d'), [
    {
      label: 'ç´¯ç©é™æ°´é‡(mm)',
      data: precSums,
      borderColor: 'blue',
      borderWidth: 3,
      fill: false
    }
  ], 'mm');

  // æ—¥ç…§æ™‚é–“ã‚°ãƒ©ãƒ•
  createChart(document.getElementById('annualSunChart').getContext('2d'), [
    {
      label: 'æ—¥ç…§æ™‚é–“ç©ç®—(æ™‚é–“)',
      data: sunSums,
      borderColor: 'goldenrod',
      borderWidth: 3,
      fill: false
    }
  ], 'æ™‚é–“');
}

</script>
</body>
</html>


