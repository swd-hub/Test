<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="description" content="æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã®æ—¥åˆ¥å€¤ã¨å¹³å¹´å€¤ã‚’ã‚°ãƒ©ãƒ•åŒ–ã™ã‚‹ã€‚">  
<meta name="author" content="æ¾¤ç”°æ³°äºº">
<meta name="date" content="2025å¹´5æœˆ4æ—¥">
<meta charset="UTF-8">
<title>æ°—è±¡çµŒé</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest"></script>
    <style>
/* å°åˆ·ç”¨ã®è¨­å®š */
@media print {
  * {
    margin: 0;
    padding: 0;
  }
  input,
  button,
  select,
  label,
  form,
  h5,
  h3 {
    display: none !important;
  }
}

/* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
button {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: right;
}

/* ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
form {
  flex: 1;
  margin: 20px;
  padding: 40px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  width: 200px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
h1 {
  background-color: #4CAF50;
  color: white;
  padding: 10px;
  text-align: center;
}

/* ãƒ©ãƒ™ãƒ«å†…ã® input ã¨ button ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ */
label {
  display: flex;
  align-items: center;
  gap: 8px; /* é–“ã«å°‘ã—ä½™ç™½ */
}

/* ãƒãƒ£ãƒ¼ãƒˆã®è¦ªè¦ç´  */
.chart-container {
  width: 100%;
  /* max-width: 400px;  å…ƒã®ã‚³ãƒ¼ãƒ‰ã«ã‚ã£ãŸãŒã€ã‚°ãƒ©ãƒ•ãŒå°ã•ããªã‚‹ãŸã‚å‰Šé™¤ã¾ãŸã¯èª¿æ•´ */
  margin: 0 auto;    /* ä¸­å¤®å¯„ã›ï¼ˆä»»æ„ï¼‰ */
}
/* ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆã‚°ãƒ©ãƒ•ï¼‰ */
canvas {
  width: 100% !important;
  height: auto !important;
}

/* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¦ç´ ã‚’ä¸¦ã¹ã‚‹ */
.container {
  display: flex;
  flex-wrap: wrap;       /* ãƒ¢ãƒã‚¤ãƒ«ã§æŠ˜ã‚Šè¿”ã™ */
  gap: 20px;
  justify-content: flex-start;  /* å·¦æƒãˆã«ã™ã‚‹ */
}

/* å³å¯„ã› */
.right-align {
  text-align: right;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒãƒ£ãƒ¼ãƒˆã®è¦ªè¦ç´  */
.table-container, .chart-container {
  flex: 1;
  min-width: 300px;      /* æŠ˜ã‚Šè¿”ã—æ¡ä»¶ã‚’èª¿æ•´ */
}

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
input[type="date"], input[type="number"] { /* fileInput ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä¸è¦ã«ãªã£ãŸã®ã§å‰Šé™¤ */
  width: 150px;
  padding: 8px 10px;
  font-size: 16px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
/* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.GraphupdateButton {
  background-color: #4CAF50;
  color: white;
  padding: 8px 12px;
  font-size: 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 4px; /* ä»»æ„ã§å·¦ã«ä½™ç™½ã‚’è¿½åŠ  */
}
/* #fileInput ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä¸è¦ã«ãªã£ãŸã®ã§å‰Šé™¤ */
#chartcanvas
{
  width: 80%;
  height: auto;
  padding: 10px;
  /* position: absolute; ã¨ right/left/height ã¯ãƒ•ãƒ­ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãŸã‚å‰Šé™¤ */
}
    </style>
</head>
<body>
 
    <h1 id="mainTitle">æ°—è±¡çµŒé</h1>

    <div class="right-align">
        <button onclick="window.open('https://www.data.jma.go.jp/gmd/risk/obsdl/index.php', '_blank')">æ°—è±¡åºã®ã‚µã‚¤ãƒˆã‚’é–‹ã</button>
    </div>
    <br>
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯fetchã«ç½®ãæ›ã‚ã£ãŸãŸã‚å‰Šé™¤ -->
    <!-- <h5>ãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠãƒœã‚¿ãƒ³ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§å–ã‚Šè¾¼ã¿å¯èƒ½</h5> -->
    <!-- <input type="file" id="fileInput" accept=".csv"> -->
    <div class="container">
        <form>
            <label for="cultivationStartDate">é–‹å§‹æ—¥:</label>
            <input type="date" id="cultivationStartDate">
            <label for="cultivationEndDate">çµ‚äº†æ—¥ï¼ˆæœ€çµ‚æ—¥ï¼‰:</label>
            <input type="date"  id="cultivationEndDate">
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»æ—¥ä»˜ã‚’æ›´æ–°ã—ãŸã‚ã¨ã«æŠ¼ã™ãƒœã‚¿ãƒ³ -->
            <button type="button" id="updateButton">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
        </form>
    </div>
<div id="chartcanvas" style="margin-top: 5em; display: none;">
<h3>æ™‚åˆ¥ãƒ‡ãƒ¼ã‚¿</h3>
<div style="margin-bottom: 3em;">
  <label>
    ç¸¦è»¸æœ€å¤§å€¤ï¼ˆæ™‚åˆ¥æ°—æ¸©ï¼‰:
    <input type="number" id="hourlyTempMax" value="30" step="5" placeholder="ä¾‹: 30">
  </label>
  <button type="button" class="GraphupdateButton">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
<canvas id="hourlyTempChart"></canvas>
</div>
<div style="margin-bottom: 3em;">
  <label>
    ç¸¦è»¸æœ€å¤§å€¤ï¼ˆæ™‚åˆ¥é™æ°´é‡ï¼‰:
    <input type="number" id="hourlyPrecMax" value="10" step="2" placeholder="ä¾‹: 10">
  </label>
    <button type="button" class="GraphupdateButton">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
<canvas id="hourlyPrecChart"></canvas>
</div>
<div style="margin-bottom: 3em;">
  <label>
    ç¸¦è»¸æœ€å¤§å€¤ï¼ˆæ™‚åˆ¥æ—¥ç…§æ™‚é–“ï¼‰è¦³æ¸¬ã‚’å®Ÿæ–½ã™ã‚‹åœ°ç‚¹ã®ã¿:
    <input type="number" id="hourlySunMax" value="1"  step="0.5" placeholder="ä¾‹: 1">
  </label>
    <button type="button" class="GraphupdateButton">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
<canvas id="hourlySunChart"></canvas>
</div>
</div>
    <script>
let hourlyCsvData = []; // æ™‚åˆ¥CSVãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let locationName = ''; // åœ°ç‚¹åã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

function updateMainTitle() {
    const startDate = document.getElementById("cultivationStartDate").value;
    const endDate = document.getElementById("cultivationEndDate").value;

    if (startDate && endDate) {
        const startYear = new Date(startDate).getFullYear();
        const endYear = new Date(endDate).getFullYear();
        // ã“ã“ã§ locationName ãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚Œã°ã€æ–‡å­—åŒ–ã‘ãŒè§£æ¶ˆã•ã‚Œã¾ã™
        const title = `${startYear}å¹´-${endYear}å¹´ã€€æ°—è±¡çµŒé æ—¥åˆ¥å€¤ï¼ˆ${locationName || 'åœ°ç‚¹ä¸æ˜'}ï¼‰`;
        document.getElementById("mainTitle").textContent = title;
    } else {
        document.getElementById("mainTitle").textContent = `æ°—è±¡çµŒé æ—¥åˆ¥å€¤ï¼ˆ${locationName || 'åœ°ç‚¹ä¸æ˜'}ï¼‰`;
    }
}

//æ—¥ä»˜è‡ªå‹•è¨­å®š
function updateDateFields() {
    const currentDate = new Date();

    // çµ‚äº†æ—¥ã‚’ç¾åœ¨ã®æ—¥ä»˜ã«è¨­å®š
    const currentYear = currentDate.getFullYear();
    const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0'); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚+1
    const currentDay = String(currentDate.getDate()).padStart(2, '0');
    document.getElementById('cultivationEndDate').value = `${currentYear}-${currentMonth}-${currentDay}`;

    // é–‹å§‹æ—¥ã‚’ç¾åœ¨ã®æ—¥ä»˜ã‹ã‚‰1é€±é–“å‰ã«è¨­å®š
    const oneWeekAgo = new Date(currentDate.getTime() - (7 * 24 * 60 * 60 * 1000)); // 7æ—¥é–“ã®ãƒŸãƒªç§’ã‚’å¼•ã
    const startYear = oneWeekAgo.getFullYear();
    const startMonth = String(oneWeekAgo.getMonth() + 1).padStart(2, '0');
    const startDay = String(oneWeekAgo.getDate()).padStart(2, '0');
    document.getElementById('cultivationStartDate').value = `${startYear}-${startMonth}-${startDay}`;
}

let hourlyTempChart, hourlyPrecChart, hourlySunChart; // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

// DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆã§CSVã‚’èª­ã¿è¾¼ã¿ã€åˆæœŸè¡¨ç¤ºã‚’è¡Œã†
document.addEventListener('DOMContentLoaded', async function() {
    await loadHourlyCSVAndRender(); // CSVã®èª­ã¿è¾¼ã¿ã¨åˆæœŸæç”»
    
    // å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.getElementById('updateButton').addEventListener('click', handleHourlyGraphUpdate);
    document.getElementById('cultivationStartDate').addEventListener('change', handleHourlyGraphUpdate);
    document.getElementById('cultivationEndDate').addEventListener('change', handleHourlyGraphUpdate);

    // ã‚°ãƒ©ãƒ•æ›´æ–°ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const graphUpdateButtons = document.querySelectorAll('.GraphupdateButton');
    graphUpdateButtons.forEach(button => {
        button.addEventListener('click', handleHourlyGraphUpdate);
    });

});

// Encoding.js ã‚’ä½¿ã£ãŸ Shift-JIS â†’ UTF-8 å¤‰æ›é–¢æ•°
function shiftJISToUTF8(arrayBuffer) {
    const uint8Array = new Uint8Array(arrayBuffer);
    const unicodeArray = Encoding.convert(uint8Array, {
        to: 'UNICODE',
        from: 'SJIS',
        type: 'string'
    });
    return unicodeArray;
}

// fetchã§CSVã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadHourlyCSVAndRender() {
    try {
        const response = await fetch('å‡ºé›²æ™‚åˆ¥å€¤.csv'); // ã“ã“ã§CSVãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®š
        if (!response.ok) {
            throw new Error(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.statusText}`);
        }
        
        // response.arrayBuffer() ã‚’ä½¿ç”¨ã—ã€Shift-JISå¤‰æ›ã‚’è¡Œã†
        const arrayBuffer = await response.arrayBuffer();
        const content = shiftJISToUTF8(arrayBuffer); // â˜…ã“ã“ã§å¤‰æ›é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°: å¤‰æ›å¾Œã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨åœ°ç‚¹åæŠ½å‡ºéƒ¨åˆ†ã‚’ç¢ºèª
        console.log("Converted content (first 200 chars):", content.substring(0, 200));
        const linesForDebug = content.trim().split('\n');
        if (linesForDebug.length > 1) {
            console.log("Second line of converted content:", linesForDebug[1]);
            const locationLinePartsForDebug = linesForDebug[1].split(',');
            if (locationLinePartsForDebug.length > 4) {
                console.log("Extracted location part (raw from 2nd line, 5th col):", locationLinePartsForDebug[4]);
                console.log("Extracted location part (trimmed):", locationLinePartsForDebug[4].trim());
            }
        }

        const parseResult = parseCSV(content); // parseCSVã«ç›´æ¥contentã‚’æ¸¡ã™
        hourlyCsvData = parseResult.parsedData;
        locationName = parseResult.locationName;

        updateDateFields(); // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆæœŸåŒ–
        updateMainTitle(); // ã‚¿ã‚¤ãƒˆãƒ«ã‚’åˆæœŸåŒ–
        handleHourlyGraphUpdate(); // ã‚°ãƒ©ãƒ•ã‚’åˆæœŸæç”»
        document.getElementById("chartcanvas").style.display = "block"; // ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    } catch (error) {
        console.error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„å ´æ‰€ã«ã‚ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
}


// æ™‚åˆ¥CSVã®ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°
function parseCSV(content) {
    // ç©ºè¡Œã‚’ç„¡è¦–ã—ã€ãƒˆãƒªãƒ 
    const lines = content.trim().split('\n').filter(line => line.trim() !== "");

    // åœ°ç‚¹åã‚’å–å¾— (2è¡Œç›®ã®5åˆ—ç›®, 0-indexed)
    const locationLine = lines[1].split(',');
    const extractedLocationName = locationLine[4] ? locationLine[4].trim() : '';

    // ãƒ‡ãƒ¼ã‚¿ãŒå§‹ã¾ã‚‹è¡Œã‚’ç‰¹å®š (ä¾‹: 5è¡Œç›®ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå§‹ã¾ã‚‹)
    // CSVã‚µãƒ³ãƒ—ãƒ«:
    // 1: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸæ™‚åˆ»...
    // 2: ,,,,å‡ºé›²,...
    // 3: å¹´,æœˆ,æ—¥,æ™‚,æ°—æ¸©(â„ƒ),æ°—æ¸©(â„ƒ),æ°—æ¸©(â„ƒ),é™æ°´é‡(mm),é™æ°´é‡(mm),é™æ°´é‡(mm),æ—¥ç…§æ™‚é–“(æ™‚é–“),æ—¥ç…§æ™‚é–“(æ™‚é–“),æ—¥ç…§æ™‚é–“(æ™‚é–“)
    // 4: ,,,,,å“è³ªæƒ…å ±,å‡è³ªç•ªå·,,å“è³ªæƒ…å ±,å‡è³ªç•ªå·,,å“è³ªæƒ…å ±,å‡è³ªç•ªå·
    // 5: 2024,1,1,1,7.9,8,1,0.5,8,1,0,8,1
    // ãƒ‡ãƒ¼ã‚¿ã¯lines[4]ã‹ã‚‰å§‹ã¾ã‚‹
    const dataLines = lines.slice(4);

    const parsedData = dataLines.map(line => {
        const cols = line.split(',');
        // å„è¦ç´ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
        // å¹´: 0, æœˆ: 1, æ—¥: 2, æ™‚: 3
        // æ°—æ¸©(â„ƒ): 4 (å“è³ªæƒ…å ±: 5, å‡è³ªç•ªå·: 6)
        // é™æ°´é‡(mm): 7 (å“è³ªæƒ…å ±: 8, å‡è³ªç•ªå·: 9)
        // æ—¥ç…§æ™‚é–“(æ™‚é–“): 10 (å“è³ªæƒ…å ±: 11, å‡è³ªç•ªå·: 12)

        const year = parseInt(cols[0], 10);
        const month = parseInt(cols[1], 10);
        const day = parseInt(cols[2], 10);
        const hour = parseInt(cols[3], 10);

        // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æœˆã‚’0ã‹ã‚‰11ã§æ‰±ã†ãŸã‚ã€-1ã™ã‚‹
        const dateTime = new Date(year, month - 1, day, hour);

        // parseFloatã§æ•°å€¤ã«å¤‰æ›ã€‚ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯0ã¨ã™ã‚‹
        // å“è³ªæƒ…å ± (cols[5], cols[8], cols[11]) ãŒ '8' (æ¬ æ¸¬) ã®å ´åˆã¯å€¤ã‚’0ã¨ã™ã‚‹
        const temperature = (cols[5] === '8' || isNaN(parseFloat(cols[4]))) ? 0 : parseFloat(cols[4]);
        const precipitation = (cols[8] === '8' || isNaN(parseFloat(cols[7]))) ? 0 : parseFloat(cols[7]);
        const sunshine = (cols[11] === '8' || isNaN(parseFloat(cols[10]))) ? 0 : parseFloat(cols[10]);

        return {
            dateTime: dateTime, // æ™‚åˆ»æƒ…å ±ã‚’å«ã‚€Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            temperature: temperature,
            precipitation: precipitation,
            sunshine: sunshine
        };
    });

    return { parsedData, locationName: extractedLocationName }; // ãƒ‡ãƒ¼ã‚¿ã¨åœ°ç‚¹åã‚’è¿”ã™
}

// ã‚°ãƒ©ãƒ•æç”»ãƒ‡ãƒ¼ã‚¿ä½œæˆã¨æç”»ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
function handleHourlyGraphUpdate() {
    if (!hourlyCsvData || hourlyCsvData.length === 0) {
        console.warn("CSVãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    const cultivationStartDate = new Date(document.getElementById("cultivationStartDate").value);
    const cultivationEndDate = new Date(document.getElementById("cultivationEndDate").value);
    cultivationEndDate.setHours(23, 59, 59, 999);

    const filteredData = hourlyCsvData.filter(d =>
        d.dateTime >= cultivationStartDate && d.dateTime <= cultivationEndDate
    );

    console.log("ãƒ•ã‚£ãƒ«ã‚¿å‰ã®ãƒ‡ãƒ¼ã‚¿æ•°:", hourlyCsvData.length);
    console.log("ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ãƒ‡ãƒ¼ã‚¿æ•°:", filteredData.length);
    console.log("æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿:", cultivationStartDate, "ï½", cultivationEndDate);

    if (filteredData.length === 0) {
        console.warn("æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }

    // å¼·åˆ¶çš„ã«ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    document.getElementById("chartcanvas").style.display = "block";

    updateHourlyCharts(filteredData);
    updateMainTitle();
}


// æ™‚åˆ¥ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
function updateHourlyCharts(data) {
    console.log("ğŸ“Š ã‚°ãƒ©ãƒ•æç”»é–¢æ•°å‘¼ã³å‡ºã— OK");
    console.log("å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ä»¶æ•°:", data.length);

    const labels = data.map(d => {
        const year = String(d.dateTime.getFullYear()).slice(-2);
        const month = d.dateTime.getMonth() + 1;
        const day = d.dateTime.getDate();
        const hour = d.dateTime.getHours();
        return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')} ${hour.toString().padStart(2, '0')}æ™‚`;
    });
    console.log("ãƒ©ãƒ™ãƒ«æ•°:", labels.length);
    console.log("å…ˆé ­ãƒ©ãƒ™ãƒ«:", labels[0]);

    const temperatures = data.map(d => d.temperature);
    const precipitations = data.map(d => d.precipitation);
    const sunshines = data.map(d => d.sunshine);

    console.log("æ¸©åº¦é…åˆ—ã®å…ˆé ­å€¤:", temperatures[0]);
    console.log("é™æ°´é‡é…åˆ—ã®å…ˆé ­å€¤:", precipitations[0]);
    console.log("æ—¥ç…§æ™‚é–“é…åˆ—ã®å…ˆé ­å€¤:", sunshines[0]);

    let maxTempValue = parseFloat(document.getElementById('hourlyTempMax').value);
    if (isNaN(maxTempValue) || maxTempValue <= 0) {
        console.warn("æ°—æ¸©æœ€å¤§å€¤ãŒä¸æ­£ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å¤‰æ›´: 30");
        maxTempValue = 30;
    }

    let maxPrecValue = parseFloat(document.getElementById('hourlyPrecMax').value);
    if (isNaN(maxPrecValue) || maxPrecValue <= 0) {
        console.warn("é™æ°´é‡æœ€å¤§å€¤ãŒä¸æ­£ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å¤‰æ›´: 10");
        maxPrecValue = 10;
    }

    let maxSunValue = parseFloat(document.getElementById('hourlySunMax').value);
    if (isNaN(maxSunValue) || maxSunValue <= 0) {
        console.warn("æ—¥ç…§æ™‚é–“æœ€å¤§å€¤ãŒä¸æ­£ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å¤‰æ›´: 1");
        maxSunValue = 1;
    }

    console.log("æœ€å¤§å€¤è¨­å®š:", { maxTempValue, maxPrecValue, maxSunValue });

    const createChart = (ctx, type, labels, datasets, yMax, yTitleText) => {
        console.log(`ğŸ“ˆ ã‚°ãƒ©ãƒ•ä½œæˆé–‹å§‹ (${yTitleText})`);
        return new Chart(ctx, {
            type: type,
            data: { labels, datasets },
            options: {
                animation: false,
                layout: { padding: { left: 20, right: 20, top: 20, bottom: 20 } },
                plugins: {
                    legend: { labels: { font: { size: 30 } } }
                },
                scales: {
                    x: {
                        ticks: { font: { size: 28 }, maxTicksLimit: 24 },
                        title: { display: true, text: 'å¹´-æœˆ-æ—¥ æ™‚åˆ»', font: { size: 30 } }
                    },
                    y: {
                        ticks: { font: { size: 28 } },
                        title: { display: true, text: yTitleText, font: { size: 30 } },
                        suggestedMax: yMax,
                        beginAtZero: true
                    }
                }
            }
        });
    };

    if (hourlyTempChart) hourlyTempChart.destroy();
    hourlyTempChart = createChart(
        document.getElementById('hourlyTempChart').getContext('2d'),
        'line', labels,
        [{ label: 'æ™‚åˆ¥æ°—æ¸©(â„ƒ)', data: temperatures, borderColor: 'rgba(255, 165, 0, 1)', borderWidth: 3, fill: false, tension: 0.1 }],
        maxTempValue, 'æ°—æ¸© (â„ƒ)'
    );

    if (hourlyPrecChart) hourlyPrecChart.destroy();
    hourlyPrecChart = createChart(
        document.getElementById('hourlyPrecChart').getContext('2d'),
        'bar', labels,
        [{ label: 'æ™‚åˆ¥é™æ°´é‡(mm)', data: precipitations, backgroundColor: 'rgba(54, 162, 235, 0.8)', maxBarThickness: 10 }],
        maxPrecValue, 'é™æ°´é‡ (mm)'
    );

    if (hourlySunChart) hourlySunChart.destroy();
    hourlySunChart = createChart(
        document.getElementById('hourlySunChart').getContext('2d'),
        'bar', labels,
        [{ label: 'æ™‚åˆ¥æ—¥ç…§æ™‚é–“(æ™‚é–“)', data: sunshines, backgroundColor: 'rgba(255, 206, 86, 0.8)', maxBarThickness: 10 }],
        maxSunValue, 'æ—¥ç…§æ™‚é–“ (æ™‚é–“)'
    );

    console.log("âœ… ã‚°ãƒ©ãƒ•æç”»å®Œäº†");
}
     </script>

</body>
</html>
