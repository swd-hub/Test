<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出雲市の日出・日入・夜間長</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/encoding-japanese@2.2.0/encoding.min.js"></script>
  <style>
/* （スタイルは元コードのまま） */
body { font-family: 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <h1>出雲市の日出・日入・夜間長</h1>
  <label>開始日:
    <input type="date" id="start-date">
  </label>
  <label>終了日:
    <input type="date" id="end-date">
  </label>
  <button id="btn">取得</button>

  <label id="fileLabel" style="display:none; margin-top: 1em;">
    ローカルCSVを選択:
    <input type="file" id="csvFile" accept=".csv">
  </label>

  <div class="flex-area">
    <table id="resultTable">
      <thead>
        <tr>
          <th>月日</th>
          <th>日出（JST）</th>
          <th>日没（JST）</th>
          <th>昼間長</th>
          <th>夜間長</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="chart-container">
      <div id="loadingMessage">
        <div class="spinner"></div>
        読み込み中...
      </div>
      <canvas id="daylightChart"></canvas>
    </div>
  </div>

<script>
  const today = new Date();
  const oneMonthLater = new Date(today);
  oneMonthLater.setMonth(today.getMonth() + 1);

  // 入力値を YYYY-MM-DD → MM-DD に変換
  function toMMDD(date) {
    const offset = date.getTimezoneOffset();
    const localDate = new Date(date.getTime() - (offset * 60 * 1000));
    return localDate.toISOString().slice(5, 10); // "MM-DD"
  }

  // CSVの日付を "YYYY/MM/DD" → "MM-DD" に変換
  function normalizeDate(dateStr) {
    const [y, m, d] = dateStr.split("/");
    return `${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
  }

  function parseJapaneseDuration(text) {
    const h = parseFloat(text.match(/(\d+)時間/)?.[1] || 0);
    const m = parseFloat(text.match(/(\d+)分/)?.[1] || 0);
    const s = parseFloat(text.match(/(\d+)秒/)?.[1] || 0);
    return h + m / 60 + s / 3600;
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("start-date").value = today.toISOString().slice(0, 10);
    document.getElementById("end-date").value = oneMonthLater.toISOString().slice(0, 10);
  });

  document.getElementById("btn").addEventListener("click", async () => {
    document.getElementById("loadingMessage").style.display = "flex";
    document.getElementById("fileLabel").style.display = "none";

    const startDateStr = toMMDD(new Date(document.getElementById("start-date").value));
    const endDateStr   = toMMDD(new Date(document.getElementById("end-date").value));

    try {
      const csvText = await fetch("izumo_2025_sun_data.csv").then(res => {
        if (!res.ok) throw new Error("fetch failed");
        return res.text();
      });
      processCSV(csvText, startDateStr, endDateStr);
    } catch (err) {
      document.getElementById("loadingMessage").style.display = "none";
      document.getElementById("fileLabel").style.display = "block";
      console.warn("fetch失敗。ローカルCSVを選択してください。");
    }
  });

  document.getElementById("csvFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const sjisArray = new Uint8Array(reader.result);
      const utf8Text = Encoding.convert(sjisArray, {to:'UNICODE', from:'SJIS', type:'string'});
      const startDateStr = toMMDD(new Date(document.getElementById("start-date").value));
      const endDateStr   = toMMDD(new Date(document.getElementById("end-date").value));
      processCSV(utf8Text, startDateStr, endDateStr);
    };
    reader.readAsArrayBuffer(file);
  });

  function processCSV(csvText, startDateStr, endDateStr) {
    const tableBody = document.querySelector('#resultTable tbody');
    tableBody.innerHTML = "";

    let labels = [];
    let nightHours = [];
    let daylightHours = [];

    const rows = csvText.trim().split("\n").slice(1);
    rows.forEach(row => {
      const cols = row.split(",");
      if (cols.length < 5) return;

      const [rawDate, sunrise, sunset, daylight, night] = cols;
      const date = normalizeDate(rawDate); // "MM-DD"

      if (date >= startDateStr && date <= endDateStr) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${date}</td>
          <td>${sunrise}</td>
          <td>${sunset}</td>
          <td>${daylight}</td>
          <td>${night}</td>
        `;
        tableBody.appendChild(tr);

        labels.push(date);
        nightHours.push(Number(parseJapaneseDuration(night).toFixed(2)));
        daylightHours.push(Number(parseJapaneseDuration(daylight).toFixed(2)));
      }
    });

    renderChart(labels, daylightHours, nightHours);
    document.getElementById("loadingMessage").style.display = "none";
  }

  function renderChart(labels, daylightHours, nightHours) {
    const ctx = document.getElementById('daylightChart').getContext('2d');
    if (window.daylightChartObj?.destroy) window.daylightChartObj.destroy();

    window.daylightChartObj = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '昼間長（時間）',
            data: daylightHours,
            borderColor: '#f5a623',
            backgroundColor: 'rgba(245,166,35,0.13)',
            pointBackgroundColor: '#f5a623',
            pointRadius: 3,
            tension: 0.28
          },
          {
            label: '夜間長（時間）',
            data: nightHours,
            borderColor: '#2976d6',
            backgroundColor: 'rgba(41,118,214,0.13)',
            pointBackgroundColor: '#2976d6',
            pointRadius: 3,
            tension: 0.28
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: '昼間長と夜間長の推移', font: { size: 20 } }
        },
        scales: {
          x: {
            title: { display: true, text: '月日', font: { size: 16 } }
          },
          y: {
            title: { display: true, text: '時間（h）', font: { size: 16 } },
            min: 0, max: 24, ticks: { stepSize: 2 }
          }
        }
      }
    });
  }
</script>
</body>
</html>
