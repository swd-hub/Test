<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>肉用子牛市場 取引状況グラフ化ツール v8</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        
        /* ★追加: タイトルとボタンをフレックスコンテナで囲む */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        /* ★追加: リンクボタンのスタイル */
        .source-link-button {
            padding: 8px 15px;
            background-color: #6c757d; /* 落ち着いたグレー */
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background-color 0.2s;
            white-space: nowrap; /* ボタン内のテキストが折り返さないように */
            margin-left: 20px; /* タイトルとの間隔 */
        }
        .source-link-button:hover {
            background-color: #5a6268;
        }

        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .input-area { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chart-area { flex: 2; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        textarea { width: 100%; height: 200px; margin-bottom: 10px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 5px; box-sizing: border-box; }
        
        .controls { margin-bottom: 15px; padding: 10px; background: #eef; border-radius: 5px; }
        .control-group { margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; }
        .control-group label { font-weight: bold; margin-right: 10px; flex-shrink: 0; }
        .radio-label { margin-right: 15px; cursor: pointer; font-size: 0.95rem; }
        
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        .main-button { margin-top: 10px; }
        
        h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        #errorMessage { color: red; font-weight: bold; margin-top: 10px; font-size: 0.9rem; }

        /* 市場選択エリア */
        #marketSelectionContainer { display: none; margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        #marketSelectionArea { max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px; }
        .market-checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; font-size: 0.9rem; }
        .market-checkbox-item input { margin-right: 8px; }
        .selection-header { display: flex; align-items: center; justify-content: space-between; }
        .deselect-button { padding: 5px 10px; font-size: 0.85rem; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .selection-count { font-size: 0.85rem; color: #666; margin-left: auto; padding-left: 10px; }
        
/* ------------------------------------------------ */
/* @media print: 印刷時のスタイル設定               */
/* ------------------------------------------------ */
@media print {
    /* 1. 全ての要素を可視化したままにする（デフォルトから変更なし） */
    
    /* 2. 入力エリア全体を非表示にする */
    .input-area {
        display: none;
    }

    /* 3. グラフエリア (chart-area) は表示したまま、その中の不要な要素を非表示にする */
    .chart-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        /* 印刷時の不要なスタイルを無効化 */
        box-shadow: none; 
        background: white; 
        padding: 0 !important;
        margin: 0 !important;
        flex: none; 
        /* ★A4横向きに収まる目安の高さに修正 (widthの約65%に設定) */
        height: 65vw; 
    }
    
    /* 4. 不要なコントロールパネルを非表示にする */
    .controls {
        display: none;
    }
    
    /* 5. 「3. グラフ表示」のセクションタイトルを非表示にする */
    .chart-area h2 {
        display: none;
    }

    /* 6. グラフ（キャンバス）がページをまたぐのを避ける設定 */
    #myChart {
        page-break-inside: avoid;
        margin-top: 1px;
        max-width: 95vw !important;
        /* ★高さを新しい値に合わせて制限する */
        max-height: 65vw !important; 
    }

    /* ★追加: 印刷時にリンクボタンを非表示にする */
    .source-link-button { 
        display: none; 
    }
}
    </style>
</head>
<body>

    <div class="header-container">
        <h1>月別肉用子牛取引状況 可視化ツール v8</h1>
        <a href="https://www.alic.go.jp/operation/livestock/calf-report.html" 
           target="_blank" 
           class="source-link-button">
            肉用子牛取引情報サイトへ
        </a>
    </div>

    <div class="container">
        <div class="input-area">
            <h2>1. データ入力</h2>
            <p>表データをコピーして貼り付けてください。（**月ヘッダー行を含める推奨**）</p>
            <textarea id="dataInput" placeholder="ExcelやPDFからテキストを貼り付け..."></textarea>
            <button onclick="parseAndSetupUI()" class="main-button">データを読込・市場リスト作成</button>
            <div id="errorMessage"></div>

            <div id="marketSelectionContainer">
                <div class="selection-header">
                    <h2 style="margin-right: 10px;">2. 市場を選択</h2>
                    <button onclick="deselectAllMarkets()" class="deselect-button">全解除</button>
                    <span id="selectionCount" class="selection-count">(0/7)</span>
                </div>
                <p style="font-size:0.85rem; margin-top:0;">以下から比較したい市場を選んでください（最大7つ）</p>
                <div id="marketSelectionArea">
                    </div>
            </div>
        </div>

        <div class="chart-area">
            <h2>3. グラフ表示（印刷：Ctrl＋P）</h2>
            
            <div class="controls">
                
                <div class="control-group">
                    <label>表示項目 (Y軸):</label> <br>
                    <label class="radio-label"><input type="radio" name="metric" value="count" checked onchange="updateChart()"> 取引頭数</label>
                    <label class="radio-label"><input type="radio" name="metric" value="price" onchange="updateChart()"> 平均価格</label>
                    <label class="radio-label"><input type="radio" name="metric" value="weight" onchange="updateChart()"> 平均体重</label>
                    <label class="radio-label"><input type="radio" name="metric" value="age" onchange="updateChart()"> 平均日齢</label>
                    <label class="radio-label"><input type="radio" name="metric" value="unitPrice" onchange="updateChart()"> １㎏単価</label>
                </div>
                <div class="control-group">
                    <label>性別区分:</label> <br>
                    <label class="radio-label"><input type="radio" name="gender" value="total" checked onchange="updateChart()"> 計 (平均)</label>
                    <label class="radio-label"><input type="radio" name="gender" value="female" onchange="updateChart()"> 雌</label>
                    <label class="radio-label"><input type="radio" name="gender" value="male" onchange="updateChart()"> 雄</label>
                </div>
            </div>

            <canvas id="myChart"></canvas>
        </div>
    </div>

<script>
    let parsedAllMarkets = [];
    let myChart = null;
    
    // 標準の11月始まりの13ヶ月サイクル（ヘッダー行がない場合のフォールバック）
    const standardLabels = ["11月", "12月", "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月"];
    
    // 検出されたカスタムラベルを格納する変数
    let customLabels = null;

    function deselectAllMarkets() {
        const checkboxes = document.querySelectorAll('input[name="marketSelect"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        handleSelectionChange(); 
    }

    function parseAndSetupUI() {
        const text = document.getElementById('dataInput').value;
        const lines = text.split('\n');
        parsedAllMarkets = [];
        document.getElementById('errorMessage').textContent = "";
        
        let currentMarket = null;
        let currentMetric = null;

        const keywords = {
            "取引頭数": "count", "平均価格": "price", "平均体重": "weight", 
            "平均日齢": "age", "１㎏単価": "unitPrice"
        };

        // --- X軸ラベルの自動抽出ロジック (V7から変更なし) ---
        customLabels = null;
        for (let j = 0; j < Math.min(10, lines.length); j++) {
            const line = lines[j].trim();
            if (line.includes("月") && !line.match(/^(\s*\d[\s\d]*){5,}/)) {
                
                let parts = line.split(/\s+/).filter(part => part.includes("月"));
                
                if (parts.length >= 12) {
                    
                    const totalIndex = parts.findIndex(p => p.includes("合計") || p.includes("平均") || p.includes("総計"));
                    
                    if (totalIndex !== -1) {
                        customLabels = parts.slice(0, totalIndex); 
                    } else {
                        customLabels = parts.slice(0, 12); 
                    }

                    if (customLabels.length === 12) {
                        customLabels.push(customLabels[0]);
                    }
                    
                    if (customLabels.length === 13) {
                        break;
                    } else {
                        customLabels = null;
                    }
                }
            }
        }
        // ---------------------------------------------


        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            // カンマを削除し、複数のスペースを単一のスペースに置換
            let cleanLine = line.replace(/,/g, '').replace(/\s+/g, ' ');

            if (cleanLine.length === 0) continue;

            const numberCount = (cleanLine.match(/\d+/g) || []).length;

            const isMarketHeader = (
                (line.includes("北海道") || line.includes("市場") || line.includes("集散") || line.includes("合計") || line.includes("総計") || line.includes("県")) 
                && numberCount < 3 
                && !line.includes("月")
            );

            if (isMarketHeader) {
                let marketName = cleanLine.split(' ')[0] + (cleanLine.split(' ')[1] || "");
                marketName = marketName.replace(/＊|\*/g, "");

                // === 除外フィルター処理 ===
                if (marketName.includes("品種") || marketName.includes("黒毛和種")) {
                    currentMarket = null;
                    continue;
                }

                if (marketName.includes("県計") || marketName.includes("県合計") || 
                    marketName.includes("道計") || marketName.includes("道合計") || 
                    marketName.includes("都計") || marketName.includes("府計")) {
                    currentMarket = null;
                    continue;
                }

                currentMarket = {
                    name: marketName,
                    data: { count: {}, price: {}, weight: {}, age: {}, unitPrice: {} }
                };
                parsedAllMarkets.push(currentMarket);
                currentMetric = null; 
                continue;
            }

            if (!currentMarket) continue;

            // --- 項目判定とデータ抽出 ---
            for (const [key, value] of Object.entries(keywords)) {
                if (line.includes(key)) {
                    currentMetric = value;
                    break;
                }
            }

            if (currentMetric) {
                let gender = null;
                if (cleanLine.includes("雌")) gender = "female";
                else if (cleanLine.includes("雄")) gender = "male";
                else if (cleanLine.includes("計") || cleanLine.includes("平均")) gender = "total";

                if (gender) {
                    let numbers = cleanLine.split(' ')
                        .map(s => {
                            const num = parseFloat(s);
                            if (isNaN(num)) {
                                return undefined; // NaNは一旦undefinedにする
                            }
                            // ★ 0 の場合は null を返し、グラフでNAとして扱う（この修正がV8の主要点）
                            return num === 0 ? null : num;
                        })
                        // undefined (元の文字列が数値ではなかったもの) だけをフィルタリングで除外。nullは残す
                        .filter(n => n !== undefined); 
                    
                    if (numbers.length > 0) {
                        currentMarket.data[currentMetric][gender] = numbers;
                    }
                }
            }
        }

        if (parsedAllMarkets.length === 0) {
            document.getElementById('errorMessage').textContent = "有効なデータが見つかりませんでした。";
            document.getElementById('marketSelectionContainer').style.display = 'none';
            return;
        }

        createMarketCheckboxes();
    }

    function createMarketCheckboxes() {
        const container = document.getElementById('marketSelectionArea');
        container.innerHTML = "";
        
        parsedAllMarkets.forEach((market, index) => {
            const label = document.createElement('label');
            label.className = 'market-checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = index;
            checkbox.name = 'marketSelect';
            checkbox.onchange = handleSelectionChange;

            const currentCheckedCount = container.querySelectorAll('input:checked').length;
            if (currentCheckedCount < 7) {
                checkbox.checked = true;
            }

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(market.name));
            container.appendChild(label);
        });

        document.getElementById('marketSelectionContainer').style.display = 'block';
        handleSelectionChange(); 
    }

    function handleSelectionChange() {
        const checkedBoxes = document.querySelectorAll('input[name="marketSelect"]:checked');
        document.getElementById('selectionCount').textContent = `(${checkedBoxes.length}/7)`;

        if (checkedBoxes.length > 7 && this && this.checked) {
            alert("比較できる市場は最大7つまでです。");
            this.checked = false;
            document.getElementById('selectionCount').textContent = `(${checkedBoxes.length - 1}/7)`;
        }
        updateChart();
    }

function updateChart() {
    const checkedIndices = Array.from(document.querySelectorAll('input[name="marketSelect"]:checked'))
                                .map(cb => parseInt(cb.value));
    const targetIndices = checkedIndices.slice(0, 7);

    const ctx = document.getElementById('myChart').getContext('2d');
    const metric = document.querySelector('input[name="metric"]:checked').value;
    const gender = document.querySelector('input[name="gender"]:checked').value;
    
    const finalLabels = customLabels || standardLabels;

    // --- カスタム設定値 ---
    const LINE_THICKNESS = 4; // ラインの太さ (borderWidth)
    const TITLE_FONT_SIZE = 20;
    const AXIS_TITLE_FONT_SIZE = 16;
    const AXIS_TICKS_FONT_SIZE = 20;
    const LEGEND_FONT_SIZE = 18; // ★追加: 凡例のフォントサイズ
    // ----------------------

    const datasets = [];
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#333333'];

    let colorIndex = 0;
    targetIndices.forEach(idx => {
        const market = parsedAllMarkets[idx];
        if (!market.data[metric] || !market.data[metric][gender]) return;

        let dataValues = market.data[metric][gender];
        if (dataValues.length > finalLabels.length) dataValues = dataValues.slice(0, finalLabels.length);

        datasets.push({
            label: market.name,
            data: dataValues,
            borderColor: colors[colorIndex % colors.length],
            backgroundColor: colors[colorIndex % colors.length],
            borderWidth: LINE_THICKNESS,
            spanGaps: true, 
            tension: 0.1,
            fill: false
        });
        colorIndex++;
    });

    if (myChart) myChart.destroy();

    let yLabel = getUnitLabel(metric);

    myChart = new Chart(ctx, {
        type: 'line',
        data: { labels: finalLabels, datasets: datasets },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                title: { 
                    display: true, 
                    text: `${getMetricLabel(metric)} (${getGenderLabel(gender)}) 推移`,
                    font: {
                        size: TITLE_FONT_SIZE
                    }
                },
                // ★凡例の設定を追加
                legend: {
                    labels: {
                        font: {
                            size: LEGEND_FONT_SIZE // ★凡例のフォントサイズを適用
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) label += new Intl.NumberFormat('ja-JP').format(context.parsed.y) + yLabel;
                            else label += 'データなし (NA)';
                            return label;
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true, 
                    title: { 
                        display: true, 
                        text: yLabel,
                        font: {
                            size: AXIS_TITLE_FONT_SIZE
                        }
                    },
                    ticks: {
                        font: {
                            size: AXIS_TICKS_FONT_SIZE
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: AXIS_TICKS_FONT_SIZE
                        }
                    }
                }
            }
        }
    });
}
    function getMetricLabel(m) {
        const labels = { count: "取引頭数", price: "平均価格", weight: "平均体重", age: "平均日齢", unitPrice: "１㎏単価" };
        return labels[m] || m;
    }
    function getGenderLabel(g) {
        const labels = { total: "計・平均", female: "雌", male: "雄" };
        return labels[g] || g;
    }
    function getUnitLabel(m) {
        if (m === 'count') return "頭数";
        if (m === 'price' || m === 'unitPrice') return "円";
        if (m === 'weight') return "kg";
        if (m === 'age') return "日";
        return "";
    }

    window.onload = function() {
        const sampleData = `品種：黒毛和種
都道府県 市場名 11月 12月 1月 2月 3月 4月 5月 6月 7月 8月 9月 10月 11月 合計・平均
北海道 ホクレン南北海道家畜市場
取引頭数 雌 632 785 563 676 625 688 718 690 681 597 604 585 601
平均価格 平均 562387 543803 602386 625206 659744 751438 698412 682838 717826 729645 693877 703967 744596
北海道 ホクレン十勝地区家畜市場
取引頭数 計 0 2582 2088 1898 0 2214 2340 2128 3602 536 2850 1588 0
全国 合計
平均価格 平均 700000 700000 700000 700000 700000 700000 700000 700000 700000 700000 700000 700000 700000`;

        document.getElementById('dataInput').value = sampleData;
        parseAndSetupUI();
    };
</script>

</body>
</html>
