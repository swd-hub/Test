<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚‰ç”¨å­ç‰›å¸‚å ´ï¼ˆé»’æ¯›å’Œç¨®ï¼‰ å–å¼•çŠ¶æ³ã‚°ãƒ©ãƒ•åŒ–ãƒ„ãƒ¼ãƒ« v8</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã‚’ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã§å›²ã‚€ */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        /* ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .source-link-button {
            padding: 8px 15px;
            background-color: #6c757d; /* è½ã¡ç€ã„ãŸã‚°ãƒ¬ãƒ¼ */
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background-color 0.2s;
            white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã« */
            margin-left: 20px; /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ã®é–“éš” */
        }
        .source-link-button:hover {
            background-color: #5a6268;
        }

        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        
        /* input-area ã‚’å‰é¢ã«è¡¨ç¤ºã™ã‚‹è¨­å®š */
        .input-area { 
            flex: 1; 
            min-width: 300px; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative; 
            z-index: 10; 
        }
        .chart-area { 
            flex: 2; 
            min-width: 400px; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative; 
        }
        
        textarea { 
            width: 100%; 
            height: 200px; 
            margin-bottom: 10px; 
            font-family: monospace; 
            font-size: 12px; 
            border: 1px solid #ccc; 
            padding: 5px; 
            box-sizing: border-box; 
        }
        
        .controls { margin-bottom: 15px; padding: 10px; background: #eef; border-radius: 5px; }
        .control-group { margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; }
        .control-group label { font-weight: bold; margin-right: 10px; flex-shrink: 0; }
        .radio-label { margin-right: 15px; cursor: pointer; font-size: 0.95rem; }
        
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        .main-button { margin-top: 10px; }
        
        h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        #errorMessage { color: red; font-weight: bold; margin-top: 10px; font-size: 0.9rem; }

        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ (ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹) */
        .chart-header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ddd;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        /* ãƒ©ãƒƒãƒ‘ãƒ¼å†…ã®h2ã¯ç·šã‚’æ¶ˆã—ã¦ä½™ç™½ã‚’èª¿æ•´ */
        .chart-header-wrapper h2 {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            margin-top: 0;
        }
        /* ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .download-btn {
            width: auto; /* å…¨å¹…ã§ã¯ãªãè‡ªå‹•å¹…ã« */
            padding: 5px 15px;
            font-size: 14px;
            background-color: #28a745; /* ç·‘è‰² */
            color: white;
            border-radius: 4px;
        }
        .download-btn:hover {
            background-color: #218838;
        }

        /* å¸‚å ´é¸æŠã‚¨ãƒªã‚¢ */
        #marketSelectionContainer { display: none; margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        #marketSelectionArea { max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px; }
        .market-checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; font-size: 0.9rem; }
        .market-checkbox-item input { margin-right: 8px; }
        .selection-header { display: flex; align-items: center; justify-content: space-between; }
        .deselect-button { padding: 5px 10px; font-size: 0.85rem; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .selection-count { font-size: 0.85rem; color: #666; margin-left: auto; padding-left: 10px; }
        
/* ------------------------------------------------ */
/* @media print: å°åˆ·æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š               */
/* ------------------------------------------------ */
@media print {
    .header-container h1 { display: none; }
    .input-area { display: none; }
    .chart-area {
        position: absolute;
        left: 2vw;
        top: 5vw;
        width: 100%;
        box-shadow: none; 
        background: white; 
        padding: 0 !important;
        margin: 0 !important;
        flex: none; 
        height: 65vw; 
    }
    .controls { display: none; }
    
    /* å°åˆ·æ™‚ã¯ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼(H2ã¨ä¿å­˜ãƒœã‚¿ãƒ³)ã”ã¨æ¶ˆã™ */
    .chart-header-wrapper { display: none; }

    #myChart {
        page-break-inside: avoid;
        margin-top: 1px;
        max-width: 95vw !important;
        max-height: 65vw !important; 
    }
    .source-link-button { display: none; }
}
    </style>
</head>
<body>

    <div class="header-container">
        <h1>æœˆåˆ¥è‚‰ç”¨å­ç‰›å–å¼•çŠ¶æ³ï¼ˆé»’æ¯›å’Œç¨®ï¼‰ å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ« v8</h1>
        <a href="https://www.alic.go.jp/operation/livestock/calf-report.html" 
           target="_blank" 
           class="source-link-button">
            è‚‰ç”¨å­ç‰›å–å¼•æƒ…å ±ã‚µã‚¤ãƒˆã¸
        </a>
    </div>

    <div class="container">
        <div class="input-area">
            <h2>1. ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
            <p>ã‚¨ã‚¯ã‚»ãƒ«ã‚·ãƒ¼ãƒˆã®è¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
            <textarea id="dataInput" placeholder="Excelã‚„PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
            <button onclick="parseAndSetupUI()" class="main-button">ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼ãƒ»å¸‚å ´ãƒªã‚¹ãƒˆä½œæˆ</button>
            <div id="errorMessage"></div>

            <div id="marketSelectionContainer">
                <div class="selection-header">
                    <h2 style="margin-right: 10px;">2. å¸‚å ´ã‚’é¸æŠ</h2>
                </div>
                    <button onclick="deselectAllMarkets()" class="deselect-button">å…¨è§£é™¤</button>
                    <span id="selectionCount" class="selection-count">(0/7)</span>
                <p style="font-size:0.85rem; margin-top:0;">ä»¥ä¸‹ã‹ã‚‰æ¯”è¼ƒã—ãŸã„å¸‚å ´ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæœ€å¤§7ã¤ï¼‰</p>
                <div id="marketSelectionArea">
                    </div>
            </div>
        </div>

        <div class="chart-area">
            <div class="chart-header-wrapper">
                <h2>3. ã‚°ãƒ©ãƒ•è¡¨ç¤ºï¼ˆå°åˆ·ï¼šCtrlï¼‹Pï¼‰</h2>
                <button onclick="downloadChartImage()" class="download-btn">ç”»åƒä¿å­˜(PNG)</button>
            </div>
            
            <div class="controls">
                
                <div class="control-group">
                    <label>è¡¨ç¤ºé …ç›® (Yè»¸):</label> <br>
                    <label class="radio-label"><input type="radio" name="metric" value="count" checked onchange="updateChart()"> å–å¼•é ­æ•°</label>
                    <label class="radio-label"><input type="radio" name="metric" value="price" onchange="updateChart()"> å¹³å‡ä¾¡æ ¼</label>
                    <label class="radio-label"><input type="radio" name="metric" value="weight" onchange="updateChart()"> å¹³å‡ä½“é‡</label>
                    <label class="radio-label"><input type="radio" name="metric" value="age" onchange="updateChart()"> å¹³å‡æ—¥é½¢</label>
                    <label class="radio-label"><input type="radio" name="metric" value="unitPrice" onchange="updateChart()"> ï¼‘ãå˜ä¾¡</label>
                </div>
                <div class="control-group">
                    <label>æ€§åˆ¥åŒºåˆ†:</label> <br>
                    <label class="radio-label"><input type="radio" name="gender" value="total" checked onchange="updateChart()"> è¨ˆ (å¹³å‡)</label>
                    <label class="radio-label"><input type="radio" name="gender" value="female" onchange="updateChart()"> é›Œ</label>
                    <label class="radio-label"><input type="radio" name="gender" value="male" onchange="updateChart()"> é›„</label>
                </div>
            </div>

            <canvas id="myChart"></canvas>
        </div>
    </div>

<script>
    let parsedAllMarkets = [];
    let myChart = null;
    let marketColorMap = {}; // â˜…è¿½åŠ ï¼šå¸‚å ´åã¨è‰²ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿æŒã™ã‚‹
    
    const standardLabels = ["11æœˆ", "12æœˆ", "1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ"];
    let customLabels = null;
	const FIXED_COLORS = [ // â˜…è¿½åŠ ï¼šå›ºå®šã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
	    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
	    '#9966FF', '#FF9F40', '#333333', '#1f77b4', 
	    '#ff7f0e', '#2ca02c' // 7è‰²ä»¥ä¸Šæ¯”è¼ƒã—ãŸã„å ´åˆã®ãŸã‚ã€è‰²ã‚’è¿½åŠ 
	];
	// ç•°ãªã‚‹ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®šç¾© (Chart.jsã®ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«)
	const POINT_STYLES = [ 
	    'circle', 
	    'rect', 
	    'triangle', 
	    'cross', 
	    'star', 
	    'dash', 
	    'line'
	];
    function deselectAllMarkets() {
        const checkboxes = document.querySelectorAll('input[name="marketSelect"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        handleSelectionChange(); 
    }

    function parseAndSetupUI() {
        const text = document.getElementById('dataInput').value;
        const lines = text.split('\n');
        parsedAllMarkets = [];
        document.getElementById('errorMessage').textContent = "";
        
        let currentMarket = null;
        let currentMetric = null;

        const keywords = {
            "å–å¼•é ­æ•°": "count", "å¹³å‡ä¾¡æ ¼": "price", "å¹³å‡ä½“é‡": "weight", 
            "å¹³å‡æ—¥é½¢": "age", "ï¼‘ãå˜ä¾¡": "unitPrice"
        };

        // --- Xè»¸ãƒ©ãƒ™ãƒ«ã®è‡ªå‹•æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ ---
        customLabels = null;
        for (let j = 0; j < Math.min(10, lines.length); j++) {
            const line = lines[j].trim();
            if (line.includes("æœˆ") && !line.match(/^(\s*\d[\s\d]*){5,}/)) {
                
                let parts = line.split(/\s+/).filter(part => part.includes("æœˆ"));
                
                if (parts.length >= 12) {
                    
                    const totalIndex = parts.findIndex(p => p.includes("åˆè¨ˆ") || p.includes("å¹³å‡") || p.includes("ç·è¨ˆ"));
                    
                    if (totalIndex !== -1) {
                        customLabels = parts.slice(0, totalIndex); 
                    } else {
                        customLabels = parts.slice(0, 12); 
                    }

                    if (customLabels.length === 12) {
                        customLabels.push(customLabels[0]);
                    }
                    
                    if (customLabels.length === 13) {
                        break;
                    } else {
                        customLabels = null;
                    }
                }
            }
        }
        // ---------------------------------------------


        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            let cleanLine = line.replace(/,/g, '').replace(/\s+/g, ' ');

            if (cleanLine.length === 0) continue;

            const numberCount = (cleanLine.match(/\d+/g) || []).length;

            const isMarketHeader = (
                (line.includes("åŒ—æµ·é“") || line.includes("å¸‚å ´") || line.includes("é›†æ•£") || line.includes("åˆè¨ˆ") || line.includes("ç·è¨ˆ") || line.includes("çœŒ")) 
                && numberCount < 3 
                && !line.includes("æœˆ")
            );

            if (isMarketHeader) {
                let marketName = cleanLine.split(' ')[0] + (cleanLine.split(' ')[1] || "");
                marketName = marketName.replace(/ï¼Š|\*/g, "");

                // === é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç† ===
                if (marketName.includes("å“ç¨®") || marketName.includes("é»’æ¯›å’Œç¨®")) {
                    currentMarket = null;
                    continue;
                }

                if (marketName.includes("çœŒè¨ˆ") || marketName.includes("çœŒåˆè¨ˆ") || 
                    marketName.includes("é“è¨ˆ") || marketName.includes("é“åˆè¨ˆ") || 
                    marketName.includes("éƒ½è¨ˆ") || marketName.includes("åºœè¨ˆ")) {
                    currentMarket = null;
                    continue;
                }

                currentMarket = {
                    name: marketName,
                    data: { count: {}, price: {}, weight: {}, age: {}, unitPrice: {} }
                };
                parsedAllMarkets.push(currentMarket);
                currentMetric = null; 
                continue;
            }

            if (!currentMarket) continue;

            for (const [key, value] of Object.entries(keywords)) {
                if (line.includes(key)) {
                    currentMetric = value;
                    break;
                }
            }

            if (currentMetric) {
                let gender = null;
                if (cleanLine.includes("é›Œ")) gender = "female";
                else if (cleanLine.includes("é›„")) gender = "male";
                else if (cleanLine.includes("è¨ˆ") || cleanLine.includes("å¹³å‡")) gender = "total";

                if (gender) {
                    let numbers = cleanLine.split(' ')
                        .map(s => {
                            const num = parseFloat(s);
                            if (isNaN(num)) return undefined;
                            return num === 0 ? null : num;
                        })
                        .filter(n => n !== undefined); 
                    
                    if (numbers.length > 0) {
                        currentMarket.data[currentMetric][gender] = numbers;
                    }
                }
            }
        }

        if (parsedAllMarkets.length === 0) {
            document.getElementById('errorMessage').textContent = "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
            document.getElementById('marketSelectionContainer').style.display = 'none';
            return;
        }

        createMarketCheckboxes();
    }

    function createMarketCheckboxes() {
        const container = document.getElementById('marketSelectionArea');
        container.innerHTML = "";
        
        parsedAllMarkets.forEach((market, index) => {
            const label = document.createElement('label');
            label.className = 'market-checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = index;
            checkbox.name = 'marketSelect';
            checkbox.onchange = handleSelectionChange;

            const currentCheckedCount = container.querySelectorAll('input:checked').length;
            if (currentCheckedCount < 7) {
                checkbox.checked = true;
            }

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(market.name));
            container.appendChild(label);
        });

        document.getElementById('marketSelectionContainer').style.display = 'block';
        handleSelectionChange(); 
    }

    function handleSelectionChange() {
        const checkedBoxes = document.querySelectorAll('input[name="marketSelect"]:checked');
        document.getElementById('selectionCount').textContent = `(${checkedBoxes.length}/7)`;

        if (checkedBoxes.length > 7 && this && this.checked) {
            alert("æ¯”è¼ƒã§ãã‚‹å¸‚å ´ã¯æœ€å¤§7ã¤ã¾ã§ã§ã™ã€‚");
            this.checked = false;
            document.getElementById('selectionCount').textContent = `(${checkedBoxes.length - 1}/7)`;
        }
        updateChart();
    }

function updateChart() {
    const checkedIndices = Array.from(document.querySelectorAll('input[name="marketSelect"]:checked'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(cb => parseInt(cb.value));
    const targetIndices = checkedIndices.slice(0, 7);

    const ctx = document.getElementById('myChart').getContext('2d');
    const metric = document.querySelector('input[name="metric"]:checked').value;
    const gender = document.querySelector('input[name="gender"]:checked').value;
    
    const finalLabels = customLabels || standardLabels;

    // --- ã‚«ã‚¹ã‚¿ãƒ è¨­å®šå€¤ ---
    const LINE_THICKNESS = 4;
    const POINT_RADIUS = 6; // â˜…è¿½åŠ : ãƒã‚¤ãƒ³ãƒˆã®å¤§ãã•
    const POINT_BORDER_WIDTH = 2; // â˜…è¿½åŠ : ãƒã‚¤ãƒ³ãƒˆã®æ ç·šã®å¤ªã•
    const TITLE_FONT_SIZE = 20;
    const AXIS_TITLE_FONT_SIZE = 16;
    const AXIS_TICKS_FONT_SIZE = 20;
    const LEGEND_FONT_SIZE = 18;
    // ----------------------

    const datasets = [];
    // ğŸ’¡ è‰²å›ºå®šã®ãŸã‚ã®å‡¦ç†
    let nextColorIndex = Object.keys(marketColorMap).length;Â 

    // ã‚°ãƒ©ãƒ•ã«è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆ
    targetIndices.forEach((idx, i) => { // â˜…i (0, 1, 2...) ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        const market = parsedAllMarkets[idx];
        if (!market.data[metric] || !market.data[metric][gender]) return;

        let marketColor;
        
        // 1. è‰²ã®å›ºå®š
        if (marketColorMap[market.name]) {
            marketColor = marketColorMap[market.name];
        } else {
            marketColor = FIXED_COLORS[nextColorIndex % FIXED_COLORS.length];
            marketColorMap[market.name] = marketColor; // ãƒãƒƒãƒ”ãƒ³ã‚°ã«ä¿å­˜
            nextColorIndex++; // æ¬¡ã«å‰²ã‚Šå½“ã¦ã‚‹è‰²ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        }
        
        // 2. ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã¨ç™½é»’å¯¾å¿œã®è¨­å®š (POINT_STYLESã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š)
        const marketPointStyle = POINT_STYLES[i % POINT_STYLES.length];
        
        // ç™½é»’å°åˆ·ã§è­˜åˆ¥ã§ãã‚‹ã‚ˆã†ã«ã€ãƒã‚¤ãƒ³ãƒˆã®å¡—ã‚Šã¤ã¶ã—ã¯ç™½ã€æ ç·šã¯ç·šã®è‰²
        const marketPointBackgroundColor = 'white'; 

        let dataValues = market.data[metric][gender];
        if (dataValues.length > finalLabels.length) dataValues = dataValues.slice(0, finalLabels.length);

        datasets.push({
            label: market.name,
            data: dataValues,
            
            // ç·šã®è¨­å®š
            borderColor: marketColor,
            backgroundColor: marketColor, // Chart.jsã®ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆã§ã¯é€šå¸¸æœªä½¿ç”¨ã ãŒã€èƒŒæ™¯è‰²ã¨ã—ã¦æ®‹ã—ã¦ãŠã
            borderWidth: LINE_THICKNESS,
            spanGaps: true,Â 
            tension: 0.1,
            fill: false,
            
            // â˜…ãƒã‚¤ãƒ³ãƒˆè¨­å®šã®è¿½åŠ /ä¿®æ­£ (ç™½é»’å°åˆ·å¯¾å¿œ)
            pointStyle: marketPointStyle,        // å¸‚å ´ã”ã¨ã«ç•°ãªã‚‹å›³å½¢
            pointRadius: POINT_RADIUS,          // ãƒã‚¤ãƒ³ãƒˆã®ã‚µã‚¤ã‚º
            pointBorderWidth: POINT_BORDER_WIDTH, // æ ç·šã®å¤ªã•
            pointBorderColor: marketColor,        // æ ç·šã®è‰²ã¯ç·šã®è‰²ã¨åˆã‚ã›ã‚‹
            pointBackgroundColor: marketPointBackgroundColor // å¡—ã‚Šã¤ã¶ã—ã¯ç™½ (ç™½é»’å°åˆ·ã§å›³å½¢ãŒé»’ã¤ã¶ã‚Œã—ãªã„ã‚ˆã†ã«)
        });
    });

    if (myChart) myChart.destroy();

    let yLabel = getUnitLabel(metric);

    myChart = new Chart(ctx, {
        type: 'line',
        data: { labels: finalLabels, datasets: datasets },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                customCanvasBackgroundColor: {
                    color: 'white',
                },
                title: {Â 
                    display: true,Â 
                    text: `${getMetricLabel(metric)} (${getGenderLabel(gender)}) æ¨ç§»`,
                    font: {
                        size: TITLE_FONT_SIZE
                    }
                },
                legend: {
                    labels: {
                        font: {
                            size: LEGEND_FONT_SIZEÂ 
                        },
                        // â˜…å‡¡ä¾‹ã«ã‚‚ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                        usePointStyle: true,
                        // å‡¡ä¾‹ã®ãƒã‚¤ãƒ³ãƒˆã¯ç™½ã„èƒŒæ™¯ã«ç·šã§è¡¨ç¤º
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.datasets.length) {
                                return data.datasets.map((dataset, i) => {
                                    return {
                                        text: dataset.label,
                                        fillStyle: dataset.pointBackgroundColor || dataset.backgroundColor, // ç™½ (å¡—ã‚Šã¤ã¶ã—)
                                        strokeStyle: dataset.pointBorderColor || dataset.borderColor,    // ç·šã®è‰² (æ ç·š)
                                        lineWidth: dataset.pointBorderWidth || 1,                        // æ ç·šã®å¤ªã•
                                        pointStyle: dataset.pointStyle,                                  // å›³å½¢
                                        hidden: !chart.isDatasetVisible(i),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) label += new Intl.NumberFormat('ja-JP').format(context.parsed.y) + yLabel;
                            else label += 'ãƒ‡ãƒ¼ã‚¿ãªã— (NA)';
                            return label;
                        }
                    }
                }
            },
            scales: {Â 
                y: {Â 
                    beginAtZero: true,Â 
                    title: {Â 
                        display: true,Â 
                        text: "",
                        font: {
                            size: AXIS_TITLE_FONT_SIZE
                        }
                    },
                    ticks: {
                        font: {
                            size: AXIS_TICKS_FONT_SIZE
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: AXIS_TICKS_FONT_SIZE
                        }
                    }
                }
            }
        },
        // èƒŒæ™¯è‰²ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®šç¾©
        plugins: [{
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart, args, options) => {
                const {ctx} = chart;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.color || '#99ffff';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        }]
    });
}
function getMetricLabel(m) {
        const labels = { count: "å–å¼•é ­æ•°", price: "å¹³å‡ä¾¡æ ¼(å††)", weight: "å¹³å‡ä½“é‡ï¼ˆkgï¼‰", age: "å¹³å‡æ—¥é½¢", unitPrice: "ï¼‘ãå˜ä¾¡ï¼ˆå††ï¼‰" };
        return labels[m] || m;
    }
    function getGenderLabel(g) {
        const labels = { total: "è¨ˆãƒ»å¹³å‡", female: "é›Œ", male: "é›„" };
        return labels[g] || g;
    }
    function getUnitLabel(m) {
        if (m === 'count') return "é ­æ•°";
        if (m === 'price' || m === 'unitPrice') return "å††";
        if (m === 'weight') return "kg";
        if (m === 'age') return "æ—¥";
        return "";
    }

    // â˜…ä¿®æ­£: ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«ã™ã‚‹
    function downloadChartImage() {
        if (!myChart) {
            alert("ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
        }
        const link = document.createElement('a');
        link.href = myChart.toBase64Image();
        
        // ã‚°ãƒ©ãƒ•ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
        let title = myChart.options.plugins.title.text || 'chart';
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã¦è¨­å®š (ä¾‹: å–å¼•é ­æ•° (è¨ˆãƒ»å¹³å‡) æ¨ç§».png)
        link.download = title + '.png';
        
        link.click();
    }

    window.onload = function() {
        const sampleData = `å“ç¨®ï¼šé»’æ¯›å’Œç¨®ï¼ˆä¾‹ç¤ºï¼‰
éƒ½é“åºœçœŒ å¸‚å ´å 11æœˆ 12æœˆ 1æœˆ 2æœˆ 3æœˆ 4æœˆ 5æœˆ 6æœˆ 7æœˆ 8æœˆ 9æœˆ 10æœˆ 11æœˆ åˆè¨ˆãƒ»å¹³å‡
åŒ—æµ·é“ ãƒ›ã‚¯ãƒ¬ãƒ³å—åŒ—æµ·é“å®¶ç•œå¸‚å ´ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
å–å¼•é ­æ•° é›Œ 632 785 563 676 625 688 718 690 681 597 604 585 601
å¹³å‡ä¾¡æ ¼ å¹³å‡ 562387 543803 602386 625206 659744 751438 698412 682838 717826 729645 693877 703967 744596
åŒ—æµ·é“ ãƒ›ã‚¯ãƒ¬ãƒ³åå‹åœ°åŒºå®¶ç•œå¸‚å ´ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
å–å¼•é ­æ•° è¨ˆ 0 2582 2088 1898 0 2214 2340 2128 3602 536 2850 1588 0
å…¨å›½ åˆè¨ˆï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
å¹³å‡ä¾¡æ ¼ å¹³å‡ 100000 200000 300000 400000 500000 600000 700000 800000 900000 1000000 1100000 1200000 1300000`;

        document.getElementById('dataInput').value = sampleData;
        parseAndSetupUI();
    };
</script>

</body>
</html>
