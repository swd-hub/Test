<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        padding: 30px;
    }
    
    h1 {
        color: #333;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
    }
    
    .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .section h2 {
        font-size: 18px;
        color: #333;
        margin-bottom: 15px;
    }

    .download-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .download-banner-text {
        flex: 1;
    }

    .download-banner-text h3 {
        font-size: 16px;
        margin-bottom: 5px;
    }

    .download-banner-text p {
        font-size: 13px;
        opacity: 0.95;
    }

    .download-btn {
        background: white;
        color: #667eea;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        white-space: nowrap;
        margin-left: 15px;
    }

    .download-btn:hover {
        background: #f0f4ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .download-btn:active {
        transform: translateY(0);
    }
    
    .file-input-wrapper {
        position: relative;
    }
    
    .file-input-wrapper label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
    }
    
    .dropzone {
        padding: 40px;
        border: 3px dashed #ddd;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
    }
    
    .dropzone:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .dropzone.dragover {
        border-color: #667eea;
        background: #e7f0ff;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
    }
    
    .dropzone-icon {
        font-size: 40px;
        margin-bottom: 10px;
    }
    
    .dropzone-text {
        font-size: 16px;
        color: #333;
        margin-bottom: 4px;
        font-weight: 600;
    }
    
    .dropzone-subtext {
        font-size: 13px;
        color: #999;
    }
    
    .file-list {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #e7f3ff;
        border-radius: 4px;
        margin-bottom: 5px;
        font-size: 13px;
        color: #0066cc;
    }
    
    .file-item .file-name {
        flex: 1;
    }
    
    .file-item .remove-btn {
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 11px;
        margin-left: 8px;
    }
    
    .file-item .remove-btn:hover {
        background: #cc0000;
    }
    
    .file-count {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
    }
    
    .file-input-wrapper input[type="file"] {
        display: none;
    }
    
    button {
        padding: 12px 30px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background 0.3s, transform 0.1s;
    }
    
    button:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }
    
    button:active {
        transform: translateY(0);
    }
    
    button.search-btn {
        margin-top: 24px;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        border-left: 4px solid #f5c6cb;
        display: none;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        border-left: 4px solid #c3e6cb;
        display: none;
    }
    
    .search-controls {
        display: grid;
        gap: 15px;
    }
    
    .control-group {
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
    }
    
    .checkbox-group {
        flex: 0 0 220px;
    }
    
    .checkbox-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #555;
    }
    
    .checkbox-controls {
        display: flex;
        gap: 5px;
        margin-bottom: 8px;
    }
    
    .checkbox-controls button {
        flex: 1;
        padding: 6px 10px;
        font-size: 12px;
    }
    
    .checkbox-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 250px;
        overflow-y: auto;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .checkbox-options label {
        display: flex;
        align-items: center;
        margin: 0;
        font-weight: normal;
        cursor: pointer;
        padding: 5px;
        font-size: 14px;
        word-break: break-word;
    }
    
    .checkbox-options input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    .search-keywords-group {
        flex: 1;
        min-width: 400px;
    }
    
    .search-keywords-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #555;
    }
    
    .keywords-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 250px;
        overflow-y: auto;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .keyword-item {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .keyword-item.inactive {
        opacity: 0.5;
    }
    
    .keyword-item label {
        display: block;
        font-size: 12px;
        color: #555;
        margin: 0 0 4px 0;
        font-weight: 600;
    }
    
    .keyword-item input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .keyword-help {
        font-size: 12px;
        color: #999;
        margin-top: 8px;
        padding: 8px;
        background: #f0f0f0;
        border-radius: 4px;
    }
    
    .results {
        margin-top: 20px;
    }
    
    .result-count {
        color: #666;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .filter-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-input-wrapper {
        flex: 1;
        min-width: 150px;
    }

    .filter-input-wrapper label {
        font-size: 12px;
        color: #666;
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
    }

    .filter-input-wrapper input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }

    .filter-input-wrapper input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .button-group {
        display: flex;
        gap: 10px;
    }

    .clear-filters-btn {
        background: #6c757d;
        padding: 8px 16px;
        font-size: 13px;
        height: fit-content;
        white-space: nowrap;
    }

    .clear-filters-btn:hover {
        background: #5a6268;
    }

    .print-btn {
        background: #28a745;
        padding: 8px 16px;
        font-size: 13px;
        height: fit-content;
        white-space: nowrap;
    }

    .print-btn:hover {
        background: #218838;
    }
    
    .results-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 5px;
        overflow: hidden;
        font-size: 13px;
    }
    
    .results-table thead {
        background: #667eea;
        color: white;
        position: sticky;
        top: 0;
    }

    .results-table th {
        padding: 10px;
        text-align: left;
        font-weight: 600;
        word-break: break-word;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .results-table th:hover {
        background: #5568d3;
    }

    .filter-icon {
        display: inline-block;
        margin-left: 5px;
        font-size: 12px;
    }
    
    .results-table td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        word-break: break-word;
    }
    
    .results-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .results-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .highlight {
        background: #fffacd;
        font-weight: 600;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .no-results {
        text-align: center;
        color: #999;
        padding: 30px;
        font-size: 16px;
    }
    
    .status {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }

    .selected-headers {
        margin-top: 10px;
        padding: 10px;
        background: #e7f3ff;
        border-radius: 5px;
        font-size: 13px;
        color: #0066cc;
    }

    .loading {
        display: inline-block;
        text-align: center;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        overflow: hidden;
    }

    .preview-modal.show {
        display: flex;
        flex-direction: column;
    }

    .preview-header {
        background: #333;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .preview-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .preview-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .preview-controls button {
        padding: 8px 16px;
        font-size: 13px;
        margin: 0;
    }

    .preview-controls span {
        color: white;
        font-size: 14px;
        margin: 0 10px;
    }

    .preview-container {
        flex: 1;
        background: #e0e0e0;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .preview-page {
        background: white;
        width: 297mm;
        height: 210mm;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        padding: 15mm;
        box-sizing: border-box;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .preview-page > * {
        flex-shrink: 0;
    }

    .preview-page:last-child {
        margin-bottom: 20px;
    }

    .close-preview-btn {
        background: #dc3545;
        padding: 8px 20px;
        font-size: 13px;
        margin: 0;
    }

    .close-preview-btn:hover {
        background: #c82333;
    }

    /* éš ã—å°åˆ·ã‚³ãƒ³ãƒ†ãƒŠ */
    #printContainer {
        display: none;
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    @media print {
        * {
            margin: 0;
            padding: 0;
        }

        @page {
            size: A4 landscape;
            margin: 8mm;
        }

        body {
            margin: 0;
            padding: 0;
            background: white;
            font-size: 10px;
        }

        .container,
        .section,
        .download-banner,
        #filterSection,
        .preview-modal,
        #resultsContainer {
            display: none !important;
        }

        #printContainer {
            display: block !important;
            margin: 0;
            padding: 0;
        }

        .print-page {
            page-break-after: always;
            width: 100%;
            padding: 0;
            margin: 0;
            break-inside: avoid;
            overflow: visible;
        }

        .print-page:last-child {
            page-break-after: avoid;
        }

        .print-header {
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .print-header h1 {
            font-size: 13px;
            margin: 0 0 2px 0;
            color: #000;
        }

        .print-header p {
            font-size: 8px;
            margin: 0;
            color: #000;
        }

        .print-info {
            font-size: 8px;
            margin: 5px 0 8px 0;
            color: #000;
            flex-shrink: 0;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
            margin: 0;
            border: 1px solid #000;
        }

        .results-table thead {
            background: #999;
            color: #fff;
            display: table-header-group;
        }

        .results-table th {
            border: 1px solid #000;
            padding: 3px;
            font-weight: bold;
            text-align: left;
            background: #999 !important;
            color: #fff !important;
        }

        .results-table td {
            border: 1px solid #000;
            padding: 3px;
            background: #fff !important;
            color: #000 !important;
        }

        .results-table tbody {
            display: table-row-group;
        }

        .results-table tbody tr:last-child td {
            border-bottom: 1px solid #000;
        }

        .results-table tbody tr {
            page-break-inside: avoid;
        }

        .highlight {
            background: transparent !important;
            font-weight: normal;
            padding: 0;
        }
    }

    @media (max-width: 768px) {
        .download-banner {
            flex-direction: column;
            align-items: flex-start;
        }

        .download-btn {
            margin-left: 0;
            margin-top: 15px;
            width: 100%;
            text-align: center;
        }

        .preview-page {
            width: 100%;
            height: auto;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¾ è¾²è–¬æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ¼ã‚¸ã—ã¦è¾²è–¬æƒ…å ±ã‚’æ¤œç´¢</p>
        
        <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ -->
        <div class="download-banner">
            <div class="download-banner-text">
                <h3>ğŸ“¥ è¾²è–¬ç™»éŒ²æƒ…å ±ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
                <p>FAMICï¼ˆè¾²æ—æ°´ç”£æ¶ˆè²»å®‰å…¨æŠ€è¡“ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰ã®è¾²è–¬ç™»éŒ²æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
            </div>
            <a href="http://www.acis.famic.go.jp/ddownload/" target="_blank" class="download-btn">
                âœ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ãƒˆã¸
            </a>
        </div>
        
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h2>
            <div class="file-input-wrapper">
                <label for="csvFiles">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
                <div class="dropzone" id="dropzone">
                    <div class="dropzone-icon">ğŸ“„</div>
                    <div class="dropzone-text">è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div class="dropzone-subtext">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                </div>
                <input type="file" id="csvFiles" accept=".csv" multiple>
                <div class="file-list" id="fileList"></div>
                <div class="file-count" id="fileCount"></div>
            </div>
            <div id="loadError" class="error-message"></div>
            <div id="loadSuccess" class="success-message"></div>
            <div class="status" id="loadStatus"></div>
        </div>
        
        <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ” ã‚¹ãƒ†ãƒƒãƒ—2ï¼šæ¤œç´¢æ¡ä»¶ã‚’è¨­å®š</h2>
            <div class="search-controls">
                <div class="control-group">
                    <div class="checkbox-group">
                        <label>æ¤œç´¢å¯¾è±¡ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é¸æŠ</label>
                        <div class="checkbox-controls">
                            <button onclick="checkAllHeaders()" style="padding: 6px 10px; font-size: 12px;">âœ“ ã™ã¹ã¦</button>
                            <button onclick="uncheckAllHeaders()" style="padding: 6px 10px; font-size: 12px;">âœ— ãªã—</button>
                        </div>
                        <div class="checkbox-options" id="headerCheckboxes"></div>
                        <div class="selected-headers" id="selectedHeadersList" style="display: none;">
                            <strong>é¸æŠä¸­:</strong> <span id="selectedHeadersText"></span>
                        </div>
                    </div>
                    <div class="search-keywords-group">
                        <label>ãƒ˜ãƒƒãƒ€ãƒ¼ã”ã¨ã®æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                        <div class="keywords-container" id="keywordsContainer"></div>
                        <div class="keyword-help">
                            ğŸ’¡ ç©ºç™½ = ã™ã¹ã¦ã®å€¤ã«ãƒãƒƒãƒï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼‰<br>
                            ğŸ”¢ å…¨è§’ã‚«ã‚¿ã‚«ãƒŠãƒ»æ•°å­—ãƒ»æ–‡å­—ã¯è‡ªå‹•å¤‰æ›
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; width: 100%;">
                    <button onclick="performSearch()" class="search-btn">æ¤œç´¢</button>
                </div>
            </div>
            <div id="searchError" class="error-message"></div>
        </div>
        
        <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“Š æ¤œç´¢çµæœ</h2>
            <div id="filterSection" style="display: none;">
                <div class="filter-row" id="filterRow"></div>
            </div>
            <div id="resultsContainer">
                <p class="no-results">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§æ¤œç´¢ã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>

    <!-- å°åˆ·ç”¨ã‚³ãƒ³ãƒ†ãƒŠï¼ˆéš ã—ï¼‰ -->
    <div id="printContainer"></div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-header">
            <h2>ğŸ“„ å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div class="preview-controls">
                <span id="pageInfo">ãƒšãƒ¼ã‚¸ 1/1</span>
                <button onclick="previousPage()">â—€ å‰ã¸</button>
                <button onclick="nextPage()">æ¬¡ã¸ â–¶</button>
                <button onclick="printNow()" style="background: #007bff;">ğŸ–¨ï¸ å°åˆ·</button>
                <button class="close-preview-btn" onclick="closePreview()">Ã— é–‰ã˜ã‚‹</button>
            </div>
        </div>
        <div class="preview-container" id="previewContainer"></div>
    </div>
    
    <script>
        let mergedData = null;
        let headers = [];
        let keywordInputs = {};
        let selectedFiles = [];
        let currentResults = [];
        let selectedHeaders = [];
        let columnFilters = {};
        let previewPages = [];
        let printPages = [];
        let currentPage = 0;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼
        const DEFAULT_CHECKED_HEADERS = [
            'è¾²è–¬ã®åç§°',
            'ä½œç‰©å',
            'é©ç”¨ç—…å®³è™«é›‘è‰å',
            'å¸Œé‡ˆå€æ•°ä½¿ç”¨é‡',
            'ä½¿ç”¨æ™‚æœŸ'
        ];
        
        /**
         * å…¨è§’ã‚’ãƒãƒ³ã‚«ã‚¯ã«å¤‰æ›ï¼ˆå®Œå…¨ç‰ˆï¼‰
         */
        function toHankaku(str) {
            if (!str) return '';
            
            let result = str.replace(/[ï¼-ï¼™]/g, (s) => {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            result = result.replace(/[ï¼¡-ï¼º]/g, (s) => {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            result = result.replace(/[ï½-ï½š]/g, (s) => {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            const kanaMap = {
                'ã‚¬': 'ï½¶ï¾', 'ã‚®': 'ï½·ï¾', 'ã‚°': 'ï½¸ï¾', 'ã‚²': 'ï½¹ï¾', 'ã‚´': 'ï½ºï¾',
                'ã‚¶': 'ï½»ï¾', 'ã‚¸': 'ï½¼ï¾', 'ã‚º': 'ï½½ï¾', 'ã‚¼': 'ï½¾ï¾', 'ã‚¾': 'ï½¿ï¾',
                'ãƒ€': 'ï¾€ï¾', 'ãƒ‚': 'ï¾ï¾', 'ãƒ…': 'ï¾‚ï¾', 'ãƒ‡': 'ï¾ƒï¾', 'ãƒ‰': 'ï¾„ï¾',
                'ãƒ': 'ï¾Šï¾', 'ãƒ“': 'ï¾‹ï¾', 'ãƒ–': 'ï¾Œï¾', 'ãƒ™': 'ï¾ï¾', 'ãƒœ': 'ï¾ï¾',
                'ãƒ‘': 'ï¾Šï¾Ÿ', 'ãƒ”': 'ï¾‹ï¾Ÿ', 'ãƒ—': 'ï¾Œï¾Ÿ', 'ãƒš': 'ï¾ï¾Ÿ', 'ãƒ': 'ï¾ï¾Ÿ',
                'ã‚¡': 'ï½§', 'ã‚£': 'ï½¨', 'ã‚¥': 'ï½©', 'ã‚§': 'ï½ª', 'ã‚©': 'ï½«',
                'ãƒ£': 'ï½¬', 'ãƒ¥': 'ï½­', 'ãƒ§': 'ï½®',
                'ãƒƒ': 'ï¾‚', 'ãƒ¼': 'ï½°',
                'ã‚¢': 'ï½±', 'ã‚¤': 'ï½²', 'ã‚¦': 'ï½³', 'ã‚¨': 'ï½´', 'ã‚ª': 'ï½µ',
                'ã‚«': 'ï½¶', 'ã‚­': 'ï½·', 'ã‚¯': 'ï½¸', 'ã‚±': 'ï½¹', 'ã‚³': 'ï½º',
                'ã‚µ': 'ï½»', 'ã‚·': 'ï½¼', 'ã‚¹': 'ï½½', 'ã‚»': 'ï½¾', 'ã‚½': 'ï½¿',
                'ã‚¿': 'ï¾€', 'ãƒ': 'ï¾', 'ãƒ„': 'ï¾‚', 'ãƒ†': 'ï¾ƒ', 'ãƒˆ': 'ï¾„',
                'ãƒŠ': 'ï¾…', 'ãƒ‹': 'ï¾†', 'ãƒŒ': 'ï¾‡', 'ãƒ': 'ï¾ˆ', 'ãƒ': 'ï¾‰',
                'ãƒ': 'ï¾Š', 'ãƒ’': 'ï¾‹', 'ãƒ•': 'ï¾Œ', 'ãƒ˜': 'ï¾', 'ãƒ›': 'ï¾',
                'ãƒ': 'ï¾', 'ãƒŸ': 'ï¾', 'ãƒ ': 'ï¾‘', 'ãƒ¡': 'ï¾’', 'ãƒ¢': 'ï¾“',
                'ãƒ¤': 'ï¾”', 'ãƒ¦': 'ï¾•', 'ãƒ¨': 'ï¾–',
                'ãƒ©': 'ï¾—', 'ãƒª': 'ï¾˜', 'ãƒ«': 'ï¾™', 'ãƒ¬': 'ï¾š', 'ãƒ­': 'ï¾›',
                'ãƒ¯': 'ï¾œ', 'ãƒ²': 'ï½¦', 'ãƒ³': 'ï¾',
                'ã€‚': 'ï½¡', 'ã€': 'ï½¤', 'ã€Œ': 'ï½¢', 'ã€': 'ï½£'
            };
            
            let katakanaConverted = '';
            for (let char of result) {
                katakanaConverted += kanaMap[char] || char;
            }
            
            katakanaConverted = katakanaConverted.replace(/ï¼/g, '.');
            katakanaConverted = katakanaConverted.replace(/ï¼/g, '!');
            katakanaConverted = katakanaConverted.replace(/ï¼Ÿ/g, '?');
            katakanaConverted = katakanaConverted.replace(/ã€€/g, ' ');
            
            return katakanaConverted;
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®åˆæœŸåŒ–
        function initDragDrop() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('csvFiles');
            
            dropzone.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                selectedFiles = Array.from(e.target.files);
                updateFileList();
                if (selectedFiles.length > 0) {
                    setTimeout(() => {
                        loadAndMergeCSV();
                    }, 100);
                }
            });
            
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                const csvFiles = Array.from(files).filter(file => file.name.endsWith('.csv'));
                
                if (csvFiles.length !== files.length) {
                    alert('âš ï¸ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
                }
                
                if (csvFiles.length > 0) {
                    selectedFiles = csvFiles;
                    updateFileList();
                    setTimeout(() => {
                        loadAndMergeCSV();
                    }, 100);
                }
            });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            
            fileList.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-name">âœ… ${file.name}</span>
                    <button class="remove-btn" onclick="removeFile(${index})">å‰Šé™¤</button>
                `;
                fileList.appendChild(item);
            });
            
            if (selectedFiles.length > 0) {
                fileCount.textContent = `ğŸ“Š ${selectedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ`;
            } else {
                fileCount.textContent = '';
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            mergedData = null;
            headers = [];
            document.getElementById('headerCheckboxes').innerHTML = '';
            document.getElementById('keywordsContainer').innerHTML = '';
            document.getElementById('resultsContainer').innerHTML = '<p class="no-results">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§æ¤œç´¢ã—ã¦ãã ã•ã„</p>';
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã¨ã—ã¦èª­ã¿è¾¼ã‚€
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${file.name}`));
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Shift-JISã¾ãŸã¯UTF-8ã‹ã‚‰æ–‡å­—åˆ—ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
        async function decodeFile(arrayBuffer) {
            try {
                const decoder = new TextDecoder('utf-8', { fatal: true });
                const text = decoder.decode(arrayBuffer);
                
                if (text.charCodeAt(0) === 0xFEFF) {
                    return text.slice(1);
                }
                return text;
            } catch (e) {
                try {
                    const decoder = new TextDecoder('shift-jis', { fatal: true });
                    const text = decoder.decode(arrayBuffer);
                    return text;
                } catch (e2) {
                    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚UTF-8ã¾ãŸã¯Shift-JISã§ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
                }
            }
        }
        
        // CSVã‚’è§£æã™ã‚‹é–¢æ•°
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length === 0) {
                throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] || '';
                }
                data.push(row);
            }
            
            return { headers, data };
        }
        
        // ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯
        function checkAllHeaders() {
            document.querySelectorAll('input[name="header"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedHeaders();
        }
        
        // ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯å¤–ã™
        function uncheckAllHeaders() {
            document.querySelectorAll('input[name="header"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedHeaders();
        }
        
        // é¸æŠæ¸ˆã¿ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤ºï¼‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã‚’æ›´æ–°
        function updateSelectedHeaders() {
            const checkboxes = document.querySelectorAll('input[name="header"]:checked');
            const selectedList = document.getElementById('selectedHeadersList');
            const selectedText = document.getElementById('selectedHeadersText');
            const keywordsContainer = document.getElementById('keywordsContainer');
            
            if (checkboxes.length > 0) {
                const selected = Array.from(checkboxes).map(cb => cb.value).join(', ');
                selectedText.textContent = selected;
                selectedList.style.display = 'block';
            } else {
                selectedList.style.display = 'none';
            }
            
            keywordsContainer.innerHTML = '';
            keywordInputs = {};
            
            headers.forEach(header => {
                const checkbox = document.querySelector(`input[name="header"][value="${header}"]`);
                const isChecked = checkbox && checkbox.checked;
                
                const item = document.createElement('div');
                item.className = `keyword-item ${isChecked ? '' : 'inactive'}`;
                
                const label = document.createElement('label');
                label.textContent = header;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›';
                input.disabled = !isChecked;
                input.dataset.convertedValue = '';
                
                input.addEventListener('input', (e) => {
                    const displayValue = e.target.value;
                    const convertedValue = toHankaku(displayValue);
                    input.dataset.convertedValue = convertedValue;
                });
                
                keywordInputs[header] = input;
                
                item.appendChild(label);
                item.appendChild(input);
                keywordsContainer.appendChild(item);
            });
        }
        
        // CSVã‚’èª­ã¿è¾¼ã‚“ã§ãƒãƒ¼ã‚¸ã™ã‚‹é–¢æ•°
        async function loadAndMergeCSV() {
            const errorDiv = document.getElementById('loadError');
            const successDiv = document.getElementById('loadSuccess');
            const statusDiv = document.getElementById('loadStatus');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            statusDiv.innerHTML = '<div class="loading"><span class="spinner"></span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...</div>';
            
            if (selectedFiles.length === 0) {
                errorDiv.textContent = 'âŒ å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
                errorDiv.style.display = 'block';
                statusDiv.textContent = '';
                return;
            }
            
            try {
                let firstHeaders = null;
                let allData = [];
                
                for (const file of selectedFiles) {
                    const buffer = await readFileAsArrayBuffer(file);
                    const text = await decodeFile(buffer);
                    const result = parseCSV(text);
                    
                    if (firstHeaders === null) {
                        firstHeaders = result.headers;
                    } else if (JSON.stringify(firstHeaders) !== JSON.stringify(result.headers)) {
                        errorDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ç•°ãªã‚Šã¾ã™ã€‚\n\n` +
                            `æœŸå¾…: ${firstHeaders.join(', ')}\n\n` +
                            `å®Ÿéš›: ${result.headers.join(', ')}`;
                        errorDiv.style.display = 'block';
                        statusDiv.textContent = '';
                        return;
                    }
                    
                    allData = allData.concat(result.data);
                }
                
                headers = firstHeaders;
                mergedData = allData;
                
                const checkboxContainer = document.getElementById('headerCheckboxes');
                checkboxContainer.innerHTML = '';
                headers.forEach((header) => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'header';
                    checkbox.value = header;
                    
                    if (DEFAULT_CHECKED_HEADERS.includes(header)) {
                        checkbox.checked = true;
                    }
                    
                    checkbox.addEventListener('change', updateSelectedHeaders);
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(header));
                    checkboxContainer.appendChild(label);
                });
                
                updateSelectedHeaders();
                
                successDiv.textContent = `âœ… ãƒãƒ¼ã‚¸å®Œäº†ï¼${selectedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚åˆè¨ˆ: ${mergedData.length}è¡Œ`;
                successDiv.style.display = 'block';
                statusDiv.textContent = `ãƒ˜ãƒƒãƒ€ãƒ¼æ•°: ${headers.length}å€‹ã€ç·ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ${mergedData.length}è¡Œ`;
                
            } catch (error) {
                errorDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
                errorDiv.style.display = 'block';
                statusDiv.textContent = '';
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡Œã‚’ä½œæˆ
        function createFilterRow() {
            const filterRow = document.getElementById('filterRow');
            const filterSection = document.getElementById('filterSection');
            filterRow.innerHTML = '';
            columnFilters = {};
            
            selectedHeaders.forEach(header => {
                const wrapper = document.createElement('div');
                wrapper.className = 'filter-input-wrapper';
                
                const label = document.createElement('label');
                label.textContent = `ğŸ” ${header}`;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `${header}ã§çµã‚Šè¾¼ã¿...`;
                input.dataset.header = header;
                input.dataset.convertedValue = '';
                
                input.addEventListener('input', (e) => {
                    const displayValue = e.target.value;
                    const convertedValue = toHankaku(displayValue).toLowerCase();
                    input.dataset.convertedValue = convertedValue;
                    columnFilters[header] = convertedValue;
                    updateResultsWithFilter();
                });
                
                columnFilters[header] = '';
                
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                filterRow.appendChild(wrapper);
            });
            
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';
            
            const clearBtn = document.createElement('button');
            clearBtn.className = 'clear-filters-btn';
            clearBtn.textContent = 'ğŸ—‘ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢';
            clearBtn.onclick = (e) => {
                e.preventDefault();
                document.querySelectorAll('.filter-input-wrapper input').forEach(input => {
                    input.value = '';
                    input.dataset.convertedValue = '';
                });
                columnFilters = {};
                selectedHeaders.forEach(h => columnFilters[h] = '');
                updateResultsWithFilter();
            };
            
            const printBtn = document.createElement('button');
            printBtn.className = 'print-btn';
            printBtn.textContent = 'ğŸ–¨ï¸ A4æ¨ªã§å°åˆ·';
            printBtn.onclick = (e) => {
                e.preventDefault();
                showPrintPreview();
            };
            
            buttonGroup.appendChild(clearBtn);
            buttonGroup.appendChild(printBtn);
            filterRow.appendChild(buttonGroup);
            filterSection.style.display = 'block';
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦çµæœã‚’æ›´æ–°
        function updateResultsWithFilter() {
            const filteredResults = currentResults.filter(row => {
                return selectedHeaders.every(header => {
                    const cellValue = toHankaku(row[header] || '').toLowerCase();
                    const filterValue = columnFilters[header] || '';
                    
                    if (!filterValue) {
                        return true;
                    }
                    
                    return cellValue.includes(filterValue);
                });
            });
            
            displayResults(filteredResults);
        }

        // çµæœã‚’è¡¨ç¤º
        function displayResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `<p class="no-results">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«è©²å½“ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>`;
                return;
            }
            
            let html = `<p class="result-count">ğŸ¯ è¡¨ç¤ºä»¶æ•°: <strong>${results.length}ä»¶</strong> / æ¤œç´¢çµæœ: <strong>${currentResults.length}ä»¶</strong></p>`;
            html += '<table class="results-table"><thead><tr>';
            
            selectedHeaders.forEach(h => {
                html += `<th>${h}<span class="filter-icon">ğŸ”½</span></th>`;
            });
            html += '</tr></thead><tbody>';
            
            results.forEach(row => {
                html += '<tr>';
                selectedHeaders.forEach(h => {
                    let cellValue = row[h] || '';
                    const hankakuValue = toHankaku(cellValue);
                    
                    const selectedCheckboxes = document.querySelectorAll('input[name="header"]:checked');
                    selectedCheckboxes.forEach(checkbox => {
                        const header = checkbox.value;
                        if (h === header) {
                            const convertedKeyword = keywordInputs[header].dataset.convertedValue;
                            if (convertedKeyword) {
                                const regex = new RegExp(`(${convertedKeyword})`, 'gi');
                                cellValue = hankakuValue.replace(regex, '<span class="highlight">$1</span>');
                            } else {
                                cellValue = hankakuValue;
                            }
                        }
                    });
                    
                    html += `<td>${cellValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            resultsContainer.innerHTML = html;
        }
        
        // æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
        function performSearch() {
            const errorDiv = document.getElementById('searchError');
            const resultsContainer = document.getElementById('resultsContainer');
            
            errorDiv.style.display = 'none';
            
            if (!mergedData) {
                errorDiv.textContent = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„';
                errorDiv.style.display = 'block';
                return;
            }
            
            const selectedCheckboxes = document.querySelectorAll('input[name="header"]:checked');
            if (selectedCheckboxes.length === 0) {
                errorDiv.textContent = 'âŒ æ¤œç´¢å¯¾è±¡ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„';
                errorDiv.style.display = 'block';
                return;
            }
            
            selectedHeaders = Array.from(selectedCheckboxes).map(cb => cb.value);
            const searchConditions = {};
            let hasAnyKeyword = false;
            
            selectedCheckboxes.forEach(checkbox => {
                const header = checkbox.value;
                const convertedKeyword = keywordInputs[header].dataset.convertedValue;
                searchConditions[header] = convertedKeyword;
                if (convertedKeyword) {
                    hasAnyKeyword = true;
                }
            });
            
            if (!hasAnyKeyword) {
                errorDiv.textContent = 'âŒ å°‘ãªãã¨ã‚‚1ã¤ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºç™½ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ï¼‰';
                errorDiv.style.display = 'block';
                return;
            }
            
            currentResults = mergedData.filter(row => {
                return Object.entries(searchConditions).every(([header, keyword]) => {
                    const cellValue = toHankaku(row[header] || '').toLowerCase();
                    
                    if (!keyword) {
                        return true;
                    }
                    
                    return cellValue.includes(keyword);
                });
            });
            
            if (currentResults.length === 0) {
                resultsContainer.innerHTML = `<p class="no-results">æ¤œç´¢æ¡ä»¶ã«è©²å½“ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>`;
                document.getElementById('filterSection').style.display = 'none';
                return;
            }
            
            createFilterRow();
            displayResults(currentResults);
        }

        // ãƒšãƒ¼ã‚¸HTMLã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‹å°åˆ·ã§å…±é€šï¼‰
        function generatePageHTML(pageResults, pageNum, totalPages, filteredCount) {
            let html = `
                <div class="print-header">
                    <h1>ğŸŒ¾ è¾²è–¬æ¤œç´¢çµæœ</h1>
                    <p>æ¤œç´¢å®Ÿè¡Œæ—¥ï¼š${new Date().toLocaleDateString('ja-JP')}</p>
                </div>
                <div class="print-info">
                    <strong>ãƒšãƒ¼ã‚¸ ${pageNum} / ${totalPages}</strong><br>
                    è¡¨ç¤ºä»¶æ•°ï¼š${pageResults.length}ä»¶ / æ¤œç´¢çµæœï¼š${currentResults.length}ä»¶
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            ${selectedHeaders.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${pageResults.map(row => `
                            <tr>
                                ${selectedHeaders.map(h => `<td>${toHankaku(row[h] || '')}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            return html;
        }

        // å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showPrintPreview() {
            if (currentResults.length === 0) {
                alert('âš ï¸ è¡¨ç¤ºã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç¾åœ¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚Œã¦ã„ã‚‹çµæœã‚’å–å¾—
            const filteredResults = currentResults.filter(row => {
                return selectedHeaders.every(header => {
                    const cellValue = toHankaku(row[header] || '').toLowerCase();
                    const filterValue = columnFilters[header] || '';
                    
                    if (!filterValue) {
                        return true;
                    }
                    
                    return cellValue.includes(filterValue);
                });
            });

            if (filteredResults.length === 0) {
                alert('âš ï¸ è¡¨ç¤ºã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒšãƒ¼ã‚¸åˆ†å‰²ï¼ˆ1ãƒšãƒ¼ã‚¸30è¡Œï¼‰
            const rowsPerPage = 30;
            previewPages = [];
            printPages = [];

            for (let i = 0; i < filteredResults.length; i += rowsPerPage) {
                const pageResults = filteredResults.slice(i, i + rowsPerPage);
                const pageNum = Math.floor(i / rowsPerPage) + 1;
                const totalPages = Math.ceil(filteredResults.length / rowsPerPage);

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨
                let previewHTML = `<div class="preview-page">
                    ${generatePageHTML(pageResults, pageNum, totalPages, filteredResults.length)}
                </div>`;
                previewPages.push(previewHTML);

                // å°åˆ·ç”¨
                let printHTML = `<div class="print-page">
                    ${generatePageHTML(pageResults, pageNum, totalPages, filteredResults.length)}
                </div>`;
                printPages.push(printHTML);
            }

            // å°åˆ·ç”¨ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = printPages.join('');

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            currentPage = 0;
            showPreviewPage();
            document.getElementById('previewModal').classList.add('show');
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showPreviewPage() {
            const previewContainer = document.getElementById('previewContainer');
            const pageInfo = document.getElementById('pageInfo');

            previewContainer.innerHTML = previewPages[currentPage];
            pageInfo.textContent = `ãƒšãƒ¼ã‚¸ ${currentPage + 1}/${previewPages.length}`;
        }

        // å‰ã®ãƒšãƒ¼ã‚¸
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                showPreviewPage();
            }
        }

        // æ¬¡ã®ãƒšãƒ¼ã‚¸
        function nextPage() {
            if (currentPage < previewPages.length - 1) {
                currentPage++;
                showPreviewPage();
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
        }

        // å°åˆ·ã‚’å®Ÿè¡Œ
        function printNow() {
            window.print();
        }

        // ãƒšãƒ¼ã‚¸å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('previewModal');
            if (e.target === modal) {
                closePreview();
            }
        });
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initDragDrop();
            
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.matches('input[type="text"][placeholder*="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"]')) {
                    performSearch();
                }
            });
        });
    </script>
</body>
</html>