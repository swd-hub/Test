<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆé †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ï¼šç·åˆè¨ˆåŸºæº–ï¼‰</title>
<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; }
    h1 { font-size: 1.4rem; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    
    .container { 
        max-width: 1800px; 
        margin: 0 auto; 
        background: #fff; 
        padding: 20px; 
        border-radius: 8px; <!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆé †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ï¼šç·åˆè¨ˆåŸºæº–ï¼‰</title>
    
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; }
        h1 { font-size: 1.4rem; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }

        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }

        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-top h1 { margin: 0; flex: 1; min-width: 300px; } 

        #sourceButton {
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            white-space: nowrap;
        }
        #sourceButton:hover { background-color: #5a6268; }

        .input-area { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 12px; }

        .controls { margin-top: 15px; display: flex; gap: 15px; align-items: center; background: #eef; padding: 15px; border-radius: 5px; flex-wrap: wrap; }
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        input[type="number"] { width: 80px; }

        #errorMessage { color: red; font-weight: bold; margin-top: 10px; }

        .tables-container { 
            display: flex; 
            flex-direction: column; 
            gap: 30px; 
            overflow-x: auto; 
        }
        .gender-section h2 { background-color: #343a40; color: white; padding: 10px; margin: 0; font-size: 1.1rem; border-radius: 4px 4px 0 0; }

        table { 
            width: 100%; 
            min-width: 1000px; 
            border-collapse: collapse; 
            font-size: 13px; 
            background: white; 
        }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { 
            background-color: #f8f9fa; 
            color: #333; 
            font-weight: bold; 
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        th:hover { background-color: #e2e6ea; }
        th.sort-asc::after { content: " â–²"; color: #007bff; }
        th.sort-desc::after { content: " â–¼"; color: #007bff; }

        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f1f1f1; }

        .market-name-col { text-align: left; font-weight: bold; }
        .total-row { background-color: #e9ecef; font-weight: bold; }
        .total-row td { background-color: #e9ecef; }

        .score-value { font-weight: bold; font-size: 1.1em; }

        .score-rank-diff { font-weight: bold; }
        .rank-positive { color: #28a745; } 
        .rank-negative { color: #dc3545; } 
        .rank-zero { color: #6c757d; }

        .count-rank { font-weight: bold; color: #000; } 
        .score-note { font-size: 0.9rem; color: #666; margin-bottom: 10px; }

        .date-controls {
            display: flex;
            align-items: center;
            gap: 15px; 
            flex-wrap: wrap;
        }
    </style>
    
</head>
<body>

<div class="container">
    <div class="header-top">
        <h1>ğŸ“Š å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆé †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ï¼šç·åˆè¨ˆåŸºæº–ï¼‰</h1>
        <a id="sourceButton" href="https://www.alic.go.jp/operation/livestock/calf-report.html" target="_blank">è‚‰ç”¨å­ç‰›å–å¼•æƒ…å ±ã‚µã‚¤ãƒˆã¸</a>
    </div>
    
    <p class="score-note">
        â€» **çœŒåˆè¨ˆã®ãƒ‡ãƒ¼ã‚¿**ã¯é™¤å¤–ã—ã¦ã‚ã‚Šã¾ã™ã€‚<br>
        â€» **å–å¼•é ­æ•°**ã¯ã€**é ­æ•°ãŒå°‘ãªã„å¸‚å ´ãŒ1ä½**ã¨ãªã‚‹é †ä½ã‚’ãã®ã¾ã¾è¡¨ç¤ºã—ã¾ã™ã€‚<br>
        â€» **ãã®ä»–ï¼ˆä¾¡æ ¼ã€ä½“é‡ãªã©ï¼‰**ã¯ã€**æ•°å€¤ãŒå¤§ãã„å¸‚å ´ãŒ1ä½**ã¨ãªã‚‹é †ä½ã§è¨ˆç®—ã•ã‚Œã€**ç·åˆè¨ˆé †ä½ã¨ã®å·®åˆ†ï¼ˆé †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ï¼šç·åˆè¨ˆé †ä½ - å¸‚å ´é †ä½ï¼‰**ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆä¾‹: é †ä½å·®ãŒ**+3**ãªã‚‰ã€å¸‚å ´ã¯ç·åˆè¨ˆã‚ˆã‚Š**3ãƒ©ãƒ³ã‚¯è‰¯ã„**ã“ã¨ã‚’ç¤ºã—ã¾ã™ï¼‰
    </p>
    <div class="input-area">
        <textarea id="dataInput" placeholder="ã“ã“ã«Excelã‚„PDFã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
        <div class="controls">
            <div class="date-controls">
                <label>æŠ½å‡ºå¯¾è±¡æœˆ: <input type="number" id="targetMonth" placeholder="ä¾‹: 8"></label>
                <span id="transactionDateDisplay">å–å¼•æœˆ ä»¤å’Œ å¹´ æœˆ æ—¥ï½ä»¤å’Œ å¹´ æœˆ æ—¥</span>
            </div>
        </div>
        <div id="errorMessage"></div>
    </div>
    
    <pre id="pdDebugArea" style="background: #fffef0; border: 1px solid #f0c36d; padding: 8px; font-size: 12px; overflow: auto; margin-bottom: 20px; display: none;"></pre>

    <div id="resultArea" class="tables-container"></div>
</div>

<script>
// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å®šæ•° ---
window.parsedDataByGender = { 'é›„': [], 'é›Œ': [], 'è¨ˆ': [] };
window.marketMap = {};
window.sortState = {
    'é›„': { key: null, dir: 'asc' },
    'é›Œ': { key: null, dir: 'asc' },
    'è¨ˆ': { key: null, dir: 'asc' }
};

window.metricsMap = [
    { key: 'count', label: 'å–å¼•é ­æ•°', unit: 'é ­' },
    { key: 'price', label: 'å¹³å‡ä¾¡æ ¼', unit: 'å††' },
    { key: 'weight', label: 'å¹³å‡ä½“é‡', unit: 'kg' },
    { key: 'age', label: 'å¹³å‡æ—¥é½¢', unit: 'æ—¥' },
    { key: 'unitPrice', label: '1kgå˜ä¾¡', unit: 'å††' }
];

// --------------------------------------------------
// --- data-parser.js ã®å†…å®¹ (è§£æãƒ»ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£) ---
// --------------------------------------------------

function updateTransactionDateDisplay(text) {
    const lines = text.split('\n');
    let dateRange = '';
    
    for (const line of lines) {
        if (line.includes('å–å¼•æœˆ') && line.includes('ä»¤å’Œ')) {
            dateRange = line.trim();
            break;
        }
    }

    const transactionDateDiv = document.getElementById('transactionDateDisplay');
    if (transactionDateDiv) {
        transactionDateDiv.textContent = dateRange || 'ï¼ˆå–å¼•æœˆæƒ…å ±ãªã—ï¼‰';
    }
}

function extractPrefAndMarket(line) {
    const parts = line.split(/[\t,]/).map(p => p.trim());
    
    let prefecture = '';
    let market = '';
    
    // æœ€åˆã®æœ‰åŠ¹ãªéƒ¨åˆ†ãŒéƒ½é“åºœçœŒ
    if (parts[0]) {
        prefecture = parts[0];
    }
    
    // 2ç•ªç›®ã®æœ‰åŠ¹ãªéƒ¨åˆ†ãŒå¸‚å ´å
    if (parts.length > 1 && parts[1]) {
        market = parts[1].replace(/\*|-/g, '').trim();
    }
    
    // ç‰¹ä¾‹: ç·åˆè¨ˆè¡Œã®å‡¦ç†
    if (line.includes('ç·åˆè¨ˆ')) {
        prefecture = 'ç·åˆè¨ˆ';
        market = '';
    }

    return { prefecture, market };
}

function createMarketKey(prefecture, market) {
    if (prefecture === 'ç·åˆè¨ˆ') return 'ç·åˆè¨ˆ';
    return `${prefecture}_${market}`;
}

// ğŸ’¥ ä¿®æ­£ç®‡æ‰€ 1: isMarketHeaderLineã‚’å¼·åŒ–ã—ã€ã‚«ãƒ³ãƒåˆ†å‰²ã«å¯¾å¿œ ğŸ’¥
function isMarketHeaderLine(line) {
    if (line.includes("ãƒšãƒ¼ã‚¸") || line.includes("æœˆåˆ¥è‚‰ç”¨å­ç‰›å–å¼•çŠ¶æ³è¡¨") || line.includes("éƒ½é“åºœçœŒ") || line.includes("å“ç¨®ï¼š") || line.includes("åˆè¨ˆãƒ»å¹³å‡")) return false;
    const prefs = ["åŒ—æµ·é“", "é’æ£®", "å²©æ‰‹", "å®®åŸ", "ç§‹ç”°", "å±±å½¢", "ç¦å³¶", "èŒ¨åŸ", "æ ƒæœ¨", "ç¾¤é¦¬", "åŸ¼ç‰", "åƒè‘‰", "æ±äº¬", "ç¥å¥ˆå·", "æ–°æ½Ÿ", "å¯Œå±±", "çŸ³å·", "ç¦äº•", "å±±æ¢¨", "é•·é‡", "å²é˜œ", "é™å²¡", "æ„›çŸ¥", "ä¸‰é‡", "æ»‹è³€", "äº¬éƒ½", "å¤§é˜ª", "å…µåº«", "å¥ˆè‰¯", "å’Œæ­Œå±±", "é³¥å–", "å³¶æ ¹", "å²¡å±±", "åºƒå³¶", "å±±å£", "å¾³å³¶", "é¦™å·", "æ„›åª›", "é«˜çŸ¥", "ç¦å²¡", "ä½è³€", "é•·å´", "ç†Šæœ¬", "å¤§åˆ†", "å®®å´", "é¹¿å…å³¶", "æ²–ç¸„"];
    
    // 1. ã‚¿ãƒ–åˆ†å‰²ã‚’è©¦ã¿ã‚‹
    let parts = line.split(/\t/).map(p => p.trim());
    parts = parts.filter(p => p.length > 0); // ç©ºè¦ç´ ã‚’é™¤å¤–

    // 2. ã‚¿ãƒ–åˆ†å‰²ã§éƒ½é“åºœçœŒã¨å¸‚å ´åãŒåˆ†ã‹ã‚Œã¦ã„ãªã„å ´åˆï¼ˆparts.length < 2ï¼‰ã€ã‚«ãƒ³ãƒåˆ†å‰²ã‚’è©¦ã¿ã‚‹
    if (parts.length < 2 && line.includes(',')) {
        parts = line.split(/,/).map(p => p.trim());
        // æœ€åˆã®2ã¤ï¼ˆéƒ½é“åºœçœŒã¨å¸‚å ´åï¼‰ã ã‘ã‚’æŠ½å‡º
        parts = parts.slice(0, 2).filter(p => p.length > 0);
    }
    
    if (line.includes("ç·åˆè¨ˆ") && !line.includes("åˆè¨ˆãƒ»å¹³å‡")) return true;
    
    // éƒ½é“åºœçœŒåã¨å¸‚å ´åã®ä¸¡æ–¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const isPrefecture = prefs.some(p => parts[0] && parts[0].includes(p));
    const isMarket = parts[1] && (parts[1].includes('å¸‚å ´') || parts[1].includes('å®¶ç•œ'));

    // çœŒåˆè¨ˆã‚„é›†è¨ˆè¡Œã‚’é™¤å¤–
    if (line.includes("è¨ˆ") && !line.includes("å–å¼•é ­æ•°") && !line.includes("åˆè¨ˆãƒ»å¹³å‡")) return false; 
    
    return isPrefecture && isMarket;
}

// ğŸ’¥ ä¿®æ­£ç®‡æ‰€ 2: extractAndStoreã‚’èª¿æ•´ã—ã€1ãƒ¶æœˆã®ãšã‚Œã‚’ç¢ºå®Ÿã«è§£æ¶ˆ ğŸ’¥
// ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª marketMap ã«æ ¼ç´ã™ã‚‹
function extractAndStore(parts, dataStartIndexInLine, currentMarketKey, gender, metricKey) {
    if (!metricKey || !currentMarketKey) return;

    // æœ€çµ‚ä¿®æ­£: 1ãƒ¶æœˆã®ãšã‚Œã‚’ç¢ºå®Ÿã«è§£æ¶ˆã™ã‚‹ãŸã‚ã€
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆdataStartIndexInLineï¼‰ã‹ã‚‰1ã¤å·¦ã«ãšã‚ŒãŸåˆ—ã‚’å¼·åˆ¶çš„ã«å‚ç…§ã™ã‚‹ã€‚
    // â€»ãƒ‡ãƒ¼ã‚¿è¡Œã¯è¡Œé ­ã«å¸‚å ´åãªã©ã®ãƒ©ãƒ™ãƒ«ãŒå…¥ã‚‹ãŸã‚ã€æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Š1ã¤å·¦ã«ãšã‚Œã‚‹å‚¾å‘ã«ã‚ã‚‹ã€‚
    
    const correctDataIndex = dataStartIndexInLine - 1; 
    let value = null;

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒ0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰ã—ã€-1ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å„ªå…ˆã—ã¦è©¦ã™
    if (correctDataIndex >= 0 && correctDataIndex < parts.length) {
        value = parts[correctDataIndex];
    }
    
    // å€¤ãŒã¾ã è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼ˆä¾‹ãˆã°ã€ãƒ‡ãƒ¼ã‚¿è¡ŒãŒãƒ˜ãƒƒãƒ€ãƒ¼ã¨å®Œå…¨ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆï¼‰
    if (!value || value.trim() === '') {
        value = parts[dataStartIndexInLine];
    }
    
    if (value && value.trim() !== '') {
        const val = parseFloat(value.replace(/,/g, '').trim());
        if (!isNaN(val)) {
            if (!window.marketMap[currentMarketKey][gender]) {
                 window.marketMap[currentMarketKey][gender] = {};
            }
            window.marketMap[currentMarketKey][gender][metricKey] = val;
        }
    }
}


// --- ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

// main.js ã® processData å†…ã§ window.parsedDataByGender ãŒæ§‹ç¯‰ã•ã‚ŒãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã‚‹
function calculateScores() {
    ['é›„', 'é›Œ', 'è¨ˆ'].forEach(gender => {
        let data = window.parsedDataByGender[gender];
        if (!data || data.length === 0) return;

        const metrics = window.metricsMap;

        metrics.forEach(m => {
            const metricKey = m.key;
            
            // ç·åˆè¨ˆè¡Œã¨å¸‚å ´è¡Œã‚’åˆ†ã‘ã‚‹
            let totalRow = data.find(row => row.key === 'ç·åˆè¨ˆ');
            let marketRows = data.filter(row => row.key !== 'ç·åˆè¨ˆ' && row[metricKey] !== null && row[metricKey] !== 0);
            
            if (marketRows.length === 0) return;

            // å…¨ã¦ã®å€¤ã‚’æŠ½å‡º
            let allValues = marketRows
                .map(row => row[metricKey]);
            
            if (allValues.length === 0) return;

            // é †ä½ä»˜ã‘ã®åŸºæº–ã‚’è¨­å®š: å…¨ã¦é™é † (å€¤ãŒå¤§ãã„æ–¹ãŒè‰¯ã„)
            const sortDirection = -1; 
            
            // é †ä½ä»˜ã‘ã®ãŸã‚ã«ã‚½ãƒ¼ãƒˆï¼ˆå€¤ãŒåŒã˜ãªã‚‰åŒã˜é †ä½ã€æ¬¡ã®é †ä½ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰
            let sortedUniqueValues = [...new Set(allValues)].sort((a, b) => (a - b) * sortDirection);

            // å€¤ -> é †ä½ ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
            let valueToRankMap = {};
            sortedUniqueValues.forEach((val, index) => {
                valueToRankMap[val] = index + 1;
            });

            let totalRank = null;
            if (totalRow && totalRow[metricKey] !== null && totalRow[metricKey] !== 0) {
                const totalValue = totalRow[metricKey];
                
                // ç·åˆè¨ˆã®å€¤ã‚’å«ã‚€å…¨ã¦ã®å¸‚å ´ã®å€¤ã‚’ã‚½ãƒ¼ãƒˆ
                let allValuesIncludingTotal = [...allValues, totalValue];
                let sortedAllUniqueValues = [...new Set(allValuesIncludingTotal)].sort((a, b) => (a - b) * sortDirection);
                
                // ç·åˆè¨ˆã®é †ä½ã‚’æ±ºå®š (1ãƒ™ãƒ¼ã‚¹)
                totalRank = sortedAllUniqueValues.findIndex(val => val === totalValue) + 1;
            }


            // ã‚¹ã‚³ã‚¢ã®å‰²ã‚Šå½“ã¦
            marketRows.forEach(row => {
                const val = row[metricKey];
                row[`${metricKey}Score`] = null; 
                
                if (val !== null && val !== 0) {
                    const marketRank = valueToRankMap[val];
                    
                    if (marketRank) {
                        if (metricKey === 'count') {
                            // é ­æ•°: é †ä½ã‚’ãã®ã¾ã¾ã‚¹ã‚³ã‚¢ã¨ã—ã¦è¡¨ç¤º (é ­æ•°é †ä½)
                            // ğŸ’¥ ä¿®æ­£: é ­æ•°ã®ã¿ã€æ˜‡é † (å€¤ãŒå°ã•ã„æ–¹ãŒè‰¯ã„) ã§ã®é †ä½ã‚’åæ˜ 
                            const countSortDirection = 1; // æ˜‡é † (é ­æ•°ãŒå°‘ãªã„æ–¹ãŒé †ä½ãŒè‰¯ã„)
                            let countSortedUniqueValues = [...new Set(allValues)].sort((a, b) => (a - b) * countSortDirection);
                            let countValueToRankMap = {};
                            countSortedUniqueValues.forEach((val, index) => {
                                countValueToRankMap[val] = index + 1;
                            });
                            
                            row[`${metricKey}Score`] = countValueToRankMap[val];
                        } else {
                            // ä¾¡æ ¼ãªã©: é †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ (ç·åˆè¨ˆé †ä½ - å¸‚å ´é †ä½)
                            if (totalRank !== null) {
                                const rankDiff = totalRank - marketRank;
                                row[`${metricKey}Score`] = rankDiff;
                            }
                        }
                    }
                }
            });

            // ç·åˆè¨ˆè¡Œã®ã‚¹ã‚³ã‚¢
            if (totalRow) {
                if (metricKey === 'count') {
                    // ç·åˆè¨ˆã®é ­æ•°: å…ƒã®å€¤ã‚’è¡¨ç¤º
                    totalRow[`${metricKey}Score`] = totalRow[metricKey]; 
                } else {
                    // ä¾¡æ ¼ã€ä½“é‡ãªã©: ãƒã‚¤ãƒ•ãƒ³è¡¨ç¤º
                    totalRow[`${metricKey}Score`] = '-';
                }
            }
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
        window.parsedDataByGender[gender] = data;
    });
}


// --------------------------------------------------
// --- ui-renderer.js ã®å†…å®¹ (ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£) ---
// --------------------------------------------------

function formatScoreValue(score, key) { 
    if (score === undefined || score === null || score === '-') return `-`;
    
    if (key === 'count') {
        const num = Math.round(parseFloat(score));
        if (isNaN(num)) return score;
        
        // ç·åˆè¨ˆè¡Œã®é ­æ•°ã®å ´åˆã¯ã€é ­æ•°ã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹
        // é †ä½ãŒ12ä»¥ä¸‹ã§ãªã‘ã‚Œã°ã€ç·åˆè¨ˆè¡Œã§ã¯ãªã„å¸‚å ´ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é †ä½ã‚’è¡¨ç¤º
        if (score > 12 && score === Math.round(score)) { 
             return num.toLocaleString(); 
        }
        
        // å¸‚å ´è¡Œã®é ­æ•°ã®å ´åˆã¯é †ä½ã‚’è¡¨ç¤º
        return `<span class="count-rank">${num}</span>`;
    }
    
    // ä¾¡æ ¼ã€ä½“é‡ãªã©ã®é †ä½å·®åˆ†ã‚¹ã‚³ã‚¢
    const num = parseInt(score, 10);
    if (isNaN(num)) return score;
    
    const formatted = num > 0 ? `+${num}` : `${num}`;
    const scoreClass = num > 0 ? "rank-positive" : num < 0 ? "rank-negative" : "rank-zero";
    return `<span class="score-rank-diff ${scoreClass}">${formatted}</span>`;
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚½ãƒ¼ãƒˆå‡¦ç†
function sortTable(gender, key) { 
    const data = window.parsedDataByGender[gender].filter(row => row.key !== 'ç·åˆè¨ˆ');
    const totalRow = window.parsedDataByGender[gender].find(row => row.key === 'ç·åˆè¨ˆ');

    if (window.sortState[gender].key === key) {
        window.sortState[gender].dir = window.sortState[gender].dir === 'asc' ? 'desc' : 'asc';
    } else {
        window.sortState[gender].key = key;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚½ãƒ¼ãƒˆæ–¹å‘ã‚’è¨­å®š
        if (key === 'prefecture' || key === 'market' || key === 'count') {
            window.sortState[gender].dir = 'asc'; // é ­æ•° (é †ä½) ã¯ascãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        } else {
            window.sortState[gender].dir = 'desc'; // ä¾¡æ ¼ãªã© (é †ä½å·®åˆ†ã‚¹ã‚³ã‚¢) ã¯descãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
    }
    const dir = window.sortState[gender].dir;

    data.sort((a, b) => {
        if (key === 'prefecture' || key === 'market') {
            const comp = a[key].localeCompare(b[key], 'ja');
            return dir === 'asc' ? comp : -comp;
        }
        
        const sortKey = key === 'count' ? 'countScore' : `${key}Score`; 
        const valA = a[sortKey];
        const valB = b[sortKey];

        const isInvalidA = (valA === null || valA === undefined || valA === '-');
        const isInvalidB = (valB === null || valB === undefined || valB === '-');

        if (isInvalidA && isInvalidB) return 0;
        if (isInvalidA) return 1; 
        if (isInvalidB) return -1; 

        if (dir === 'asc') {
           return valA - valB;
        } else {
           return valB - valA;
        }
    });

    // ã‚½ãƒ¼ãƒˆå¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æˆ»ã™
    window.parsedDataByGender[gender] = totalRow ? [...data, totalRow] : data;
    renderTables();
}
window.sortTable = sortTable; // main.jsã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»å‡¦ç†
function renderTables() {
    const container = document.getElementById('resultArea');
    container.innerHTML = "";
    
    ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
        const data = window.parsedDataByGender[g];
        if (data.length === 0) return;

        const section = document.createElement('div');
        section.className = 'gender-section';
        
        let title = `ã€${g}ã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
        if (g === 'è¨ˆ') {
             const hasCountData = data.some(row => row.countScore !== null && row.countScore !== '-');
             const hasOtherData = data.some(row => window.metricsMap.filter(m => m.key !== 'count').some(m => row[`${m.key}Score`] !== null && row[`${m.key}Score`] !== '-'));
             
             if (hasCountData && hasOtherData) {
                 title = `ã€è¨ˆï¼ˆé ­æ•°ï¼‰/å¹³å‡ï¼ˆä¾¡æ ¼ãªã©ï¼‰ã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
             } else if (hasOtherData) {
                 title = `ã€å¹³å‡ã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
             } else if (hasCountData) {
                 title = `ã€è¨ˆã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
             }
        }
        
        let html = `<h2>${title}</h2>
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable('${g}', 'prefecture')" class="${window.sortState[g].key === 'prefecture' ? 'sort-' + window.sortState[g].dir : ''}">éƒ½é“åºœçœŒ</th>
                    <th onclick="sortTable('${g}', 'market')" class="${window.sortState[g].key === 'market' ? 'sort-' + window.sortState[g].dir : ''}">å¸‚å ´å</th>`;
        
        window.metricsMap.forEach(m => {
            let headerLabel;
            if (m.key === 'count') {
                headerLabel = `${m.label}<br>ï¼ˆé †ä½ï¼šå°‘ãŒ1ä½ï¼‰`;
                if (g === 'è¨ˆ') headerLabel = `å–å¼•é ­æ•°ï¼ˆè¨ˆï¼‰<br>ï¼ˆé †ä½ï¼šå°‘ãŒ1ä½ï¼‰`;
            } else {
                headerLabel = `${m.label}<br>ï¼ˆé †ä½å·®åˆ†ï¼šå¤§ãŒè‰¯ï¼‰`;
                if (g === 'è¨ˆ') headerLabel = `${m.label}ï¼ˆå¹³å‡ï¼‰<br>ï¼ˆé †ä½å·®åˆ†ï¼šå¤§ãŒè‰¯ï¼‰`;
            }

            const isSorted = window.sortState[g].key === m.key;
            const sortClass = isSorted ? 'sort-' + (window.sortState[g].key === m.key ? window.sortState[g].dir : '') : '';
            // HTMLå†…ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã¨ã—ã¦ sortTable ã‚’å‚ç…§
            html += `<th onclick="sortTable('${g}', '${m.key}')" class="${sortClass}">${headerLabel}</th>`;
        });
        html += `</tr></thead><tbody>`;
        
        data.forEach(row => {
            const isTotal = row.key === 'ç·åˆè¨ˆ';
            const rowClass = isTotal ? 'class="total-row"' : '';
            
            const prefDisplay = isTotal ? `<td class="market-name-col" colspan="2">ç·åˆè¨ˆ</td>` : 
                                          `<td class="market-name-col">${row.prefecture}</td><td class="market-name-col">${row.market}</td>`;
            
            html += `<tr ${rowClass}>${prefDisplay}`;
            
            window.metricsMap.forEach(m => {
                let displayValue;
                if (m.key === 'count' && isTotal) {
                     displayValue = (row.countScore !== null && row.countScore !== '-') ? Math.round(row.countScore).toLocaleString() : '-';
                } else {
                    displayValue = formatScoreValue(row[`${m.key}Score`], m.key);
                }
                
                html += `<td>${displayValue}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        section.innerHTML = html;
        container.appendChild(section);
    });
}


function updateTransactionDateDisplay_main(text) {
    const displayElement = document.getElementById('transactionDateDisplay');
    const regex = /å–å¼•æœˆ\s*(\S+)/; 
    const match = text.match(regex);
    if (match && match[1]) {
        const dateRange = match[1].replace(/\s/g, ''); 
        const dateRegex = /(ä»¤å’Œ)(\d{1,2})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥ï½(ä»¤å’Œ)(\d{1,2})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/;
        const dateMatch = dateRange.match(dateRegex);
        if (dateMatch) {
            const startYear = parseInt(dateMatch[2], 10);
            const startMonth = parseInt(dateMatch[3], 10);
            const startDay = parseInt(dateMatch[4], 10);
            const endYear = parseInt(dateMatch[6], 10);
            const endMonth = parseInt(dateMatch[7], 10);
            const endDay = parseInt(dateMatch[8], 10);
            displayElement.textContent = `å–å¼•æœˆ ä»¤å’Œ${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ï½ä»¤å’Œ${endYear}å¹´${endMonth}æœˆ${endDay}æ—¥`;
        } else {
            displayElement.textContent = `å–å¼•æœˆ ${dateRange}`;
        }
    } else {
        displayElement.textContent = 'å–å¼•æœˆ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
    }
}


// --------------------------------------------------
// --- main.js ã®å†…å®¹ (ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ»åˆæœŸåŒ–) ---
// --------------------------------------------------

// --- ãƒ˜ãƒƒãƒ€ãƒ¼è§£æãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
function getMonthHeaderIndices(lines) {
    let headerLineIndex = -1;

    for (let i = 0; i < lines.length; i++) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç‰¹å®šï¼ˆéƒ½é“åºœçœŒã€å¸‚å ´åã€æœˆã®ã™ã¹ã¦ã‚’å«ã‚€è¡Œï¼‰
        if (lines[i].includes('éƒ½é“åºœçœŒ') && lines[i].includes('å¸‚å ´å') && lines[i].includes('æœˆ')) {
            headerLineIndex = i;
            break;
        }
    }
    
    if (headerLineIndex === -1) return { headerLineIndex: -1, headerMonths: [] };

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¿ãƒ–ã¾ãŸã¯2ã¤ä»¥ä¸Šã®ç©ºç™½ã€ã‚«ãƒ³ãƒã§åˆ†å‰²
    let fullHeaderParts = lines[headerLineIndex].split(/\t/);
    if (fullHeaderParts.length <= 1) fullHeaderParts = lines[headerLineIndex].split(/\s{2,}/);
    if (fullHeaderParts.length <= 1) fullHeaderParts = lines[headerLineIndex].split(/,/);

    const headerMonths = [];

    // åˆ†å‰²ã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰æœˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŠ½å‡º
    for (let i = 0; i < fullHeaderParts.length; i++) {
        let part = fullHeaderParts[i]; // trimã—ãªã„
        if (!part) continue; // ç©ºè¦ç´ ã¯ã‚¹ã‚­ãƒƒãƒ—

        let trimmedPart = part.trim();
        
        // ã€Œåˆè¨ˆã€ã‚„ã€Œå¹³å‡ã€ãŒå«ã¾ã‚Œã‚‹åˆ—ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (trimmedPart.includes('åˆè¨ˆ') || trimmedPart.includes('å¹³å‡')) continue;

        // æœˆã®æ•°å­—ã‚’æŠ½å‡º
        trimmedPart = trimmedPart.replace(/ï¼ˆ.*?ï¼‰/g,'').replace(/\s+/g,'');
        const digits = trimmedPart.replace(/[^0-9ï¼-ï¼™]/g, '');
        const half = digits.replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
        const m = parseInt(half,10);

        // æ•°å­—ã§ã‚ã‚Šã€1ã€œ12ã®ç¯„å›²ã§ã€ã€Œæœˆã€ã§çµ‚ã‚ã‚‹ã€ã¾ãŸã¯æ•°å­—å˜ç‹¬ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        if (!isNaN(m) && m >= 1 && m <= 12 && (trimmedPart.endsWith('æœˆ') || trimmedPart === String(m))) {
            // index ã¯ fullHeaderParts ã«ãŠã‘ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            headerMonths.push({ month: m, index: i, text: fullHeaderParts[i] });
        }
    }
    
    return { headerLineIndex, headerMonths };
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ ---
function processData() {
    const rawInput = document.getElementById('dataInput').value;
    const targetMonthElement = document.getElementById('targetMonth');
    const targetMonth = targetMonthElement.value.trim();
    const errorDiv = document.getElementById('errorMessages') || document.getElementById('errorMessage'); // ã©ã¡ã‚‰ã‹ã®IDã«å¯¾å¿œ
    const resultDiv = document.getElementById('tablesContainer') || document.getElementById('resultArea'); // ã©ã¡ã‚‰ã‹ã®IDã«å¯¾å¿œ
    const dbg = document.getElementById('pdDebugArea');

    if (dbg) dbg.textContent = '';
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    if (errorDiv) errorDiv.textContent = "";
    if (resultDiv) resultDiv.innerHTML = "";
    
    // ãƒ‡ãƒ¼ã‚¿/ãƒãƒƒãƒ—/ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    window.parsedDataByGender = { 'é›„': [], 'é›Œ': [], 'è¨ˆ': [] };
    window.marketMap = {};
    
    // ğŸ’¥ ä¿®æ­£: å…¥åŠ›ãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–
    const monthNum = parseInt(targetMonth, 10);
    if (!rawInput.trim() || isNaN(monthNum) || monthNum < 1 || monthNum > 12) {
        if (errorDiv) errorDiv.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã€æŠ½å‡ºå¯¾è±¡æœˆï¼ˆ1ï½12ã®æ•°å€¤ï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå¾Œã€å¾Œç¶šã®å‡¦ç†ã‚’è¡Œã‚ãªã„
        if (!rawInput.trim()) return; 
    }

    // ğŸ’¥ ä¿®æ­£: è¡Œã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ processData ã®å†’é ­ã§ä¸€æ‹¬ã—ã¦è¡Œã†
    const lines = rawInput.split('\n')
                          .map(line => line.replace(/\r/g,'').trim()) // è¡Œã®é ­ã¨å°»å°¾ã®ç©ºç™½ã‚’ç¢ºå®Ÿã«å‰Šé™¤
                          .filter(line => line.length > 0);
    
    // å–å¼•æœˆæƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤ºã‚’æ›´æ–° (data-parser.jsã¾ãŸã¯ui-renderer.jsã®é–¢æ•°)
    if (typeof updateTransactionDateDisplay_main === 'function') {
        updateTransactionDateDisplay_main(rawInput); // ui-renderer.js ã®é–¢æ•°ã‚’ä½¿ç”¨
    }
    
    // 1. ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã®è§£æ
    const { headerLineIndex, headerMonths } = getMonthHeaderIndices(lines);

    if (headerLineIndex === -1) {
        if (errorDiv) errorDiv.textContent = "ã‚¨ãƒ©ãƒ¼: ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆéƒ½é“åºœçœŒ, å¸‚å ´å, æœˆã‚’å«ã‚€è¡Œï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ­£ã—ã„å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚";
        return;
    }

    // 2. å¯¾è±¡æœˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç‰¹å®š
    const matches = headerMonths.filter(h => h.month === monthNum);

    if (matches.length === 0) {
        if (errorDiv) errorDiv.textContent = `ã‚¨ãƒ©ãƒ¼: æŒ‡å®šã•ã‚ŒãŸæœˆï¼ˆ${monthNum}æœˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿åˆ—ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
        return;
    }

    // é€šå¸¸ã€æœ€å¾Œã®ãƒãƒƒãƒãŒå¯¾è±¡æœˆï¼ˆæœ€æ–°ã®åˆ—ï¼‰
    const dataStartIndexInLine = matches[matches.length - 1].index;
    if (dbg) dbg.textContent += `Chosen data column index for ${monthNum}æœˆ: ${dataStartIndexInLine}\n\n`;

    // 3. æœ¬ä½“è§£æ
    let currentMarketKey = null;
    let currentMetric = null;

    for (let i = headerLineIndex + 1; i < lines.length; i++) {
        const line = lines[i];

        // å†—é•·ãªè¡Œã®ã‚¹ã‚­ãƒƒãƒ— (data-parser.jsã®isMarketHeaderLineã¨é‡è¤‡ã™ã‚‹ãŒã€é«˜é€ŸåŒ–ã®ãŸã‚)
        if (line.includes("ãƒšãƒ¼ã‚¸ï¼š") || line.includes("ã€Š") || line.includes("å“ç¨®ï¼š") || line.includes("å–å¼•æœˆ") || line.includes("åˆè¨ˆãƒ»å¹³å‡")) continue;

        // ğŸ’¥ ä¿®æ­£: isMarketHeaderLineã¯data-parser.jsã®å¼·åŒ–ç‰ˆã‚’ä½¿ç”¨
        const isHeader = typeof isMarketHeaderLine === 'function' ? isMarketHeaderLine(line) : false;

        if (isHeader) {
            // ğŸ’¥ ä¿®æ­£: extractPrefAndMarketã¯data-parser.jsã®å¼·åŒ–ç‰ˆã‚’ä½¿ç”¨
            const names = typeof extractPrefAndMarket === 'function' ? extractPrefAndMarket(line) : {};
            const currentPrefName = names.prefecture;
            const currentMarketName = names.market;
            
            // çœŒåˆè¨ˆã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            if (currentMarketName === 'çœŒåˆè¨ˆ' || currentPrefName === 'ç·åˆè¨ˆ') {
                currentMarketKey = currentPrefName === 'ç·åˆè¨ˆ' ? 'ç·åˆè¨ˆ' : null; 
                if (currentMarketKey === 'ç·åˆè¨ˆ' && !window.marketMap[currentMarketKey]) {
                    window.marketMap[currentMarketKey] = { 'é›„': {}, 'é›Œ': {}, 'è¨ˆ': {} };
                }
                currentMetric = null;
                continue;
            }

            currentMarketKey = typeof createMarketKey === 'function' ? createMarketKey(currentPrefName, currentMarketName) : `${currentPrefName}_${currentMarketName}`;
            
            if (!window.marketMap[currentMarketKey]) window.marketMap[currentMarketKey] = { 'é›„': {}, 'é›Œ': {}, 'è¨ˆ': {} };
            currentMetric = null; 
            continue; 
        }

        if (!currentMarketKey) continue; 

        // 4. æŒ‡æ¨™åˆ¤å®šã¨ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        if (line.includes("å–å¼•é ­æ•°")) currentMetric = "count";
        else if (line.includes("å¹³å‡ä¾¡æ ¼")) currentMetric = "price";
        else if (line.includes("å¹³å‡ä½“é‡")) currentMetric = "weight";
        else if (line.includes("å¹³å‡æ—¥é½¢")) currentMetric = "age";
        else if (line.includes("ï¼‘ãå˜ä¾¡") || line.includes("1kgå˜ä¾¡")) currentMetric = "unitPrice";
        
        const isAverageLine = line.trim().startsWith('å¹³å‡');
        
        if (!currentMetric && !isAverageLine) continue;

        // ğŸ’¥ ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿è¡Œã®åˆ†å‰²ã‚’å …ç‰¢åŒ– (ã‚¿ãƒ–ã€è¤‡æ•°ã®ç©ºç™½ã€ã‚«ãƒ³ãƒã‚’è©¦ã™)
        let parts = line.split(/\t/);
        if (parts.length <= 1) parts = line.split(/\s{2,}/);
        if (parts.length <= 1) parts = line.split(/,/);
        
        const hasFemale = line.includes("é›Œ");
        const hasMale = line.includes("é›„");
        
        const isCountTotalLine = currentMetric === 'count' && (line.includes("è¨ˆ") || line.includes("åˆè¨ˆ")) && !line.includes("å¹³å‡");
        const isMetricTotalOrAverageLine = (currentMetric !== 'count' && (line.includes("è¨ˆ") || line.includes("å¹³å‡"))) || isAverageLine;

        // ğŸ’¥ ä¿®æ­£: extractAndStoreã¯data-parser.jsã®å¼·åŒ–ç‰ˆã‚’ä½¿ç”¨
        if (typeof extractAndStore === 'function') {
            if (hasFemale) extractAndStore(parts, dataStartIndexInLine, currentMarketKey, 'é›Œ', currentMetric);
            if (hasMale) extractAndStore(parts, dataStartIndexInLine, currentMarketKey, 'é›„', currentMetric);
            
            if (isCountTotalLine || isMetricTotalOrAverageLine) {
                let targetMetric = currentMetric;
                // 'å¹³å‡'è¡Œã®å ´åˆã€ç›´å‰ã®æŒ‡æ¨™ã‚’æ¨æ¸¬
                if (isAverageLine && !currentMetric) { 
                    for (let j = i - 1; j >= headerLineIndex; j--) {
                        if (lines[j].includes("å¹³å‡ä½“é‡")) { targetMetric = "weight"; break; }
                        if (lines[j].includes("å¹³å‡ä¾¡æ ¼")) { targetMetric = "price"; break; }
                        if (lines[j].includes("å¹³å‡æ—¥é½¢")) { targetMetric = "age"; break; }
                    }
                }

                if (targetMetric) extractAndStore(parts, dataStartIndexInLine, currentMarketKey, 'è¨ˆ', targetMetric);
            }
        }
    }

    // 5. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ•´å½¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    Object.keys(window.marketMap).forEach(mKey => {
        ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
            if (Object.keys(window.marketMap[mKey][g]).length === 0 && mKey !== 'ç·åˆè¨ˆ') return;
            
            // keyã‹ã‚‰éƒ½é“åºœçœŒã¨å¸‚å ´åã‚’å†æ§‹ç¯‰
            const nameParts = mKey === 'ç·åˆè¨ˆ' 
                ? { prefecture: 'ç·åˆè¨ˆ', market: '' } 
                : mKey.includes('_') ? { prefecture: mKey.split('_')[0], market: mKey.split('_')[1] } : { prefecture: '', market: '' };
            
            let obj = { 
                key: mKey,
                prefecture: nameParts.prefecture,
                market: nameParts.market, 
                genderName: g 
            };
            let hasData = false;
            window.metricsMap.forEach(m => {
                const v = window.marketMap[mKey][g]?.[m.key] ?? null;
                obj[m.key] = v !== undefined && v !== null ? v : null;
                obj[`${m.key}Score`] = null; 
                if (v !== undefined && v !== null && v !== 0) hasData = true;
            });

            if (hasData || mKey === 'ç·åˆè¨ˆ') {
                window.parsedDataByGender[g].push(obj);
            }
        });
    });

    // ãƒ‡ãƒ¼ã‚¿ã®ãªã„è¡Œã‚’æœ€çµ‚çš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
        window.parsedDataByGender[g] = 
            window.parsedDataByGender[g].filter(row => 
                row.key === 'ç·åˆè¨ˆ' || 
                window.metricsMap.some(m => row[m.key] !== null && row[m.key] !== 0)
            );
    });

    if (window.parsedDataByGender['è¨ˆ'].length === 0 && window.parsedDataByGender['é›„'].length === 0 && window.parsedDataByGender['é›Œ'].length === 0) {
        if (errorDiv) errorDiv.textContent = "æœ‰åŠ¹ãªå¸‚å ´ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
    }

    // 6. ã‚¹ã‚³ã‚¢è¨ˆç®—ã¨ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    if (typeof calculateScores === 'function') calculateScores(); 
    if (typeof renderTables === 'function') renderTables();
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
function handleDataInput() {
    // è²¼ã‚Šä»˜ã‘ã‚„æ‰‹å…¥åŠ›ãŒè¡Œã‚ã‚ŒãŸã‚‰ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    window.sortState = {
        'é›„': { key: null, dir: 'asc' },
        'é›Œ': { key: null, dir: 'asc' },
        'è¨ˆ': { key: null, dir: 'asc' }
    };
    processData();
}

function processDataFromControls() {
    processData(); 
}

// --- åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
window.onload = function() {
    const dataInput = document.getElementById('dataInput');
    const targetMonthElement = document.getElementById('targetMonth');
    const tablesContainer = document.getElementById('tablesContainer');
    const errorDiv = document.getElementById('errorMessages') || document.getElementById('errorMessage');

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    dataInput.addEventListener('input', handleDataInput);
    targetMonthElement.addEventListener('input', processDataFromControls);
    
    // 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
    const initialData = `			ã€Šæœˆåˆ¥è‚‰ç”¨å­ç‰›å–å¼•çŠ¶æ³è¡¨ï¼ˆå¸‚å ´åŒºåˆ†ï¼šå…¨å¸‚å ´ï¼‰ã€‹												
		å–å¼•æœˆã€€ä»¤å’Œ07å¹´01æœˆ01æ—¥ï½ä»¤å’Œ07å¹´12æœˆ31æ—¥ï¼Œæ—¥é½¢ã€€182ï½365												ãƒšãƒ¼ã‚¸ï¼š	1
å“ç¨®ï¼š	é»’æ¯›å’Œç¨®	ï¼Šï¼šæŒ‡å®šå¸‚å ´ã€€ï¼ï¼šéæŒ‡å®šå¸‚å ´													
éƒ½é“åºœçœŒ	å¸‚å ´å	12æœˆ	1æœˆ	2æœˆ	3æœˆ	4æœˆ	5æœˆ	6æœˆ	7æœˆ	8æœˆ	9æœˆ	10æœˆ	11æœˆ	12æœˆ	åˆè¨ˆãƒ»å¹³å‡
åŒ—æµ·é“	ãƒ›ã‚¯ãƒ¬ãƒ³å—åŒ—æµ·é“å®¶ç•œå¸‚å ´*														
	å–å¼•é ­æ•°ã€€ã€€ã€€ã€€ã€€é›Œ	785	563	676	625	688	718	690	681	597	604	585	601	0	7,028
	ï¼ˆé ­ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	944	805	902	789	940	1,060	929	812	794	881	842	865	0	9,619
	è¨ˆ	1,729	1,368	1,578	1,414	1,628	1,778	1,619	1,493	1,391	1,485	1,427	1,466	0	16,647
	å¹³å‡ä¾¡æ ¼ã€€ã€€ã€€ã€€ã€€é›Œ	476,069	525,605	547,652	580,108	677,015	629,563	595,819	646,333	664,295	609,425	633,152	674,834	0	617,306
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	600,128	656,085	683,328	722,827	805,909	745,047	747,471	777,784	778,781	751,776	753,167	793,066	0	747,367
	å¹³å‡	543,803	602,386	625,206	659,744	751,438	698,412	682,838	717,826	729,645	693,877	703,967	744,596	0	692,458
	å¹³å‡ä½“é‡ã€€ã€€ã€€ã€€ã€€é›Œ	312	316	314	311	317	317	318	314	311	314	314	320	0	315
	ï¼ˆKgï¼‰ã€€ã€€ã€€ã€€ã€€é›„	331	336	335	334	342	341	342	340	334	340	339	345	0	339
	å¹³å‡	322	328	326	324	331	332	331	328	324	330	329	335	0	329
	å¹³å‡æ—¥é½¢ã€€ã€€ã€€ã€€ã€€é›Œ	301	308	308	306	309	307	304	305	302	306	303	309	0	306
	ï¼ˆæ—¥ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	290	296	297	296	298	296	295	292	291	295	293	297	0	295
	å¹³å‡	295	301	302	301	303	300	299	298	295	299	297	302	0	300
	ï¼‘ãå˜ä¾¡ã€€ã€€ã€€ã€€ã€€é›Œ	1,526	1,661	1,747	1,864	2,139	1,983	1,876	2,059	2,137	1,939	2,014	2,110	0	1,959
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	1,813	1,953	2,038	2,165	2,355	2,183	2,189	2,285	2,331	2,211	2,220	2,298	0	2,203
	å¹³å‡	1,687	1,837	1,918	2,037	2,268	2,106	2,061	2,186	2,251	2,105	2,139	2,224	0	2,105
	å¸‚å ´æ•°	0	0	0	0	0	0	0	0	0	0	0	0	0	0
åŒ—æµ·é“	ãƒ›ã‚¯ãƒ¬ãƒ³åå‹åœ°åŒºå®¶ç•œå¸‚å ´*														
	å–å¼•é ­æ•°ã€€ã€€ã€€ã€€ã€€é›Œ	1,141	906	846	896	891	965	865	1,533	210	1,151	612	938	1,008	10,821
	ï¼ˆé ­ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	1,441	1,182	1,052	1,255	1,323	1,375	1,263	2,069	326	1,699	976	1,290	1,360	15,170
	è¨ˆ	2,582	2,088	1,898	2,151	2,214	2,340	2,128	3,602	536	2,850	1,588	2,228	2,368	25,991
	å¹³å‡ä¾¡æ ¼ã€€ã€€ã€€ã€€ã€€é›Œ	477,956	521,954	543,656	577,121	673,423	663,126	636,985	675,729	673,284	636,583	631,679	680,296	715,321	637,334
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	616,590	647,460	675,278	702,378	799,050	782,590	770,885	791,081	774,505	754,294	759,162	787,268	820,353	758,536
	å¹³å‡	555,327	593,002	616,610	650,202	748,493	733,323	716,457	741,987	734,847	706,755	710,031	742,232	775,644	708,075
	å¹³å‡ä½“é‡ã€€ã€€ã€€ã€€ã€€é›Œ	322	325	319	321	323	325	325	324	318	324	331	332	321	324
	ï¼ˆKgï¼‰ã€€ã€€ã€€ã€€ã€€é›„	341	342	337	338	344	346	347	347	340	351	356	355	344	346
	å¹³å‡	332	335	329	331	336	337	338	338	331	340	347	346	335	337
	å¹³å‡æ—¥é½¢ã€€ã€€ã€€ã€€ã€€é›Œ	299	302	305	302	307	303	302	299	299	300	300	302	297	302
	ï¼ˆæ—¥ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	288	294	297	292	293	290	292	290	289	293	294	294	288	292
	å¹³å‡	293	297	300	296	299	296	296	294	293	296	297	298	292	296
	ï¼‘ãå˜ä¾¡ã€€ã€€ã€€ã€€ã€€é›Œ	1,487	1,605	1,706	1,800	2,085	2,042	1,958	2,083	2,114	1,963	1,908	2,048	2,226	1,965
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	1,809	1,893	2,001	2,079	2,322	2,264	2,219	2,278	2,280	2,152	2,131	2,216	2,383	2,191
	å¹³å‡	1,671	1,772	1,874	1,967	2,230	2,176	2,117	2,198	2,217	2,079	2,049	2,148	2,319	2,101
	å¸‚å ´æ•°	0	0	0	0	0	0	0	0	0	0	0	0	0	0
åŒ—æµ·é“	ãƒ›ã‚¯ãƒ¬ãƒ³æ ¹å®¤åœ°åŒºå®¶ç•œå¸‚å ´*														
	å–å¼•é ­æ•°ã€€ã€€ã€€ã€€ã€€é›Œ	0	0	0	1	0	0	1	0	0	3	2	0	0	7
	ï¼ˆé ­ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	1	1	3	0	3	1	1	0	1	0	1	0	0	11
	è¨ˆ	1	1	3	1	3	1	2	0	1	3	3	0	0	18
	å¹³å‡ä¾¡æ ¼ã€€ã€€ã€€ã€€ã€€é›Œ	0	0	0	207,900	0	0	249,700	0	0	323,033	17,600	0	0	208,843
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	224,400	209,000	209,367	0	258,500	256,300	431,200	0	440,000	0	297,000	0	0	276,100
	å¹³å‡	224,400	209,000	209,367	207,900	258,500	256,300	340,450	0	440,000	323,033	110,733	0	0	249,944
	å¹³å‡ä½“é‡ã€€ã€€ã€€ã€€ã€€é›Œ	0	0	0	202	0	0	171	0	0	294	155	0	0	223
	ï¼ˆKgï¼‰ã€€ã€€ã€€ã€€ã€€é›„	287	225	247	0	197	407	326	0	294	0	266	0	0	259
	å¹³å‡	287	225	247	202	197	407	249	0	294	294	192	0	0	245
	å¹³å‡æ—¥é½¢ã€€ã€€ã€€ã€€ã€€é›Œ	0	0	0	313	0	0	192	0	0	351	252	0	0	295
	ï¼ˆæ—¥ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	349	361	310	0	240	333	335	0	326	0	192	0	0	290
	å¹³å‡	349	361	310	313	240	333	264	0	326	351	232	0	0	292
	ï¼‘ãå˜ä¾¡ã€€ã€€ã€€ã€€ã€€é›Œ	0	0	0	1,029	0	0	1,460	0	0	1,100	114	0	0	935
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	782	929	848	0	1,314	630	1,323	0	1,497	0	1,117	0	0	1,066
	å¹³å‡	782	929	848	1,029	1,314	630	1,370	0	1,497	1,100	577	0	0	1,019
	å¸‚å ´æ•°	0	0	0	0	0	0	0	0	0	0	0	0	0	0
`;


    dataInput.value = initialData;

    // ãƒ˜ãƒƒãƒ€ãƒ¼è§£æã‹ã‚‰æœ€æ–°æœˆã‚’å–å¾—ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    const lines = initialData.split('\n').map(line => line.replace(/\r/g,'').trim()).filter(line => line.length > 0);
    const { headerMonths } = getMonthHeaderIndices(lines);

    let defaultMonthToSet = 1;

    if (headerMonths.length > 0) {
        // æœ€çµ‚åˆ—ã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š (ã“ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯12æœˆ)
        // ğŸ’¥ ä¿®æ­£: åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ã¯æœ€æ–°ã®æœˆãŒ'12æœˆ'ãªã®ã§ã€ãã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        const latestMonthEntry = headerMonths.reduce((latest, current) => {
            if (current.index > latest.index) return current;
            return latest;
        }, { index: -1 });

        if (latestMonthEntry.index !== -1) {
            defaultMonthToSet = latestMonthEntry.month;
        } else {
             // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æœ€å¾Œã®æœ‰åŠ¹ãªæœˆã®æ•°å­—ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
             const allMonths = headerMonths.map(h => h.month);
             if(allMonths.length > 0) defaultMonthToSet = allMonths[allMonths.length - 1];
        }
    }
    
    targetMonthElement.value = defaultMonthToSet; 
    
    // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’å®Ÿè¡Œ
    processData();
};
</script>

</body>
</html>
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    
    .header-top { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    .header-top h1 { margin: 0; flex: 1; min-width: 300px; } 
    
    #sourceButton {
        padding: 10px 20px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        white-space: nowrap;
    }
    #sourceButton:hover { background-color: #5a6268; }
    
    .input-area { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 12px; }
    
    .controls { margin-top: 15px; display: flex; gap: 15px; align-items: center; background: #eef; padding: 15px; border-radius: 5px; flex-wrap: wrap; }
    input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input[type="number"] { width: 80px; }
    
    #errorMessage { color: red; font-weight: bold; margin-top: 10px; }
    
    .tables-container { 
        display: flex; 
        flex-direction: column; 
        gap: 30px; 
        overflow-x: auto; 
    }
    .gender-section h2 { background-color: #343a40; color: white; padding: 10px; margin: 0; font-size: 1.1rem; border-radius: 4px 4px 0 0; }
    
    table { 
        width: 100%; 
        min-width: 1000px; 
        border-collapse: collapse; 
        font-size: 13px; 
        background: white; 
    }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { 
        background-color: #f8f9fa; 
        color: #333; 
        font-weight: bold; 
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    th:hover { background-color: #e2e6ea; }
    th.sort-asc::after { content: " â–²"; color: #007bff; }
    th.sort-desc::after { content: " â–¼"; color: #007bff; }
    
    tr:nth-child(even) { background-color: #fcfcfc; }
    tr:hover { background-color: #f1f1f1; }
    
    .market-name-col { text-align: left; font-weight: bold; }
    .total-row { background-color: #e9ecef; font-weight: bold; }
    .total-row td { background-color: #e9ecef; }
    
    .score-value { font-weight: bold; font-size: 1.1em; }
    
    .score-rank-diff { font-weight: bold; }
    .rank-positive { color: #28a745; } 
    .rank-negative { color: #dc3545; } 
    .rank-zero { color: #6c757d; }
    
    .count-rank { font-weight: bold; color: #000; } 
    .score-note { font-size: 0.9rem; color: #666; margin-bottom: 10px; }

    .date-controls {
        display: flex;
        align-items: center;
        gap: 15px; 
        flex-wrap: wrap;
    }
</style>
</head>
<body>

<div class="container">
    <div class="header-top">
        <h1>ğŸ“Š å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆé †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ï¼šç·åˆè¨ˆåŸºæº–ï¼‰</h1>
        <a id="sourceButton" href="https://www.alic.go.jp/operation/livestock/calf-report.html" target="_blank">è‚‰ç”¨å­ç‰›å–å¼•æƒ…å ±ã‚µã‚¤ãƒˆã¸</a>
    </div>
    
    <p class="score-note">
        â€» **çœŒåˆè¨ˆã®ãƒ‡ãƒ¼ã‚¿**ã¯é™¤å¤–ã—ã¦ã‚ã‚Šã¾ã™ã€‚<br>
        â€» **å–å¼•é ­æ•°**ã¯ã€**é ­æ•°ãŒå°‘ãªã„å¸‚å ´ãŒ1ä½**ã¨ãªã‚‹é †ä½ã‚’ãã®ã¾ã¾è¡¨ç¤ºã—ã¾ã™ã€‚<br>
        â€» **ãã®ä»–ï¼ˆä¾¡æ ¼ã€ä½“é‡ãªã©ï¼‰**ã¯ã€**æ•°å€¤ãŒå¤§ãã„å¸‚å ´ãŒ1ä½**ã¨ãªã‚‹é †ä½ã§è¨ˆç®—ã•ã‚Œã€**ç·åˆè¨ˆé †ä½ã¨ã®å·®åˆ†ï¼ˆé †ä½å·®åˆ†ã‚¹ã‚³ã‚¢ï¼šç·åˆè¨ˆé †ä½ - å¸‚å ´é †ä½ï¼‰**ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆä¾‹: é †ä½å·®ãŒ**+3**ãªã‚‰ã€å¸‚å ´ã¯ç·åˆè¨ˆã‚ˆã‚Š**3ãƒ©ãƒ³ã‚¯è‰¯ã„**ã“ã¨ã‚’ç¤ºã—ã¾ã™ï¼‰
    </p>
    <div class="input-area">
        <textarea id="dataInput" placeholder="ã“ã“ã«Excelã‚„PDFã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." oninput="handleDataInput()"></textarea>
        <div class="controls">
            <div class="date-controls">
                <label>æŠ½å‡ºå¯¾è±¡æœˆ: <input type="number" id="targetMonth" placeholder="ä¾‹: 8" oninput="processDataFromControls()"></label>
                <span id="transactionDateDisplay">å–å¼•æœˆ ä»¤å’Œ å¹´ æœˆ æ—¥ï½ä»¤å’Œ å¹´ æœˆ æ—¥</span>
            </div>
        </div>
        <div id="errorMessage"></div>
    </div>

    <div id="resultArea" class="tables-container"></div>
</div>

<script>
let parsedDataByGender = { 'é›„': [], 'é›Œ': [], 'è¨ˆ': [] };
let marketMap = {};
let sortState = {
    'é›„': { key: null, dir: 'asc' },
    'é›Œ': { key: null, dir: 'asc' },
    'è¨ˆ': { key: null, dir: 'asc' }
};

const metricsMap = [
    { key: 'count', label: 'å–å¼•é ­æ•°', unit: 'é ­' },
    { key: 'price', label: 'å¹³å‡ä¾¡æ ¼', unit: 'å††' },
    { key: 'weight', label: 'å¹³å‡ä½“é‡', unit: 'kg' },
    { key: 'age', label: 'å¹³å‡æ—¥é½¢', unit: 'æ—¥' },
    { key: 'unitPrice', label: '1kgå˜ä¾¡', unit: 'å††' }
];

// --- ãƒ‡ãƒ¼ã‚¿è§£æãƒ»æŠ½å‡ºé–¢æ•° ---

function isMarketHeaderLine(line) {
    if (line.includes("ãƒšãƒ¼ã‚¸") || line.includes("æœˆåˆ¥è‚‰ç”¨å­ç‰›å–å¼•çŠ¶æ³è¡¨") || line.includes("éƒ½é“åºœçœŒ") || line.includes("å“ç¨®ï¼š") || line.includes("åˆè¨ˆãƒ»å¹³å‡")) return false;
    const prefs = ["åŒ—æµ·é“", "é’æ£®", "å²©æ‰‹", "å®®åŸ", "ç§‹ç”°", "å±±å½¢", "ç¦å³¶", "èŒ¨åŸ", "æ ƒæœ¨", "ç¾¤é¦¬", "åŸ¼ç‰", "åƒè‘‰", "æ±äº¬", "ç¥å¥ˆå·", "æ–°æ½Ÿ", "å¯Œå±±", "çŸ³å·", "ç¦äº•", "å±±æ¢¨", "é•·é‡", "å²é˜œ", "é™å²¡", "æ„›çŸ¥", "ä¸‰é‡", "æ»‹è³€", "äº¬éƒ½", "å¤§é˜ª", "å…µåº«", "å¥ˆè‰¯", "å’Œæ­Œå±±", "é³¥å–", "å³¶æ ¹", "å²¡å±±", "åºƒå³¶", "å±±å£", "å¾³å³¶", "é¦™å·", "æ„›åª›", "é«˜çŸ¥", "ç¦å²¡", "ä½è³€", "é•·å´", "ç†Šæœ¬", "å¤§åˆ†", "å®®å´", "é¹¿å…å³¶", "æ²–ç¸„"];
    
    const parts = line.split(/\t/).map(p => p.trim()).filter(p => p.length > 0);
    
    if (line.includes("ç·åˆè¨ˆ") && !line.includes("åˆè¨ˆãƒ»å¹³å‡")) return true;
    
    if (parts.length > 0) {
        const firstPart = parts[0];
        if (prefs.some(p => firstPart === p || (firstPart.length > 2 && firstPart.includes(p.substring(0, 2))))) {
            return true;
        }
    }
    return false;
}

function extractPrefAndMarket(line) {
    const parts = line.split(/\t/).map(p => p.trim()).filter(p => p.length > 0);
    
    if (line.includes("ç·åˆè¨ˆ")) {
         return { prefecture: 'ç·åˆè¨ˆ', market: 'ç·åˆè¨ˆ' };
    }

    if (parts.length < 1) {
        return { prefecture: '', market: '' }; 
    }

    const prefecture = parts[0].replace(/ï¼Š|\*|ï¼|-/g, "").trim();
    let market = '';
    
    if (parts.length > 1) {
        market = parts[1].replace(/ï¼Š|\*|ï¼|-/g, "").trim();
    }
    
    if (market.includes("çœŒåˆè¨ˆ")) {
        return { prefecture: prefecture, market: 'çœŒåˆè¨ˆ' };
    }
    
    if (!market && prefecture !== 'ç·åˆè¨ˆ') {
        market = prefecture;
    }
    
    return { prefecture: prefecture, market: market };
}


function createMarketKey(pref, market) {
    if (pref === 'ç·åˆè¨ˆ') return 'ç·åˆè¨ˆ';
    return `${pref}_${market}`;
}

function extractAndStore(lineParts, dataStartIndexInLine, marketName, gender, metricKey) {
    // dataStartIndexInLine ã¯ç¢ºå®šã—ãŸæœˆãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    const raw = lineParts[dataStartIndexInLine]; 
    if (raw === undefined || raw === null) {
        return;
    }
    
    let cleaned = raw.replace(/,/g, '').replace(/[N\/A\*ï¼-]/g, '').trim(); 
    if (cleaned === '') {
        // ç©ºç™½ã€N/A, - ã®å ´åˆã¯æ ¼ç´ã—ãªã„
        return;
    }
    const num = parseFloat(cleaned);
    if (!isNaN(num)) {
        if (!marketMap[marketName][gender]) marketMap[marketName][gender] = {};
        marketMap[marketName][gender][metricKey] = num;
    }
}

function updateTransactionDateDisplay(text) {
    const displayElement = document.getElementById('transactionDateDisplay');
    const regex = /å–å¼•æœˆ\s*(\S+)/; 
    const match = text.match(regex);
    if (match && match[1]) {
        const dateRange = match[1].replace(/\s/g, ''); 
        const dateRegex = /(ä»¤å’Œ)(\d{1,2})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥ï½(ä»¤å’Œ)(\d{1,2})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/;
        const dateMatch = dateRange.match(dateRegex);
        if (dateMatch) {
            const startYear = parseInt(dateMatch[2], 10);
            const startMonth = parseInt(dateMatch[3], 10);
            const startDay = parseInt(dateMatch[4], 10);
            const endYear = parseInt(dateMatch[6], 10);
            const endMonth = parseInt(dateMatch[7], 10);
            const endDay = parseInt(dateMatch[8], 10);
            displayElement.textContent = `å–å¼•æœˆ ä»¤å’Œ${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ï½ä»¤å’Œ${endYear}å¹´${endMonth}æœˆ${endDay}æ—¥`;
        } else {
            displayElement.textContent = `å–å¼•æœˆ ${dateRange}`;
        }
    } else {
        displayElement.textContent = 'å–å¼•æœˆ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
    }
}


function processData() {
    const text = document.getElementById('dataInput').value;
    const targetMonthElement = document.getElementById('targetMonth');
    const targetMonth = targetMonthElement.value.trim(); 
    const errorDiv = document.getElementById('errorMessage');
    const resultDiv = document.getElementById('resultArea');
    
    errorDiv.textContent = "";
    resultDiv.innerHTML = "";
    parsedDataByGender = { 'é›„': [], 'é›Œ': [], 'è¨ˆ': [] };
    marketMap = {};
    
    updateTransactionDateDisplay(text);
    
    const monthNum = parseInt(targetMonth, 10);
    if (!text || isNaN(monthNum) || monthNum < 1 || monthNum > 12) { 
        errorDiv.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã€æŠ½å‡ºå¯¾è±¡æœˆï¼ˆ1ï½12ã®æ•°å€¤ï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
    }

    const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    
    let headerLineIndex = -1;

    for (let i = 0; i < lines.length; i++) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç‰¹å®š
        if (lines[i].includes('éƒ½é“åºœçœŒ') && lines[i].includes('å¸‚å ´å') && lines[i].includes('æœˆ')) {
            headerLineIndex = i;
            break;
        }
    }

    if (headerLineIndex === -1) {
        errorDiv.textContent = "ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆéƒ½é“åºœçœŒ, å¸‚å ´å, æœˆã‚’å«ã‚€è¡Œï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
        return;
    }

    // --- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€æ–°æœˆã‚’æœ€å³ç«¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ã€ãã®ä»–ã‚’å·¦å´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰é¸æŠï¼‰ ---
    const targetDataMonth = monthNum; 

    // ã‚¿ãƒ–ã§åˆ†å‰²ã™ã‚‹éš›ã«ã€é€£ç¶šã™ã‚‹ã‚¿ãƒ–ã‚„ç©ºç™½ã‚’è€ƒæ…®ã—ã€æ­£ç¢ºã«åˆ—ã‚’åˆ†å‰²
    const fullHeaderParts = lines[headerLineIndex].split(/\t/);
    
    let dataStartIndexInLine = -1;
    
    // 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã®æœˆåˆ—ã®å¯¾å¿œé–¢ä¿‚ã‚’æŠŠæ¡ã—ã€æœ€æ–°æœˆã‚’è¦‹ã¤ã‘ã‚‹
    const monthIndices = []; // { index: I, month: M } ã®é…åˆ—
    let latestMonthValue = -1;
    let latestMonthIndex = -1; // æœ€ã‚‚å³å´ã«ã‚ã‚‹æœˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

    for (let i = 0; i < fullHeaderParts.length; i++) {
        const part = fullHeaderParts[i].trim(); 
        
        // **Index 15ï¼ˆåˆè¨ˆãƒ»å¹³å‡ï¼‰ã®é™¤å¤–**
        if (part.includes("åˆè¨ˆãƒ»å¹³å‡")) {
             continue;
        }

        const monthPart = part.replace(/æœˆ/g, ''); 
        const monthValue = parseInt(monthPart, 10);
        
        // æœˆã®åˆ—ï¼ˆ1ï½12ï¼‰ã‚’ã™ã¹ã¦è¨˜éŒ²
        if (!isNaN(monthValue) && monthValue >= 1 && monthValue <= 12) {
            monthIndices.push({ index: i, month: monthValue });
            
            // æœ€ã‚‚å³å´ã®æœˆã‚’å¸¸ã«æ›´æ–°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®ç‰©ç†çš„ãªä½ç½®ã§åˆ¤æ–­ï¼‰
            if (i > latestMonthIndex) {
                 latestMonthIndex = i;
                 latestMonthValue = monthValue;
            }
        }
    }

    if (monthIndices.length === 0) {
         errorDiv.textContent = "ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‹ã‚‰æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
         return;
    }
    
    // 2. æŒ‡å®šæœˆãŒæœ€æ–°æœˆï¼ˆæœ€å³ç«¯ã®åˆ—ï¼‰ã‹ã€ãã‚Œä»¥å¤–ã®æœˆã‹ã‚’åˆ¤å®š
    const targetMonthMatches = monthIndices
        .filter(item => item.month === targetDataMonth)
        .sort((a, b) => a.index - b.index); // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ˜‡é †ã§ã‚½ãƒ¼ãƒˆ (å¤ã„æœˆãŒå…ˆé ­)

    if (targetMonthMatches.length === 0) {
        errorDiv.textContent = `å¯¾è±¡æœˆï¼ˆ${monthNum}æœˆï¼‰ã«å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`;
        return;
    } 
    
    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯:
    if (targetDataMonth === latestMonthValue && latestMonthIndex !== -1) {
        // **å…¥åŠ›ã•ã‚ŒãŸæœˆãŒæœ€æ–°æœˆï¼ˆ12æœˆãªã©ï¼‰ã¨ä¸€è‡´ã™ã‚‹å ´åˆ**
        // -> æœ€ã‚‚å³å´ï¼ˆæœ€æ–°ï¼‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (Index 14) ã‚’æ¡ç”¨
        dataStartIndexInLine = latestMonthIndex; 
    } else {
        // ãã‚Œä»¥å¤–ã®ã™ã¹ã¦ã®å ´åˆï¼ˆ11æœˆãªã©ã€æœ€æ–°æœˆã§ã¯ãªã„æœˆã‚’å…¥åŠ›ã—ãŸå ´åˆï¼‰
        // -> å€™è£œãƒªã‚¹ãƒˆï¼ˆtargetMonthMatchesï¼‰ã®ä¸­ã§æœ€ã‚‚å·¦å´ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ€å°ï¼‰ã®ã‚‚ã®ã‚’æ¡ç”¨
        // ã“ã‚Œã«ã‚ˆã‚Šã€11æœˆãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€Index 13ãŒé¸ã°ã‚Œã€é‡è¤‡ã™ã‚‹12æœˆãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã¯Index 2ãŒé¸ã°ã‚Œã‚‹ï¼ˆæœ€æ–°ã®12æœˆã§ã¯ãªã„ãŸã‚ï¼‰ã€‚
        dataStartIndexInLine = targetMonthMatches[0].index;
    }
    
    // --- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯çµ‚äº† ---
    
    // ãƒ‡ãƒ¼ã‚¿è§£ææœ¬ä½“
    let currentMarketKey = null;
    let currentMetric = null;

    for (let i = headerLineIndex + 1; i < lines.length; i++) {
        const line = lines[i];
        
        if (line.includes("ãƒšãƒ¼ã‚¸ï¼š") || line.includes("ã€Š") || line.includes("å“ç¨®ï¼š") || line.includes("å–å¼•æœˆ") || line.includes("åˆè¨ˆãƒ»å¹³å‡")) continue;

        const names = extractPrefAndMarket(line);
        const currentPrefName = names.prefecture;
        const currentMarketName = names.market;
        
        const isMarketHeader = isMarketHeaderLine(line);

        if (isMarketHeader) {
             currentMarketKey = createMarketKey(currentPrefName, currentMarketName);
            
            if (currentMarketName === 'çœŒåˆè¨ˆ') {
                 currentMarketKey = null; 
                 continue;
            }

            if (!marketMap[currentMarketKey]) {
                marketMap[currentMarketKey] = { 'é›„': {}, 'é›Œ': {}, 'è¨ˆ': {} };
            }
            currentMetric = null; 
        }

        if (!currentMarketKey) continue; 
        
        // æŒ‡æ¨™è¡Œã®ç‰¹å®š
        if (line.includes("å–å¼•é ­æ•°")) { currentMetric = "count"; }
        else if (line.includes("å¹³å‡ä¾¡æ ¼")) { currentMetric = "price"; }
        else if (line.includes("å¹³å‡ä½“é‡")) { currentMetric = "weight"; }
        else if (line.includes("å¹³å‡æ—¥é½¢")) { currentMetric = "age"; }
        else if (line.includes("ï¼‘ãå˜ä¾¡") || line.includes("1kgå˜ä¾¡")) { currentMetric = "unitPrice"; }
        
        const isAverageLine = line.trim().startsWith('å¹³å‡');
        
        if (!currentMetric && !isAverageLine) continue;

        const lineParts = line.split(/\t/); 
        
        const hasFemale = line.includes("é›Œ");
        const hasMale = line.includes("é›„");
        
        const isCountTotalLine = currentMetric === 'count' && (line.includes("è¨ˆ") || line.includes("åˆè¨ˆ")) && !line.includes("å¹³å‡ä¾¡æ ¼") && !line.includes("å¹³å‡ä½“é‡") && !line.includes("å¹³å‡æ—¥é½¢");
        
        const isMetricTotalOrAverageLine = (currentMetric !== 'count' && (line.includes("è¨ˆ") || line.includes("å¹³å‡")) && !line.includes("å¹³å‡ä¾¡æ ¼") && !line.includes("å¹³å‡ä½“é‡") && !line.includes("å¹³å‡æ—¥é½¢")) || isAverageLine;


        if (hasFemale) {
            extractAndStore(lineParts, dataStartIndexInLine, currentMarketKey, 'é›Œ', currentMetric);
        }
        if (hasMale) {
            extractAndStore(lineParts, dataStartIndexInLine, currentMarketKey, 'é›„', currentMetric);
        }
        if (isCountTotalLine || isMetricTotalOrAverageLine) {
            let targetMetric = currentMetric;
            if (isAverageLine && !currentMetric) {
                for (let j = i - 1; j >= headerLineIndex; j--) {
                    if (lines[j].includes("å¹³å‡ä½“é‡")) { targetMetric = "weight"; break; }
                    if (lines[j].includes("å¹³å‡ä¾¡æ ¼")) { targetMetric = "price"; break; }
                    if (lines[j].includes("å¹³å‡æ—¥é½¢")) { targetMetric = "age"; break; }
                }
            }

            if (targetMetric) {
                extractAndStore(lineParts, dataStartIndexInLine, currentMarketKey, 'è¨ˆ', targetMetric);
            }
        }
    }
    
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ•´å½¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    Object.keys(marketMap).forEach(mKey => {
        ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
            if (Object.keys(marketMap[mKey][g]).length === 0 && mKey !== 'ç·åˆè¨ˆ') return;
            
            const nameParts = mKey === 'ç·åˆè¨ˆ' ? { prefecture: 'ç·åˆè¨ˆ', market: '' } : extractPrefAndMarket(mKey.replace('_', '\t'));
            
            let obj = { 
                key: mKey,
                prefecture: nameParts.prefecture,
                market: nameParts.market, 
                genderName: g 
            };
            let hasData = false;
            metricsMap.forEach(m => {
                const v = marketMap[mKey][g] ? marketMap[mKey][g][m.key] : null;
                obj[m.key] = v !== undefined && v !== null ? v : null;
                obj[`${m.key}Score`] = null; 
                if (v !== undefined && v !== null && v !== 0) hasData = true;
            });

            if (hasData || mKey === 'ç·åˆè¨ˆ') {
                parsedDataByGender[g].push(obj);
            }
        });
    });

    ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
        parsedDataByGender[g] = parsedDataByGender[g].filter(row => row.key === 'ç·åˆè¨ˆ' || metricsMap.some(m => row[m.key] !== null && row[m.key] !== 0));
    });


    if (parsedDataByGender['è¨ˆ'].length === 0 && parsedDataByGender['é›„'].length === 0 && parsedDataByGender['é›Œ'].length === 0) {
        errorDiv.textContent = "æœ‰åŠ¹ãªå¸‚å ´ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
    }

    calculateScores(); 
    renderTables();
}

function processDataFromControls() {
    processData(); 
}

function handleDataInput() {
    sortState = {
        'é›„': { key: null, dir: 'asc' },
        'é›Œ': { key: null, dir: 'asc' },
        'è¨ˆ': { key: null, dir: 'asc' }
    };
    processData();
}

function calculateScores() { 
    ['é›„', 'é›Œ', 'è¨ˆ'].forEach(gender => {
        const data = parsedDataByGender[gender];
        if (!data || data.length === 0) return;
        
        const totalRow = data.find(row => row.key === 'ç·åˆè¨ˆ');
        
        const marketRows = data.filter(row => row.key !== 'ç·åˆè¨ˆ'); 

        metricsMap.forEach(m => {
            const metricKey = m.key;
            
            const rankingCandidates = marketRows.filter(row => row[metricKey] !== null && row[metricKey] !== 0);

            let sortFunction;
            if (metricKey === 'count') {
                sortFunction = (a, b) => a - b; 
            } else {
                sortFunction = (a, b) => b - a; 
            }

            const validValues = rankingCandidates
                .map(r => r[metricKey])
                .sort(sortFunction); 
            
            const valueToRankMap = {};
            let currentRank = 1; 
            
            for (let i = 0; i < validValues.length; i++) {
                const val = validValues[i];
                if (valueToRankMap[val] === undefined) {
                    valueToRankMap[val] = currentRank;
                }
                
                if (i + 1 < validValues.length && validValues[i + 1] !== val) {
                    currentRank = i + 2; 
                } 
            }

            const totalValue = totalRow ? totalRow[metricKey] : null;
            let totalRank = null;

            if (totalValue !== null && totalValue !== 0) {
                 const allValuesIncludingTotal = [...validValues, totalValue]
                    .sort(sortFunction);

                 let tempRank = 1;
                 for (let i = 0; i < allValuesIncludingTotal.length; i++) {
                    const val = allValuesIncludingTotal[i];
                    
                    if (val === totalValue) {
                         totalRank = tempRank;
                         break;
                    }
                    if (i + 1 < allValuesIncludingTotal.length && allValuesIncludingTotal[i + 1] !== val) {
                        tempRank = i + 2; 
                    }
                 }
            }


            marketRows.forEach(row => {
                const val = row[metricKey];
                row[`${metricKey}Score`] = null; 
                
                if (val !== null && val !== 0) {
                    const marketRank = valueToRankMap[val];
                    
                    if (marketRank) {
                        if (metricKey === 'count') {
                            row[`${metricKey}Score`] = marketRank; 
                        } else {
                            if (totalRank !== null) {
                                const rankDiff = totalRank - marketRank;
                                row[`${metricKey}Score`] = rankDiff;
                            }
                        }
                    }
                }
            });

            if (totalRow) {
                 totalRow[`${metricKey}Score`] = '-';
            }
        });
    });
}

function formatScoreValue(score, key) { 
    if (score === undefined || score === null || score === '-') return `-`;
    
    if (key === 'count') {
        const num = Math.round(parseFloat(score));
        if (isNaN(num)) return score;
        return `<span class="count-rank">${num}</span>`;
    }
    
    const num = parseInt(score, 10);
    if (isNaN(num)) return score;
    
    const formatted = num > 0 ? `+${num}` : `${num}`;
    const scoreClass = num > 0 ? "rank-positive" : num < 0 ? "rank-negative" : "rank-zero";
    return `<span class="score-rank-diff ${scoreClass}">${formatted}</span>`;
}

function sortTable(gender, key) { 
    const data = parsedDataByGender[gender].filter(row => row.key !== 'ç·åˆè¨ˆ');
    const totalRow = parsedDataByGender[gender].find(row => row.key === 'ç·åˆè¨ˆ');

    if (sortState[gender].key === key) {
        sortState[gender].dir = sortState[gender].dir === 'asc' ? 'desc' : 'asc';
    } else {
        sortState[gender].key = key;
        
        if (key === 'prefecture' || key === 'market' || key === 'count') {
            sortState[gender].dir = 'asc'; 
        } else {
            sortState[gender].dir = 'desc'; 
        }
    }
    const dir = sortState[gender].dir;

    data.sort((a, b) => {
        if (key === 'prefecture' || key === 'market') {
            const comp = a[key].localeCompare(b[key], 'ja');
            return dir === 'asc' ? comp : -comp;
        }
        
        const sortKey = key === 'count' ? 'countScore' : `${key}Score`; 
        const valA = a[sortKey];
        const valB = b[sortKey];

        const isInvalidA = (valA === null || valA === undefined || valA === '-');
        const isInvalidB = (valB === null || valB === undefined || valB === '-');

        if (isInvalidA && isInvalidB) return 0;
        if (isInvalidA) return 1; 
        if (isInvalidB) return -1; 

        if (dir === 'asc') {
           return valA - valB;
        } else {
           return valB - valA;
        }
    });

    parsedDataByGender[gender] = totalRow ? [...data, totalRow] : data;
    renderTables();
}

function renderTables() {
    const container = document.getElementById('resultArea');
    container.innerHTML = "";
    
    ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
        const data = parsedDataByGender[g];
        if (data.length === 0) return;

        const section = document.createElement('div');
        section.className = 'gender-section';
        
        let title = `ã€${g}ã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
        if (g === 'è¨ˆ') {
             const hasCountData = data.some(row => row.countScore !== null && row.countScore !== '-');
             const hasOtherData = data.some(row => metricsMap.filter(m => m.key !== 'count').some(m => row[`${m.key}Score`] !== null && row[`${m.key}Score`] !== '-'));
             
             if (hasCountData && hasOtherData) {
                 title = `ã€è¨ˆï¼ˆé ­æ•°ï¼‰/å¹³å‡ï¼ˆä¾¡æ ¼ãªã©ï¼‰ã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
             } else if (hasOtherData) {
                 title = `ã€å¹³å‡ã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
             } else if (hasCountData) {
                 title = `ã€è¨ˆã€‘ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ä¸€è¦§`;
             }
        }
        
        let html = `<h2>${title}</h2>
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable('${g}', 'prefecture')" class="${sortState[g].key === 'prefecture' ? 'sort-' + sortState[g].dir : ''}">éƒ½é“åºœçœŒ</th>
                    <th onclick="sortTable('${g}', 'market')" class="${sortState[g].key === 'market' ? 'sort-' + sortState[g].dir : ''}">å¸‚å ´å</th>`;
        metricsMap.forEach(m => {
            let headerLabel;
            if (m.key === 'count') {
                headerLabel = `${m.label}<br>ï¼ˆé †ä½ï¼šå°‘ãŒ1ä½ï¼‰`;
                if (g === 'è¨ˆ') headerLabel = `å–å¼•é ­æ•°ï¼ˆè¨ˆï¼‰<br>ï¼ˆé †ä½ï¼šå°‘ãŒ1ä½ï¼‰`;
            } else {
                headerLabel = `${m.label}<br>ï¼ˆé †ä½å·®åˆ†ï¼šå¤§ãŒè‰¯ï¼‰`;
                if (g === 'è¨ˆ') headerLabel = `${m.label}ï¼ˆå¹³å‡ï¼‰<br>ï¼ˆé †ä½å·®åˆ†ï¼šå¤§ãŒè‰¯ï¼‰`;
            }

            const isSorted = sortState[g].key === m.key;
            const sortClass = isSorted ? 'sort-' + (sortState[g].key === m.key ? sortState[g].dir : '') : '';
            html += `<th onclick="sortTable('${g}', '${m.key}')" class="${sortClass}">${headerLabel}</th>`;
        });
        html += `</tr></thead><tbody>`;
        
        data.forEach(row => {
            const isTotal = row.key === 'ç·åˆè¨ˆ';
            const rowClass = isTotal ? 'class="total-row"' : '';
            
            const prefDisplay = isTotal ? `<td class="market-name-col" colspan="2">ç·åˆè¨ˆ</td>` : 
                                          `<td class="market-name-col">${row.prefecture}</td><td class="market-name-col">${row.market}</td>`;
            
            html += `<tr ${rowClass}>${prefDisplay}`;
            
            metricsMap.forEach(m => {
                const displayValue = formatScoreValue(row[`${m.key}Score`], m.key);
                html += `<td>${displayValue}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        section.innerHTML = html;
        container.appendChild(section);
    });
}


// --- åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
window.onload = function() {
    // 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœˆã‚’è¨­å®š
    const defaultMonth = 12; 
    
    const targetMonthElement = document.getElementById('targetMonth');
    targetMonthElement.value = defaultMonth;

    // 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¨­å®š (ãŠå®¢æ§˜ã‹ã‚‰æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨)
    const initialData = `			ã€Šæœˆåˆ¥è‚‰ç”¨å­ç‰›å–å¼•çŠ¶æ³è¡¨ï¼ˆå¸‚å ´åŒºåˆ†ï¼šå…¨å¸‚å ´ï¼‰ã€‹												
		å–å¼•æœˆã€€ä»¤å’Œ07å¹´01æœˆ01æ—¥ï½ä»¤å’Œ07å¹´12æœˆ31æ—¥ï¼Œæ—¥é½¢ã€€182ï½365												ãƒšãƒ¼ã‚¸ï¼š	1
å“ç¨®ï¼š	é»’æ¯›å’Œç¨®	ï¼Šï¼šæŒ‡å®šå¸‚å ´ã€€ï¼ï¼šéæŒ‡å®šå¸‚å ´													
éƒ½é“åºœçœŒ	å¸‚å ´å	12æœˆ	1æœˆ	2æœˆ	3æœˆ	4æœˆ	5æœˆ	6æœˆ	7æœˆ	8æœˆ	9æœˆ	10æœˆ	11æœˆ	12æœˆ	åˆè¨ˆãƒ»å¹³å‡
åŒ—æµ·é“	ãƒ›ã‚¯ãƒ¬ãƒ³å—åŒ—æµ·é“å®¶ç•œå¸‚å ´*														
	å–å¼•é ­æ•°ã€€ã€€ã€€ã€€ã€€é›Œ	785	563	676	625	688	718	690	681	597	604	585	601	0	7,028
	ï¼ˆé ­ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	944	805	902	789	940	1,060	929	812	794	881	842	865	0	9,619
	è¨ˆ	1,729	1,368	1,578	1,414	1,628	1,778	1,619	1,493	1,391	1,485	1,427	1,466	0	16,647
	å¹³å‡ä¾¡æ ¼ã€€ã€€ã€€ã€€ã€€é›Œ	476,069	525,605	547,652	580,108	677,015	629,563	595,819	646,333	664,295	609,425	633,152	674,834	0	617,306
	ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	600,128	656,085	683,328	722,827	805,909	745,047	747,471	777,784	778,781	751,776	753,167	793,066	0	747,367
	å¹³å‡	543,803	602,386	625,206	659,744	751,438	698,412	682,838	717,826	729,645	693,877	703,967	744,596	0	692,458
	å¹³å‡ä½“é‡ã€€ã€€ã€€ã€€ã€€é›Œ	312	316	314	311	317	317	318	314	311	314	314	320	0	315
	ï¼ˆKgï¼‰ã€€ã€€ã€€ã€€ã€€é›„	331	336	335	334	342	341	342	340	334	340	339	345	0	339
	å¹³å‡	322	328	326	324	331	332	331	328	324	330	329	335	0	329`;


    document.getElementById('dataInput').value = initialData;

    // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’å®Ÿè¡Œ
    processData();
};
</script>
</body>
</html>

