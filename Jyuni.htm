<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ« (é †ä½ãƒ»ç·åˆã‚¹ã‚³ã‚¢(æ•´æ•°)ãƒ»ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜)</title>
<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; }
    h1 { font-size: 1.4rem; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 10px;}
    .container { max-width: 1500px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    
    /* ãƒ‡ãƒ¼ã‚¿å…ƒãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ */
    #sourceLinkButton {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        z-index: 10;
        text-decoration: none;
    }
    #sourceLinkButton:hover { background-color: #1e7e34; }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-area { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 12px; resize: both; }
    
    .controls { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #eef; padding: 15px; border-radius: 5px; }
    input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    #targetMonth { width: 150px; text-align: center; }
    #linkInput { width: 300px; }
    button { padding: 10px 24px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; }
    button:hover { background-color: #0056b3; }

    #errorMessage { color: red; font-weight: bold; margin-top: 10px; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ */
    .tables-container { display: flex; flex-direction: column; gap: 30px; }
    .gender-section h2 { background-color: #343a40; color: white; padding: 10px; margin: 0; font-size: 1.1rem; border-radius: 4px 4px 0 0; }
    
    table { width: 100%; border-collapse: collapse; font-size: 13px; box-shadow: 0 2px 3px rgba(0,0,0,0.1); background: white; }
    th, td { border: 1px solid #ddd; padding: 8px 5px; text-align: center; }
    
    /* ã‚½ãƒ¼ãƒˆå¯èƒ½ãªãƒ˜ãƒƒãƒ€ãƒ¼ */
    th { background-color: #f8f9fa; color: #333; font-weight: bold; cursor: pointer; user-select: none; position: relative; }
    th:hover { background-color: #e2e6ea; }
    th.sort-asc::after { content: " â–²"; color: #007bff; font-size: 0.8em; }
    th.sort-desc::after { content: " â–¼"; color: #007bff; font-size: 0.8em; }
    
    tr:nth-child(even) { background-color: #fcfcfc; }
    tr:hover { background-color: #f1f1f1; }

    /* é †ä½ï¼ˆè©•ä¾¡ï¼‰ã®è‰²åˆ†ã‘ */
    .val-high { color: #0056b3; font-weight: bold; } /* å¹³å‡ã‚ˆã‚Šè‰¯ã„ï¼ˆé«˜ã„ï¼‰ */
    .val-low { color: #dc3545; font-weight: bold; }  /* å¹³å‡ã‚ˆã‚Šæ‚ªã„ï¼ˆä½ã„ï¼‰ */
    .val-avg { color: #28a745; font-weight: bold; }  /* å¹³å‡ */
    
    .market-name-col { text-align: left; min-width: 150px; font-weight: bold; }
    
    /* é †ä½ã‚»ãƒ«å†…è¨³ */
    .value-display { font-weight: normal; font-size: 1.0em; display: block; }
    .rank-display { font-size: 0.9em; font-weight: bold; display: block; margin-top: 2px; }
    .rank-1 { color: #ffc107; } /* 1ä½ */
    .rank-high { color: #007bff; } /* 2-5ä½ */
    .rank-normal { color: #6c757d; font-weight: normal; }
    
    /* ç·åˆã‚¹ã‚³ã‚¢ã‚»ãƒ« (æ•´æ•°) */
    .score-cell { font-size: 1.2em; font-weight: bold; }
    .score-positive { background-color: #d8f5d8; color: #28a745; } /* ç·‘ç³» */
    .score-negative { background-color: #f8d7da; color: #dc3545; }  /* èµ¤ç³» */
    .score-neutral { background-color: #e9ecef; color: #6c757d; }
</style>
</head>
<body>

<div class="container">
    <a id="sourceLinkButton" href="#" target="_blank" style="display:none;">ãƒ‡ãƒ¼ã‚¿å…ƒã¸</a>
    <h1>ğŸ“Š å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆé †ä½ãƒ»ç·åˆã‚¹ã‚³ã‚¢(æ•´æ•°)ä»˜ï¼‰</h1>
    
    <div class="input-area">
        <textarea id="dataInput" placeholder="Excelã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã”ã¨è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
        <div class="controls">
            <label>æŠ½å‡ºå¯¾è±¡æœˆ: <input type="text" id="targetMonth" value="8æœˆ" placeholder="ä¾‹: 8æœˆ"></label>
            <label>ãƒ‡ãƒ¼ã‚¿å…ƒURL: <input type="text" id="linkInput" value="https://example.com" placeholder="ãƒ‡ãƒ¼ã‚¿å…ƒã®URL"></label>
            <button onclick="processData()">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼†è¡¨ä½œæˆ</button>
        </div>
        <div id="errorMessage"></div>
    </div>

    <div id="resultArea" class="tables-container"></div>
</div>

<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šè§£æãƒ‡ãƒ¼ã‚¿ã¨ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ä¿æŒ
    let parsedDataByGender = { 'é›„': [], 'é›Œ': [], 'è¨ˆ': [] };
    let averages = {}; 
    let sortState = {
        'é›„': { key: 'totalRankScore', dir: 'desc' }, // åˆæœŸã‚½ãƒ¼ãƒˆã‚’ç·åˆã‚¹ã‚³ã‚¢ã«è¨­å®š
        'é›Œ': { key: 'totalRankScore', dir: 'desc' },
        'è¨ˆ': { key: 'totalRankScore', dir: 'desc' }
    };

    // é …ç›®å®šç¾©: reverseRank: true ã®å ´åˆã€æ•°å€¤ãŒå°ã•ã„æ–¹ãŒä¸Šä½ (æ—¥é½¢ãªã©)
    const metricsMap = [
        { key: 'count', label: 'å–å¼•é ­æ•°', unit: 'é ­', reverseRank: false, weight: 1 },
        { key: 'price', label: 'å¹³å‡ä¾¡æ ¼', unit: 'å††', reverseRank: false, weight: 2 },
        { key: 'weight', label: 'å¹³å‡ä½“é‡', unit: 'kg', reverseRank: false, weight: 1 },
        { key: 'age', label: 'å¹³å‡æ—¥é½¢', unit: 'æ—¥', reverseRank: true, weight: 2 }, // æ—¥é½¢ã¯å°ã•ã„æ–¹ãŒè‰¯ã„
        { key: 'unitPrice', label: '1kgå˜ä¾¡', unit: 'å††', reverseRank: false, weight: 3 }
    ];

    function calculateRanksAndScores(gender) {
        let data = parsedDataByGender[gender];
        let numMarkets = data.length;
        
        if (numMarkets === 0) return;

        // å„æŒ‡æ¨™ã§é †ä½ã‚’è¨ˆç®—
        metricsMap.forEach(m => {
            let key = m.key;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã€æœ‰åŠ¹ãªå€¤ã‚’æŒã¤è¡Œã®ã¿ã§ã‚½ãƒ¼ãƒˆ
            let tempArray = data.map((d, index) => ({ value: d[key], originalIndex: index }))
                              .filter(d => d.value !== undefined && d.value !== null && d.value !== 0);
            
            // é †ä½ä»˜ã‘ã‚½ãƒ¼ãƒˆ: reverseRankãŒtrueãªã‚‰æ˜‡é †(å°ã•ã„æ–¹ãŒä¸Šä½)ã€falseãªã‚‰é™é †(å¤§ãã„æ–¹ãŒä¸Šä½)
            tempArray.sort((a, b) => {
                let comparison = b.value - a.value;
                if (m.reverseRank) {
                    comparison = a.value - b.value;
                }
                return comparison;
            });
            
            // é †ä½ã‚’ä»˜ä¸ (ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯å¯¾å¿œ)
            tempArray.forEach((item, index) => {
                let rank = index + 1;
                if (index > 0 && tempArray[index - 1].value === item.value) {
                    item.rank = tempArray[index - 1].rank;
                } else {
                    item.rank = rank;
                }
                // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«è¡Œã”ã¨ã«é †ä½ã‚’é©ç”¨
                data[item.originalIndex][`${key}Rank`] = item.rank;
            });
        });

        // ç·åˆé †ä½ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
        let totalRankSumArray = []; // å„å¸‚å ´ã®ç·é †ä½å’Œã‚’æ ¼ç´
        
        data.forEach(row => {
            row.totalRankSum = 0;
            let metricCount = 0;
            
            metricsMap.forEach(m => {
                const rank = row[`${m.key}Rank`];
                if (rank !== null) {
                    // é †ä½ã«é‡ã¿ã‚’ã¤ã‘ã¦åŠ ç®—
                    row.totalRankSum += rank * m.weight;
                    metricCount += m.weight;
                }
            });

            // ç·é †ä½å’Œã®æ­£è¦åŒ–ï¼ˆé‡ã¿ã®åˆè¨ˆã§å‰²ã‚‹ï¼‰
            row.totalRankSum = metricCount > 0 ? row.totalRankSum / metricCount : null;

            if (row.totalRankSum !== null) {
                totalRankSumArray.push(row.totalRankSum);
            }
        });

        // å¹³å‡ç·é †ä½ã‚’è¨ˆç®— (ç·åˆé †ä½ã‚¹ã‚³ã‚¢ã®åŸºæº–ç‚¹)
        const totalRankSumAvg = totalRankSumArray.length > 0 
            ? totalRankSumArray.reduce((a, b) => a + b, 0) / totalRankSumArray.length
            : 0;

        // ç·åˆé †ä½ã‚¹ã‚³ã‚¢ï¼ˆãƒ—ãƒ©ã‚¹/ãƒã‚¤ãƒŠã‚¹æ•´æ•°ï¼‰ã‚’ä»˜ä¸
        data.forEach(row => {
            row.totalRankScore = null;
            if (row.totalRankSum !== null) {
                // å¹³å‡ã¨ã®å·®ã‚’è¨ˆç®—
                const deviation = row.totalRankSum - totalRankSumAvg;

                // åå·®ã‚’çµ¶å¯¾å€¤ã§æ¨™æº–åŒ–ã—ã€ç¬¦å·ã‚’ä¿æŒã™ã‚‹
                // ç·é †ä½ã¯ã€Œä½ã„æ–¹ãŒè‰¯ã„ã€ãŸã‚ã€åå·®ãŒãƒã‚¤ãƒŠã‚¹ï¼ˆå¹³å‡ã‚ˆã‚Šé †ä½ãŒè‰¯ã„ï¼‰ãªã‚‰ãƒ—ãƒ©ã‚¹ã®æ•´æ•°
                
                if (Math.abs(deviation) < 0.1) {
                    row.totalRankScore = 0; // ã»ã¼å¹³å‡
                } else {
                    // (å¹³å‡ã¨ã®å·® / å…¨å¸‚å ´æ•°) ã‚’ä½¿ã£ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚’æ±ºå®š
                    const scaleFactor = numMarkets / 2; // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
                    let score = Math.round(Math.abs(deviation) * scaleFactor);

                    // ç·é †ä½ãŒå¹³å‡ã‚ˆã‚Šä½ã„ï¼ˆdeviation < 0ï¼‰å ´åˆã¯ãƒ—ãƒ©ã‚¹
                    if (deviation < 0) {
                        row.totalRankScore = Math.max(1, score); 
                    } else {
                        row.totalRankScore = Math.min(-1, -score); 
                    }
                }
            }
        });
        
        // ç·åˆé †ä½ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
        data.sort((a, b) => {
            const scoreA = a.totalRankScore || -Infinity;
            const scoreB = b.totalRankScore || -Infinity;
            return scoreB - scoreA; // é™é †ï¼ˆãƒ—ãƒ©ã‚¹ãŒå¤§ãã„æ–¹ãŒä¸Šï¼‰
        });
    }


    function processData() {
        const text = document.getElementById('dataInput').value;
        const targetMonthStr = document.getElementById('targetMonth').value.trim();
        const linkUrl = document.getElementById('linkInput').value.trim();
        const errorDiv = document.getElementById('errorMessage');
        const resultDiv = document.getElementById('resultArea');
        const linkButton = document.getElementById('sourceLinkButton');

        linkButton.href = linkUrl || "#";
        linkButton.style.display = linkUrl ? 'block' : 'none';
        
        errorDiv.textContent = "";
        resultDiv.innerHTML = "";
        parsedDataByGender = { 'é›„': [], 'é›Œ': [], 'è¨ˆ': [] }; 

        if (!text) {
            errorDiv.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚";
            return;
        }

        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        
        // --- 1. æœˆã®åˆ—ç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        let monthIndex = -1;
        let headerLine = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const parts = line.split(/[\s\t]+/).map(p => p.trim());
            if (parts.length > 5 && parts[0] === 'éƒ½é“åºœçœŒ' && parts[1] === 'å¸‚å ´å' && (parts[2].includes('æœˆ') || parts[2].match(/^\d+æœˆ/))) {
                headerLine = line;
                break;
            }
        }

        if (headerLine) {
            const parts = headerLine.split(/[\s\t]+/).map(p => p.trim());
            const monthPart = parts.slice(2); 
            const targetIndex = monthPart.findIndex(m => m.includes(targetMonthStr));
            if (targetIndex !== -1) {
                monthIndex = targetIndex; 
            }
        }

        if (monthIndex === -1) {
            errorDiv.textContent = "æŠ½å‡ºå¯¾è±¡æœˆï¼ˆ" + targetMonthStr + "ï¼‰ãŒãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¡¨è¨˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            return;
        }


        // --- 2. ãƒ‡ãƒ¼ã‚¿æŠ½å‡º ---
        const keywords = {
            "å–å¼•é ­æ•°": "count", 
            "å¹³å‡ä¾¡æ ¼": "price", 
            "å¹³å‡ä½“é‡": "weight", 
            "å¹³å‡æ—¥é½¢": "age", 
            "ï¼‘ãå˜ä¾¡": "unitPrice", "kgå˜ä¾¡": "unitPrice", "ï½‹ï½‡å˜ä¾¡": "unitPrice"
        };

        let currentMarketName = null;
        let marketMap = {}; 

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            let cleanLine = line.replace(/,/g, '').replace(/[\s\t]+/g, ' ');
            
            const parts = cleanLine.split(' ').map(p => p.trim()).filter(p => p.length > 0);
            
            const isMarketHeader = (
                i > 0 && 
                (parts[0].includes("é“") || parts[0].includes("çœŒ") || parts[0].includes("åºœ") || parts[0].includes("éƒ½")) &&
                (parts.join(' ').includes("å¸‚å ´") || parts.join(' ').includes("é›†æ•£")) &&
                !line.includes("é ­") && !line.includes("ä¾¡æ ¼") && !line.includes("ä½“é‡")
            );

            if (isMarketHeader) {
                let name = parts.slice(1).join(' ');
                name = name.replace(/ï¼Š|\*/g, "").trim();
                if (name.includes("å“ç¨®") || name.includes("é»’æ¯›å’Œç¨®")) continue;
                
                currentMarketName = name;
                if (!marketMap[currentMarketName]) {
                    marketMap[currentMarketName] = { 'é›„': {}, 'é›Œ': {}, 'è¨ˆ': {} };
                }
                continue;
            }

            if (!currentMarketName) continue;

            let detectedMetric = null;
            for (const [key, value] of Object.entries(keywords)) {
                if (line.includes(key)) {
                    detectedMetric = value;
                    break;
                }
            }
            
            if (detectedMetric) {
                if (lines[i+1] && (lines[i+1].includes('é ­') || lines[i+1].includes('å††') || lines[i+1].includes('Kg') || lines[i+1].includes('æ—¥'))) {
                    i++; 
                }

                if (lines[i+1]) { processGenderLine(lines[i+1], 'é›Œ', detectedMetric, marketMap[currentMarketName], monthIndex); }
                if (lines[i+2]) { processGenderLine(lines[i+2], 'é›„', detectedMetric, marketMap[currentMarketName], monthIndex); }
                if (lines[i+3]) { processGenderLine(lines[i+3], 'è¨ˆ', detectedMetric, marketMap[currentMarketName], monthIndex); }
                
                i += 3; 
            }
        }

        function processGenderLine(line, genderKey, metricKey, marketData, monthIdx) {
            let cleanLine = line.replace(/,/g, '').replace(/[\s\t]+/g, ' ');
            
            let numbers = cleanLine.split(' ')
                .map(s => parseFloat(s))
                .filter(n => !isNaN(n));
            
            if (numbers.length > monthIdx) {
                 marketData[genderKey][metricKey] = numbers[monthIdx];
            }
        }


        // --- 3. ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›ï¼†å¹³å‡è¨ˆç®— ---
        let stats = {
            'é›„': { count:[], price:[], weight:[], age:[], unitPrice:[] },
            'é›Œ': { count:[], price:[], weight:[], age:[], unitPrice:[] },
            'è¨ˆ': { count:[], price:[], weight:[], age:[], unitPrice:[] }
        };

        Object.keys(marketMap).forEach(mName => {
            ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
                let dataObj = { name: mName };
                let hasData = false;
                metricsMap.forEach(m => {
                    const val = marketMap[mName][g][m.key];
                    dataObj[m.key] = val;
                    if (val !== undefined && val !== null && val !== 0) { 
                        stats[g][m.key].push(val);
                        hasData = true;
                    }
                });
                if (hasData) {
                    parsedDataByGender[g].push(dataObj);
                }
            });
        });

        if (parsedDataByGender['è¨ˆ'].length === 0 && parsedDataByGender['é›„'].length === 0) {
            errorDiv.textContent = "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¸‚å ´åã€é …ç›®åã€æœˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å†åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            return;
        }

        // å¹³å‡å€¤ã®ç®—å‡º
        averages = { 'é›„': {}, 'é›Œ': {}, 'è¨ˆ': {} };
        ['é›„', 'é›Œ', 'è¨ˆ'].forEach(g => {
            metricsMap.forEach(m => {
                const arr = stats[g][m.key];
                if (arr.length > 0) {
                    averages[g][m.key] = arr.reduce((a, b) => a + b, 0) / arr.length;
                } else {
                    averages[g][m.key] = 0;
                }
            });
        });

        // --- 4. é †ä½ã¨ã‚¹ã‚³ã‚¢ã®è¨ˆç®—ã‚’å®Ÿè¡Œ ---
        calculateRanksAndScores('é›„');
        calculateRanksAndScores('é›Œ');
        calculateRanksAndScores('è¨ˆ');

        // --- 5. ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ---
        renderTables();
    }

    // å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨è‰²ä»˜ã‘
    function formatValue(val, avg, rank) {
        if (val === undefined || val === null || val === 0) return `<div class="value-display">-</div><div class="rank-display rank-normal">(-)</div>`;
        
        const numVal = parseFloat(val);
        const formatted = numVal.toLocaleString(undefined, { maximumFractionDigits: 0 });
        
        let colorClass = "";
        if (Math.abs(numVal - avg) < 0.1) colorClass = "val-avg";
        else if (numVal > avg) colorClass = "val-high"; 
        else colorClass = "val-low"; 

        let rankDisplay = "";
        if (rank !== null && rank !== undefined) {
            let rankClass = rank === 1 ? 'rank-1' : (rank <= 5 ? 'rank-high' : 'rank-normal');
            rankDisplay = `<div class="rank-display ${rankClass}">(${rank}ä½)</div>`;
        } else {
            rankDisplay = `<div class="rank-display rank-normal">(-)</div>`;
        }

        return `<div><span class="value-display ${colorClass}">${formatted}</span>${rankDisplay}</div>`;
    }

    // ã‚¹ã‚³ã‚¢ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ãƒ—ãƒ©ã‚¹/ãƒã‚¤ãƒŠã‚¹ã®æ•´æ•°)
    function formatScore(score) {
        if (score === undefined || score === null) return `<td class="score-cell score-neutral">-</td>`;
        
        const num = parseInt(score, 10);
        let formatted = num > 0 ? `+${num}` : num.toString();
        
        let scoreClass = "";
        if (num > 0) scoreClass = "score-positive";
        else if (num < 0) scoreClass = "score-negative";
        else scoreClass = "score-neutral";
        
        return `<td class="score-cell ${scoreClass}">${formatted}</td>`;
    }


    // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ (ç·åˆé †ä½ã‚¹ã‚³ã‚¢ã«å¯¾å¿œ)
    function sortTable(gender, key) {
        if (sortState[gender].key === key) {
            sortState[gender].dir = sortState[gender].dir === 'asc' ? 'desc' : 'asc';
        } else {
            sortState[gender].key = key;
            sortState[gender].dir = 'desc'; 
        }

        const dir = sortState[gender].dir;
        
        parsedDataByGender[gender].sort((a, b) => {
            let valA, valB;
            
            if (key === 'name') {
                valA = a.name;
                valB = b.name;
                return dir === 'asc' ? valA.localeCompare(valB, 'ja') : valB.localeCompare(valA, 'ja');
            }
            
            if (key === 'totalRankScore') {
                valA = a.totalRankScore || -Infinity;
                valB = b.totalRankScore || -Infinity;
            } else {
                valA = a[key];
                valB = b[key];
            }

            const metric = metricsMap.find(m => m.key === key);
            const isReverse = metric && metric.reverseRank;
            
            // ãƒ‡ãƒ¼ã‚¿ãªã—/ã‚¼ãƒ­ã¯æœ€ä¸‹ä½ã¸
            const defaultVal = (dir === 'asc') ? Infinity : -Infinity;

            if (key !== 'totalRankScore') {
                if (valA === undefined || valA === 0 || valA === null) valA = defaultVal;
                if (valB === undefined || valB === 0 || valB === null) valB = defaultVal;
            }
            
            let comparison = dir === 'asc' ? valA - valB : valB - valA;
            
            // é …ç›®åˆ¥ã‚½ãƒ¼ãƒˆã®å ´åˆã€é †ä½ãƒ­ã‚¸ãƒƒã‚¯ã«å¾“ã†
            if (key !== 'totalRankScore' && !isReverse) {
                 // é€šå¸¸ï¼ˆä¾¡æ ¼ãªã©ï¼‰ï¼šå¤§ãã„æ–¹ãŒä¸Š (desc)
                 comparison = dir === 'asc' ? valA - valB : valB - valA;
            } else if (key !== 'totalRankScore' && isReverse) {
                // æ—¥é½¢ï¼šå°ã•ã„æ–¹ãŒä¸Š (asc)
                comparison = dir === 'asc' ? valA - valB : valB - valA; 
            }
            
            return comparison;
        });

        renderTables();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTables() {
        const container = document.getElementById('resultArea');
        container.innerHTML = "";

        ['é›„', 'é›Œ', 'è¨ˆ'].forEach(gender => {
            const cleanData = parsedDataByGender[gender].filter(row => 
                metricsMap.some(m => row[m.key] !== undefined && row[m.key] !== null && row[m.key] !== 0)
            );
            
            if (cleanData.length === 0) return;

            const section = document.createElement('div');
            section.className = 'gender-section';
            
            let html = `<h2>ã€${gender}ã€‘ ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('${gender}', 'name')">å¸‚å ´å</th>
                        <th class="${sortState[gender].key === 'totalRankScore' ? (sortState[gender].dir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" 
                            onclick="sortTable('${gender}', 'totalRankScore')">
                            ç·åˆé †ä½ã‚¹ã‚³ã‚¢
                            <br>(+å„ªè‰¯, 0å¹³å‡, -æ”¹å–„)
                        </th>`;
            
            metricsMap.forEach(m => {
                let sortClass = '';
                if (sortState[gender].key === m.key) {
                    sortClass = sortState[gender].dir === 'asc' ? 'sort-asc' : 'sort-desc';
                }
                html += `<th class="${sortClass}" onclick="sortTable('${gender}', '${m.key}')">${m.label}</th>`;
            });

            html += `</tr></thead><tbody>`;

            cleanData.forEach(row => {
                html += `<tr>
                            <td class="market-name-col">${row.name}</td>
                            ${formatScore(row.totalRankScore)}`;
                metricsMap.forEach(m => {
                    const val = row[m.key];
                    const rank = row[`${m.key}Rank`];
                    html += `<td>${formatValue(val, averages[gender][m.key], rank)}</td>`;
                });
                html += `</tr>`;
            });

            // å¹³å‡è¡Œ
            html += `<tr>
                        <td class="market-name-col val-avg">å¹³å‡</td>
                        <td class="score-cell score-neutral">0</td>`;
            metricsMap.forEach(m => {
                const avgVal = averages[gender][m.key];
                html += `<td class="val-avg">${avgVal === 0 ? '-' : avgVal.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>`;
            });
            html += `</tr>`;


            html += `</tbody></table>`;
            section.innerHTML = html;
            container.appendChild(section);
        });
    }
    
    window.onload = function() {
        // åˆæœŸå…¥åŠ›ä¾‹ã®è‡ªå‹•è¨­å®š
        document.getElementById('dataInput').value = `
        ã€Šæœˆåˆ¥è‚‰ç”¨å­ç‰›å–å¼•çŠ¶æ³è¡¨ï¼ˆå¸‚å ´åŒºåˆ†ï¼šå…¨å¸‚å ´ï¼‰ã€‹												
        å–å¼•æœˆã€€ä»¤å’Œ07å¹´01æœˆ01æ—¥ï½ä»¤å’Œ07å¹´12æœˆ31æ—¥ï¼Œæ—¥é½¢ã€€182ï½365												ãƒšãƒ¼ã‚¸ï¼š	1
        å“ç¨®ï¼š	é»’æ¯›å’Œç¨®	ï¼Šï¼šæŒ‡å®šå¸‚å ´ã€€ï¼ï¼šéæŒ‡å®šå¸‚å ´													
        éƒ½é“åºœçœŒ	å¸‚å ´å	12æœˆ	1æœˆ	2æœˆ	3æœˆ	4æœˆ	5æœˆ	6æœˆ	7æœˆ	8æœˆ	9æœˆ	10æœˆ	11æœˆ	12æœˆ	åˆè¨ˆãƒ»å¹³å‡
        åŒ—æµ·é“	ãƒ›ã‚¯ãƒ¬ãƒ³å—åŒ—æµ·é“å®¶ç•œå¸‚å ´*														
            å–å¼•é ­æ•°ã€€ã€€ã€€ã€€ã€€é›Œ	785	563	676	625	688	718	690	681	597	604	585	601	0	7,028
            ï¼ˆé ­ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	944	805	902	789	940	1,060	929	812	794	881	842	865	0	9,619
            è¨ˆ	1,729	1,368	1,578	1,414	1,628	1,778	1,619	1,493	1,391	1,485	1,427	1,466	0	16,647
            å¹³å‡ä¾¡æ ¼ã€€ã€€ã€€ã€€ã€€é›Œ	476,069	525,605	547,652	580,108	677,015	629,563	595,819	646,333	664,295	609,425	633,152	674,834	0	617,306
            ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	600,128	656,085	683,328	722,827	805,909	745,047	747,471	777,784	778,781	751,776	753,167	793,066	0	747,367
            å¹³å‡	543,803	602,386	625,206	659,744	751,438	698,412	682,838	717,826	729,645	693,877	703,967	744,596	0	692,458
            å¹³å‡ä½“é‡ã€€ã€€ã€€ã€€ã€€é›Œ	312	316	314	311	317	317	318	314	311	314	314	320	0	315
            ï¼ˆKgï¼‰ã€€ã€€ã€€ã€€ã€€é›„	331	336	335	334	342	341	342	340	334	340	339	345	0	339
            å¹³å‡	322	328	326	324	331	332	331	328	324	330	329	335	0	329
            å¹³å‡æ—¥é½¢ã€€ã€€ã€€ã€€ã€€é›Œ	301	308	308	306	309	307	304	305	302	306	303	309	0	306
            ï¼ˆæ—¥ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	290	296	297	296	298	296	295	292	291	295	293	297	0	295
            å¹³å‡	295	301	302	301	303	300	299	298	295	299	297	302	0	300
            ï¼‘ãå˜ä¾¡ã€€ã€€ã€€ã€€ã€€é›Œ	1,526	1,661	1,747	1,864	2,139	1,983	1,876	2,059	2,137	1,939	2,014	2,110	0	1,959
            ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	1,813	1,953	2,038	2,165	2,355	2,183	2,189	2,285	2,331	2,211	2,220	2,298	0	2,203
            å¹³å‡	1,687	1,837	1,918	2,037	2,268	2,106	2,061	2,186	2,251	2,105	2,139	2,224	0	2,105
            å¸‚å ´æ•°	0	0	0	0	0	0	0	0	0	0	0	0	0	0
        åŒ—æµ·é“	ãƒ›ã‚¯ãƒ¬ãƒ³åå‹åœ°åŒºå®¶ç•œå¸‚å ´*														
            å–å¼•é ­æ•°ã€€ã€€ã€€ã€€ã€€é›Œ	1,141	906	846	896	891	965	865	1,533	210	1,151	612	938	1,008	10,821
            ï¼ˆé ­ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	1,441	1,182	1,052	1,255	1,323	1,375	1,263	2,069	326	1,699	976	1,290	1,360	15,170
            è¨ˆ	2,582	2,088	1,898	2,151	2,214	2,340	2,128	3,602	536	2,850	1,588	2,228	2,368	25,991
            å¹³å‡ä¾¡æ ¼ã€€ã€€ã€€ã€€ã€€é›Œ	477,956	521,954	543,656	577,121	673,423	663,126	636,985	675,729	673,284	636,583	631,679	680,296	715,321	637,334
            ï¼ˆå††ï¼‰ã€€ã€€ã€€ã€€ã€€é›„	616,590	647,460	675,278	702,378	799,050	782,590	770,885	791,081	774,505	754,294	759,162	787,268	820,353	758,536
            å¹³å‡	555,327	593,002	616,610	650,202	748,493	733,323	716,457	741,987	734,847	706,755	710,031	742,232	775,644	708,075
        `;
        document.getElementById('targetMonth').value = "8æœˆ";
        document.getElementById('linkInput').value = "https://www.maff.go.jp/j/chikusan/kikaku/lin/l_siryo/attach/pdf/nikuyousigyu-51.pdf";
    };
</script>

</body>
</html>